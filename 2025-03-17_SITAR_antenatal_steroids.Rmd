
```{r, clean the environment}
rm(list = ls())
```

```{r, define colours for plotting here}
boys_all_preterm_colour <- "lightblue"
boys_term_colour <- "black"
boys_steroids_colour <- "blue"
boys_no_steroids_colour <- "darkblue"

girls_all_preterm_colour <- "pink"
girls_term_colour <- "grey3"
girls_steroids_colour <- "red"
girls_no_steroids_colour <- "darkred"
```

```{r, load libraries}
#setwd("J:/External_cpu/Tidy Perinatal Steroids/2024-09-10_Krish_work")
#setwd("G:/Other computers/My computer/External_cpu/Tidy Perinatal Steroids/2024-09-10_Krish_work")
library(tidyverse)
library(lubridate)
library(sitar)
library(stringr)
library(descr)
library(tidyr)
library(dplyr)
library(janitor)
library(splines)
library(gganimate)  # for creating GIFs
library(gifski) # for saving GIFs
library(dplyr)
library(purrr)
library(ggplot2)
#install.packages("performance")
library(performance)
library(flextable)
library(officer)
library(tibble)
library(visdat)
library(missForest)
library(mice)
library(VIM)
library(broom)  # For tidying model outputs
library(gridExtra)
```

```{r, functions to calculate rmse and pseudo r2}
calculate_rmse <- 
  function(model, data) {
    predictions <- predict(model, newdata = data, type = "response")
    actuals <- data$height_
    sqrt(mean((predictions - actuals)^2))
  }

    # Function to calculate Pseudo R²
calculate_pseudo_r2 <- 
  function(full_model, data) {
    null_model <- 
      sitar(x = transformed_age, 
            y = height_, 
            id = nw_id, 
            data = data, 
            df = 0)
  
    # Extract log-likelihoods
    log_likelihood_full <- logLik(full_model)
    log_likelihood_null <- logLik(null_model)
  
    pseudo_r2 <- 
      1 - (as.numeric(-2 * log_likelihood_full) / as.numeric(-2 * log_likelihood_null))
  
    return(pseudo_r2)
}
```

```{r, create a function that plots a model to a tidy word document}
model_to_word <- function(model, path) {
  # Load required libraries

  
  # Extract the model summary
  model_summary <- summary(model)
  
  model_name <- deparse(substitute(model))
  
  # Extract coefficients
  model_coefficients <- 
    rownames_to_column(as.data.frame(round(model_summary$coefficients, digits = 2)), var = "Coefficient")
  
  # Add stars to the p-value column
  model_coefficients$`Pr(>|t|)` <- sapply(
    model_coefficients$`Pr(>|t|)`,
    function(p) {
      stars <- if (p < 0.001) {
        "***"
      } else if (p < 0.01) {
        "**"
      } else if (p < 0.05) {
        "*"
      } else {
        ""
      }
      paste0(sprintf("%.3f", p), stars)
    }
  )
  # Remove the 't value' column as it is superfluous
  model_coefficients$`t value` <- NULL
  
  # Extract the outcome variable name
  outcome_variable <- as.character(model$call$formula[[2]])
  
  # Extract the name of the data frame used
  data_frame_name <- as.character(model$call$data)
  
  # Extract the number of observations
  number_in_model <- length(predict(model))
  
  #extract the R2 of the model
  r2_model <- round(model_summary$r.squared, digits=3)
  
  # Create a flextable from the coefficients
  ft <- flextable(model_coefficients)
  
  # Customize the table appearance
  ft <- ft %>%
    set_header_labels(
      P = "Pr(>|t|)"
    ) %>%
    theme_vanilla() %>%
    align(align = "center", part = "header") %>%
    align(align = "center", part = "body") %>%  
    autofit()
  
  # Define paragraph formatting with centered alignment
  centered_paragraph <- fp_par(text.align = "center")
  
  # Define font properties (e.g., larger font size)
  font_properties <- fp_text(font.size = 14, bold = TRUE, color = "black")
  
  # Save the table and metadata to a Word document
  doc <- read_docx() %>%
    body_add_fpar(
      fpar(
        ftext(paste0("Outcome variable: ", outcome_variable), 
              prop = font_properties),
        fp_p = centered_paragraph
      )
    ) %>%
    body_add_par("", style = "Normal") %>% # Add an empty line for spacing
    body_add_flextable(ft) %>%
    body_add_fpar(
      fpar(
        ftext(paste0("Number of observations: ", number_in_model), 
              prop = font_properties),
        fp_p = centered_paragraph
      )
    ) %>%
    body_add_fpar(
      fpar(
        ftext(paste0("R² of model: ", r2_model), 
              prop = font_properties),
        fp_p = centered_paragraph
      )
    ) %>%
    body_add_par("", style = "Normal") %>% # Add an empty line for spacing
    body_add_fpar(
      fpar(
        ftext(paste0("Data frame name: ", data_frame_name), 
              prop = font_properties),
        fp_p = centered_paragraph
      )
    ) 
  
  # Save the Word document
  print(doc, target = file.path(path, paste0(model_name, ".docx")))
}

#delete this practice model as it won't exist when you start the file from the top:
```

```{r, load data}
#data <- read_csv("Tidy_perinatal_steroid_files_to_share/NW_file_41.csv")
data <- 
  read_csv("NW_file_41.csv")

# Function to standardize column names
standardise_colnames <- function(colnames) {
  colnames <- 
    str_replace_all(colnames, c(
    "\\b(?i)date\\b" = "Date",
    "\\b(?i)wt\\b|\\b(?i)weight\\b|\\b(?i)Wt\\d+\\w*\\b" = "Weight",
    "\\b(?i)l\\b|\\b(?i)length\\b|\\b(?i)height\\b|\\b(?i)ht\\d*\\b|\\b(?i)st\\.ht\\b|\\b(?i)L\\d+\\w*\\b|\\bX\\d+yrLength\\b" = "Height",
    "\\b(?i)ofc\\d*\\w*\\b|\\b(?i)head\\.circumference\\b|\\bX\\d+yr_Head\\.circumference\\b|\\bX\\d+yr\\.Head\\.circum\\b" = "HeadCircumference",
    "\\b(?i)br\\b|\\b(?i)breast\\b|\\b(?i)brst\\b|\\b(?i)Brst\\d+\\w*\\b" = "Breast",
    "\\b(?i)pen\\b|\\b(?i)penis\\b|\\b(?i)Pen\\d+\\w*\\b" = "Penis",
    "\\b(?i)ph\\b|\\b(?i)pubhair\\b|\\b(?i)pub\\.hair\\b|\\b(?i)Pub\\.H\\d+\\w*\\b|\\b(?i)PubH\\d+\\w*\\b|\\b(?i)Pub\\.H\\d*\\.\\d*\\b" = "PubH",
    "\\b(?i)men\\b|\\b(?i)menarche\\b|\\b(?i)Men\\d+\\w*\\b|\\b(?i)menarche\\d*\\b" = "Menarche"
  ))
  return(colnames)
}

colnames(data) <- 
  standardise_colnames(colnames(data))
```

```{r, function to convert dates}
fill_dates <- 
  function(df, 
           mapping, 
           dob_col = "dob_x") {
    
  if (!dob_col %in% colnames(df)) {
    stop(paste0("The column", dob_col, "does not exist in the dataframe."))
  }
  
  df[[dob_col]] <- dmy(df[[dob_col]])
  
  if (sum(is.na(df[[dob_col]])) > 0) {
    stop("The 'dob' column contains NA values. Please handle these before proceeding.")
  }
  
  for (i in 1:nrow(mapping)) {
    date_col <- mapping$column_name[i]
    age_days <- as.integer(mapping$age_days[i])
    
    # Calculate the assumed date
    assumed_date <- df[[dob_col]] + days(age_days)
    
    print(paste0("Filling column:", date_col))
    print(paste0("Assumed date sample:", head(assumed_date)))
    
    # Fill in missing dates and format them
    df[[date_col]] <- ifelse(
      is.na(df[[date_col]]),
      format(assumed_date, "%d/%m/%Y"),
      format(dmy(df[[date_col]]), "%d/%m/%Y")
    )
  }
  
  return(df)
}

convert_to_date <- 
  function(date_str) {
  dmy(date_str)
}
```

```{r, standardise column names}
# Clean column names
data <- data %>%
  clean_names() %>%
  select(-starts_with("st_ht")) %>%
  rename_with(~str_replace(., "x(\\d+)_yr_(\\w+)", "\\2_\\1_")) %>%
  rename_with(~str_replace(., "x(\\d+)yr_(\\w+)", "\\2_\\1_")) %>%
  rename_with(~str_replace(., "x(\\d+)yr(\\w+)", "\\2_\\1_")) %>%
  rename_with(~ str_replace(., "^pub_h", "pubh"), starts_with("pub_h"))

data <- data %>%
  dplyr::rename(
    date_1 = date1,
    date_2 = date2,
    date_3 = date3,
    date_4 = date4,
    date_6 = date6,
    date_7 = date7,
    date_8 = date8w,
    date_9 = date8m,
    date_10 = date12m,
    date_11 = date20m,
    date_12 = date24m,
    date_13 = date32,
    date_14 = date36,
    date_15 = date44,
    date_16 = date48,
    date_17 = date56,
    date_18 = date60,
    date_19 = date_6_,
    date_20 = date,
    date_21 = date_8_,
    date_22 = date_10_,
    date_23 = date_11_,
    date_24 = date_12_,
    date_25 = date_13_,
    date_26 = date_visit_14_,
    date_27 = date_15_,
    date_28 = date_16_,
    date_29 = date_17_,
    date_30 = date_18_,
    height_30 = height_2_2,
    height_29 = height_1,
    height_28 = height_24,
    height_27 = height15,
    height_26 = height_14yr,
    height_25 = height_23,
    height_23 = height_21,
    height_24 = height_22,
    height_22 = height_20,
    height_21 = height_8_,
    height_20 = height_7_,
    weight_30 = weight_2_2,
    weight_29 = weight_1,
    weight_28 = weight_24,
    weight_27 = weight_15_2,
    weight_26 = weight_14yr,
    weight_25 = weight_23,
    weight_24 = weight_22,
    weight_23 = weight_21,
    weight_22 = weight_20,
    weight_21 = weight_8_,
    weight_20 = weight_19,
    weight_19 = weight_6_,
    weight_1 = weight,
    height_1 = height,
    head_circumference_1 = head_circumference,
  )

columns_to_delete <- 
  c("weight_7_", 
    "s_height_14yr", 
    "height_15_2", 
    "st_height", 
    "st_height_1", 
    "st_height_2")

data <- data %>%
  select(-all_of(columns_to_delete))

weight_columns_to_modify <- 
  paste0("weight_", 19:30)

for (column in weight_columns_to_modify){
  print(column)
  data[[column]] <- as.numeric(as.character(data[[column]]))
  data[[column]] <- 1000 * data[[column]]
}
```

```{r, read in steroid treatment data}
#steroids1 <- read_csv("Tidy_perinatal_steroid_files_to_share/NW_file_27.csv")
steroids1 <- 
  read_csv("NW_file_27.csv")

steroids1 <- 
  steroids1 %>%
  select(NW_ID, 'Antenatal steroids') %>%
  dplyr::rename(STEROIDS = 'Antenatal steroids')

steroids1 <- 
  steroids1 %>%
  mutate(STEROIDS = ifelse(STEROIDS == 1, "yes", "no"))

#steroids2 <- read_csv("Tidy_perinatal_steroid_files_to_share/NW_file_22.csv")
steroids2 <- 
  read_csv("NW_file_22.csv")
steroids2 <- 
  steroids2 %>%
  select(NW_ID, 'Antenatal steroids') %>%
  dplyr::rename(STEROIDS = 'Antenatal steroids')


#steroids2 <- steroids2 %>%
#  rename(STEROIDS = `Antenatal steroids`, nw_id = "NW_ID")

#steroids34 <-read_csv("Tidy_perinatal_steroid_files_to_share/NW_file_34.csv")
steroids34 <-read_csv("NW_file_34.csv")
steroids34 <- steroids34 %>%
  select(NW_ID, 'Antenatal steroids') %>%
  dplyr::rename(STEROIDS = 'Antenatal steroids')


merged_steroids <- 
  full_join(steroids1, 
            steroids2, 
            by = "NW_ID")

unique_ids_steroids1_34 <- setdiff(steroids34$NW_ID, merged_steroids$nw_id)
unique_ids_steroids34_1 <- setdiff(merged_steroids$nw_id, steroids34$NW_ID)

steroids36 <-read_csv("NW_file_36.csv")
#steroids36 <-read_csv("Tidy_perinatal_steroid_files_to_share/NW_file_36.csv")
steroids36 <- steroids36 %>%
  select(NW_ID, 'Antenatal steroids') %>%
  dplyr::rename(STEROIDS = 'Antenatal steroids')

unique_ids_steroids1_36 <- setdiff(steroids36$NW_ID, merged_steroids$nw_id)
unique_ids_steroids36_1 <- setdiff(merged_steroids$nw_id, steroids36$NW_ID)

#steroids38 <-read_csv("Tidy_perinatal_steroid_files_to_share/NW_file_38.csv")
steroids38 <-read_csv("NW_file_38.csv")
steroids38 <- steroids38 %>%
  select(NW_ID, 'Antenatal steroid') %>%
  dplyr::rename(STEROIDS = 'Antenatal steroid')

unique_ids_steroids1_38 <- setdiff(steroids38$NW_ID, merged_steroids$nw_id)
unique_ids_steroids38_1 <- setdiff(merged_steroids$nw_id, steroids38$NW_ID)


merged_steroids <- merged_steroids %>%
  mutate(STEROIDS = coalesce(STEROIDS.x, STEROIDS.y)) %>%
  select(-STEROIDS.x, -STEROIDS.y)
  
merged_steroids <- merged_steroids %>%
  dplyr::rename(nw_id = NW_ID)


merged_data <- left_join(data, merged_steroids, by="nw_id")
```

```{r, insert standardised measurement dates when date not entered}
date_mapping <- 
  data.frame(
  column_name = 
    grep("date", colnames(data), value=T),
  age_days = c(
    as.integer(
      mean(data$day1, na.rm = T)), 
    as.integer(
      mean(data$day2, na.rm = T)), 
    as.integer(
      mean(data$day3, na.rm = T)), 
    as.integer(
      mean(data$day4, na.rm = T)), 
    as.integer(
      mean(data$day5, na.rm = T)), 
    as.integer(
      mean(data$day6, na.rm = T)), 
    as.integer(
      mean(data$day7, na.rm = T)), 
    56, 240, 365, 600, 730, 960, 1095, 1320, 1461, 1681, 1826, 2191, 2556, 2920, 3652, 4017, 4383, 4748, 5113, 5478, 5841, 6206, 6571)
)
```

```{r, fill missing dates with the mean values of date measurements}
# Create a copy of the original data and fill missing dates
updated_df <- 
  fill_dates(merged_data, date_mapping)
```

```{r, clean the updated data frame by assessing non numeric values}
# Apply the function to relevant columns and report non-numeric entries
df_clean <- updated_df %>%
  mutate(across(
    contains("weight") | 
      contains("height") | 
      contains("head_circumference"),
    ~ {
      non_numeric <- sum(is.na(as.numeric(as.character(.))))
      if (non_numeric > 0) {
        message("Found ", non_numeric, " non-numeric entries in column ", cur_column(), " converting to NA.")
      }
      as.numeric(as.character(.))
    }
  ))
```

```{r, view what Krishs function has done}
view_updates_to_weight_2 <-
  data.frame(
    updated_df=updated_df$weight_2,
    df_clean=df_clean$weight_2
  )

view_updates_to_weight_10 <-
  data.frame(
    updated_df=updated_df$weight_10,
    df_clean=df_clean$weight_10
  )
```

```{r, pivot the data long}
date_columns <- grep("^date", names(df_clean), value = T)
df_clean[date_columns] <- lapply(df_clean[date_columns], as.Date, format = "%d/%m/%Y")


# Pivot the data
long_df <- df_clean %>%
  pivot_longer(
    cols = starts_with("date") |  starts_with("weight") |
      starts_with("height") | starts_with("head_circumference"),
    names_to = c(".value", "time"),
    names_pattern = "(^\\D+)(\\d+)"
  )

print(sum(is.na(long_df$date)))

# Convert to Date type and calculate age
long_df <- long_df %>%
  mutate(
    dob = as.Date(dob_x, format = "%d/%m/%Y"),
    date_of_measurement = as.Date(date_, format = "%d/%m/%Y"),
    age = as.numeric(difftime(date_of_measurement, dob_x, units = "days"))
  )


# Filter out rows where all key columns are NA
long_df <- long_df %>%
  filter(
    !is.na(date_of_measurement) |
      !is.na(weight_) |
      !is.na(height_) |
      !is.na(head_circumference_)
  )

# Select and arrange columns
final_df <- long_df %>%
  select(nw_id, dob_x, ga, STEROIDS, edd, sex, mat_ht, pat_ht, mid_par_ht, race, 
         date_of_measurement, age, weight_, height_, head_circumference_)

final_df <- final_df %>%
  mutate(corrected_age = age - (280 - (ga * 7)),
         corrected_age_years = corrected_age / 365.25,
#create ln transformed corrected_age as per tim's advice
         transformed_age = log(corrected_age_years + 0.75))

descr(final_df$corrected_age_years)
descr(final_df$transformed_age)

head(final_df)

```

```{r, manually correct race in final_df}
final_df$race_original <-
  final_df$race


final_df$race <- ifelse(
  final_df$race=="cauc.greek" |
  final_df$race=="Asian/cauc." |
  final_df$race=="Asian mix Cauc" |
  final_df$race=="cauc & Jamaican" |
  final_df$race=="afro-carrib./ cauc." |
  final_df$race=="Cauc./ Black Caribb." |
  final_df$race=="cauc/greek" |
  final_df$race=="cauc /morrocan" |
  final_df$race=="cauc/afro-carrib." |
  final_df$race=="Afro-carrib/cauc" |
  final_df$race=="Afrocaribbean / Cauc" |
  final_df$race=="mix cauc/afro-carrib" |
  final_df$race=="cauc/afro-caribb." |
  final_df$race=="cauc/turkish" |
  final_df$race=="Japanese/cauc." |
  final_df$race=="Cauc\\Greek" |
  final_df$race=="Japanese /Canadian",
  "Mixed",
  final_df$race
)

final_df$race <- ifelse(
  final_df$race=="caucasian" |
  final_df$race=="cauc" |
  final_df$race=="cauc." |
  final_df$race=="caucasion" |
  final_df$race=="Cauc",
  "White",
  final_df$race
)

final_df$race <- ifelse(
  final_df$race=="Black Caribb." |
  final_df$race=="Nigeria" |
  final_df$race=="Somali" |
  final_df$race=="Caribbean" |
  final_df$race=="Afro-Carribean" |
  final_df$race=="afro-carribb." ,
  "Black",
  final_df$race
)

final_df$race <- ifelse(
  final_df$race=="Saudi Arabia" |
  final_df$race=="Yemeni" |
  final_df$race=="Yemen" |
  final_df$race=="Lybian" |
  final_df$race=="yemeni",
  "Arab",
  final_df$race
)

final_df$race <- ifelse(
  final_df$race=="Pakistan" |
  final_df$race=="Vietmenese \\ Chinese" ,
  "Asian",
  final_df$race
)
unique(final_df$race)  
```

```{r, manual corrections of outliers to final_df}
#there is a height measurement of zero for NW_ID_0052 on measurement date 1994-03-22
final_df$flag_for_removal <-
  ifelse(final_df$nw_id=="NW_ID_0052" & 
         final_df$date_of_measurement=="1994-03-22",
         1,
         0)

final_df_corrected <-
  subset(final_df, 
         flag_for_removal!=1)

cat("Number of rows removed:")
nrow(final_df) - nrow(final_df_corrected)

#create final_df over one
final_df_corrected_over_one <-
  subset(final_df_corrected, corrected_age_years>=1)
```

```{r, establish height velocity between measurements and join it in}
#create a row_name so we know we can rejoin after removing missing data
final_df_corrected$row_name <-
  paste0(final_df_corrected$nw_id, "_", rownames(final_df_corrected))

#ensure our final_df is appropriately ordered
final_df_subset <- 
  final_df_corrected[order(final_df_corrected$nw_id,
           final_df_corrected$corrected_age_years),] %>%
  filter(!is.na(corrected_age_years)) %>% #remove unknown corrected age
  filter(!is.na(height_)) #remove unknown height

#calculate the time to next measurement
final_df_subset$years_to_next_height_measurement <-
  lead(final_df_subset$corrected_age_years) - final_df_subset$corrected_age_years

#correct to NA if the next id is a different id
final_df_subset$years_to_next_height_measurement <- ifelse(
  final_df_subset$nw_id != lead(final_df_subset$nw_id),
  NA,
  final_df_subset$years_to_next_height_measurement
)

#calculate the increase in height to next measurement
final_df_subset$increase_in_height_to_next_measurement <-
  lead(final_df_subset$height_) - final_df_subset$height_

#correct to NA if the next id is a different id
final_df_subset$increase_in_height_to_next_measurement <- ifelse(
  final_df_subset$nw_id != lead(final_df_subset$nw_id),
  NA,
  final_df_subset$increase_in_height_to_next_measurement
)

# Create a new column with the sequence of height measurements for each patient
number_of_height_measurements <- final_df_subset %>%
  group_by(nw_id) %>%           # Group by the patient identifier
  mutate(n_height_measurements = row_number())  %>% # Create a sequence starting from 1 for each group
  slice_max(n_height_measurements, with_ties=F, n=1)

number_of_height_measurements <- number_of_height_measurements[,c(
    "nw_id",
    "n_height_measurements"
  )]

#add half the time between measurements to the first measurement to get corrected_age_at_height_velocity
final_df_subset$corrected_age_at_height_velocity <-
  final_df_subset$corrected_age_years + 1/2 * final_df_subset$years_to_next_height_measurement

#calculate the height velocity as the change in height to next measurement over the years_to_next_height_measurement
final_df_subset$height_velocity_between_measurements <-
  final_df_subset$increase_in_height_to_next_measurement / 
  final_df_subset$years_to_next_height_measurement

#calculate the final height velocity for each patient by taking the maximum
final_df_subset_last_height_velocity <-
  final_df_subset %>%
  group_by(nw_id) %>%
  slice_max(
    corrected_age, n = 2, with_ties = FALSE
  ) %>%
  slice(n()) # Selects the second-to-last row within the top two

final_df_height_velocity_to_join_back <-
  final_df_subset[,c(
    "row_name",
    "years_to_next_height_measurement",
    "increase_in_height_to_next_measurement",
    "corrected_age_at_height_velocity",
    "height_velocity_between_measurements"
  )]

#take out just the rows
final_df_last_height_velocity_to_join_back <-
  final_df_subset_last_height_velocity[,c(
    "nw_id",
    "height_",
    "corrected_age_at_height_velocity",
    "height_velocity_between_measurements"
  )]

#rename those columns to reflect that they are the final height velocities
final_df_last_height_velocity_to_join_back <- 
  final_df_last_height_velocity_to_join_back %>%
  rename(c(
    "final_height" = "height_",
    "age_at_final_height_velocity" = "corrected_age_at_height_velocity",
    "final_height_velocity" = "height_velocity_between_measurements")
  )

#first join in the final height velocities
final_df_corrected_with_final_height_velocity <-
  left_join(
    final_df_corrected,
    final_df_last_height_velocity_to_join_back,
    by = join_by(nw_id)
  )

final_df_corrected_with_height_velocity <-
  left_join(
    final_df_corrected_with_final_height_velocity,
    final_df_height_velocity_to_join_back,
    by = join_by(row_name)
  )

#join in the total number of height measurements
final_df_corrected_with_height_velocity_and_n <-
  left_join(final_df_corrected_with_height_velocity,
            number_of_height_measurements,
            by = join_by(nw_id))

#rationalise our frame name
final_df_corrected_with_height_velocity <-
  final_df_corrected_with_height_velocity_and_n
```

```{r, establish weight velocity between measurements and join it in}
#ensure our final_df is appropriately ordered
final_df_subset <- 
  final_df_corrected_with_height_velocity[order(final_df_corrected_with_height_velocity$nw_id,
           final_df_corrected_with_height_velocity$corrected_age_years),] %>%
  filter(!is.na(corrected_age_years)) %>% #remove unknown corrected age
  filter(!is.na(weight_)) #remove unknown weight

#calculate the time to next measurement
final_df_subset$years_to_next_weight_measurement <-
  lead(final_df_subset$corrected_age_years) - final_df_subset$corrected_age_years

#correct to NA if the next id is a different id
final_df_subset$years_to_next_weight_measurement <- ifelse(
  final_df_subset$nw_id != lead(final_df_subset$nw_id),
  NA,
  final_df_subset$years_to_next_weight_measurement
)

# Create a new column with the sequence of weight measurements for each patient
number_of_weight_measurements <- final_df_subset %>%
  group_by(nw_id) %>%           # Group by the patient identifier
  mutate(n_weight_measurements = row_number())  %>% # Create a sequence starting from 1 for each group
  slice_max(n_weight_measurements, with_ties=F, n=1)

number_of_weight_measurements <- number_of_weight_measurements[,c(
    "nw_id",
    "n_weight_measurements"
  )]

#calculate the increase in weight to next measurement
final_df_subset$increase_in_weight_to_next_measurement <-
  lead(final_df_subset$weight_) - final_df_subset$weight_

#correct to NA if the next id is a different id
final_df_subset$increase_in_weight_to_next_measurement <- ifelse(
  final_df_subset$nw_id != lead(final_df_subset$nw_id),
  NA,
  final_df_subset$increase_in_weight_to_next_measurement
)


#add half the time between measurements to the first measurement to get corrected_age_at_weight_velocity
final_df_subset$corrected_age_at_weight_velocity <-
  final_df_subset$corrected_age_years + 1/2 * final_df_subset$years_to_next_weight_measurement

#calculate the weight velocity as the change in weight to next measurement over the years_to_next_weight_measurement
final_df_subset$weight_velocity_between_measurements <-
  final_df_subset$increase_in_weight_to_next_measurement / 
  final_df_subset$years_to_next_weight_measurement

final_df_weight_velocity_to_join_back <-
  final_df_subset[,c(
    "row_name",
    "years_to_next_weight_measurement",
    "increase_in_weight_to_next_measurement",
    "corrected_age_at_weight_velocity",
    "weight_velocity_between_measurements"
  )]

final_df_corrected_with_velocities <-
  left_join(
    final_df_corrected_with_height_velocity,
    final_df_weight_velocity_to_join_back,
    by = join_by(row_name)
  )

#join in the total number of weight measurements
final_df_corrected_with_velocities_and_n <-
  left_join(final_df_corrected_with_velocities,
            number_of_weight_measurements,
            by = join_by(nw_id))


#rationalise our frame name
final_df_corrected_with_velocities <-
  final_df_corrected_with_velocities_and_n
```

```{r, total number of patients}
length(unique(final_df_corrected_with_velocities$nw_id))
```


```{r, sort data by gestational age and plot}
#this sorting was originally to plot the gganimate plot which we no longer bother with. I've just left the sorting in - really, there is no need to sort by gestational age
final_df_filtered <- 
  final_df_corrected_with_velocities %>% 
  filter(!is.na(corrected_age), 
         !is.na(height_), 
         !is.na(nw_id)) %>% 
  group_by(nw_id) %>% 
  filter(n() >= 3) %>%  # Keep only patients with 3 or more height measurements
  ungroup()

# Sort the data by gestational age (ga)
final_df_sorted <- 
  final_df_filtered %>% 
  arrange(ga)

#sort the grame
final_df_sorted <- 
  final_df_sorted %>%
  mutate(frame = as.numeric(
    factor(nw_id, 
           levels = unique(nw_id))))  # Give each patient a unique frame
```

```{r, subset the total data by steroid and separate controls}
# Split the data into 8 groups
boys_all <- 
  final_df_sorted %>% 
  filter(sex == "Male", 
         !is.na(height_), 
         !is.na(age))

boys_all_preterm <- 
  final_df_sorted %>% 
  filter(sex == "Male" & ga < 37, 
         !is.na(height_), 
         !is.na(age))

boys_preterm_steroids <- 
  final_df_sorted %>% 
  filter(sex == "Male" & ga < 37 & 
           STEROIDS == "yes", 
         !is.na(height_), 
         !is.na(age))

boys_preterm_no_steroids <- 
  final_df_sorted %>% 
  filter(sex == "Male" & 
           ga < 37 & 
           (STEROIDS == "no" | is.na(STEROIDS)), 
         !is.na(height_), !is.na(age))

boys_term <- 
  final_df_sorted %>% 
  filter(sex == "Male" & ga >= 37, 
         !is.na(height_), !is.na(age))

girls_all <- 
  final_df_sorted %>% 
  filter(sex == "Female", 
         !is.na(height_), 
         !is.na(age))

girls_all_preterm <- 
  final_df_sorted %>% 
  filter(sex == "Female" & 
           ga < 37 , 
         !is.na(height_), 
         !is.na(age))

girls_preterm_steroids <- 
  final_df_sorted %>% 
  filter(sex == "Female" & 
           ga < 37 & 
           STEROIDS == "yes", 
         !is.na(height_), 
         !is.na(age))

girls_preterm_no_steroids <- 
  final_df_sorted %>% 
  filter(sex == "Female" & 
           ga < 37 & (
             STEROIDS == "no" | 
               is.na(STEROIDS)), 
         !is.na(height_), 
         !is.na(age))

girls_term <- 
  final_df_sorted %>% 
  filter(sex == "Female" & 
           ga >= 37, 
         !is.na(height_), 
         !is.na(age))
```

```{r, report total number of height measurements}
summarytools::descr(boys_all$height_)
summarytools::descr(girls_all$height_)

```


```{r, report maximum age of measurement}
function_to_report_maximum_age_at_measurement <-
  function(data){
    result <-
    data %>%
      
      group_by(nw_id) %>%
      
      summarise(
        maximum_age = max(corrected_age_years, na.rm=T)
      )
    
    results_frame <- data.frame(
      n=sum(!is.na(result$maximum_age)),
      mean=mean(result$maximum_age, na.rm=T),
      sd=sd(result$maximum_age, na.rm=T),
      min=min(result$maximum_age, na.rm=T),
      Q1=quantile(result$maximum_age, 0.25, na.rm=T),
      median=median(result$maximum_age, na.rm=T),
      Q3=quantile(result$maximum_age, 0.75, na.rm=T),
      max=max(result$maximum_age, na.rm=T)
    )
    
    rownames(results_frame) <- deparse(substitute(data))
    
    return(results_frame)
  }

boys_preterm_steroids_maximum_ages <-
  function_to_report_maximum_age_at_measurement(boys_preterm_steroids)
boys_preterm_no_steroids_maximum_ages <-
  function_to_report_maximum_age_at_measurement(boys_preterm_no_steroids)
boys_all_preterm_maximum_ages <-
  function_to_report_maximum_age_at_measurement(boys_all_preterm)
boys_term_maximum_ages <-
  function_to_report_maximum_age_at_measurement(boys_term)

girls_preterm_steroids_maximum_ages <-
  function_to_report_maximum_age_at_measurement(girls_preterm_steroids)
girls_preterm_no_steroids_maximum_ages <-
  function_to_report_maximum_age_at_measurement(girls_preterm_no_steroids)
girls_all_preterm_maximum_ages <-
  function_to_report_maximum_age_at_measurement(girls_all_preterm)
girls_term_maximum_ages <-
  function_to_report_maximum_age_at_measurement(girls_term)

all_groups_maximum_ages <-
rbind(
  boys_all_preterm_maximum_ages,
  boys_term_maximum_ages,
  boys_preterm_steroids_maximum_ages,
  boys_preterm_no_steroids_maximum_ages,
  girls_all_preterm_maximum_ages,
  girls_term_maximum_ages,
  girls_preterm_steroids_maximum_ages,
  girls_preterm_no_steroids_maximum_ages
)

all_groups_maximum_ages$group <-
  c(
    "Boys all Preterm",
    "Boys Term", 
    "Boys Preterm Steroids", 
    "Boys Preterm No Steroids", 
    "Girls all Preterm", 
    "Girls Term", 
    "Girls Preterm Steroids", 
    "Girls Preterm No Steroids"
  )

#add group so this frame can be plotted as labels
dir.create("transformed")
write.csv(all_groups_maximum_ages, "transformed/all_groups_maximum_ages.csv", row.names=T)
```

#####################################
population plots
####################################


```{r, create histograms for each group}
# Function to extract unique IDs from a group and plot GA for those IDs
plot_ga_histogram_by_ids <- 
  function(group_data, group_name, group_colour) {
  unique_ids <- 
    unique(group_data$nw_id)
  
  # Filter the original data using these unique IDs
  filtered_data <- 
    data %>% filter(nw_id %in% unique_ids)
  
  number_ga <- 
    round(sum(!is.na(filtered_data$ga)), digits=1)
  mean_ga <- 
    round(mean(filtered_data$ga, na.rm=T), digits=1)
  sd_ga <- 
    round(sd(filtered_data$ga, na.rm=T), digits=1)
  
  # Plot the GA histogram
  plot <- ggplot(filtered_data, aes(x = ga)) +
    geom_histogram(binwidth = 0.5, 
                   fill = group_colour, 
                   color = group_colour) +
    labs(
      title = paste0("Gestational Age (GA) for", group_name),
      subtitle = paste0("n = ", number_ga, "; mean = ", mean_ga, "; sd = ", sd_ga  ),
      x = "Gestational Age (weeks)", 
      y = "Frequency") + 
    xlim(20, 45) +
    ylim(0,10) +
    theme_minimal() +
  theme(
    plot.background=element_rect(fill="white", colour=NA) 
  ) 

dir.create("histograms")    
ggsave(filename = paste0(
  "gestational_age_",
  group_name,
  ".tif"),
         path = "histograms",
         plot = plot,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)

plot
}

# Example usage for each group (assumes you have `boys_steroids`, `all_data`, etc.)
plot_ga_histogram_by_ids(group_data=boys_term, 
                         group_name="Boys term",
                         group_colour=boys_term_colour)
plot_ga_histogram_by_ids(group_data=boys_preterm_steroids, 
                         group_name="Boys with Steroids",
                         group_colour=boys_steroids_colour)
plot_ga_histogram_by_ids(group_data=boys_preterm_no_steroids, 
                         group_name="Boys without Steroids",
                         group_colour=boys_no_steroids_colour)
plot_ga_histogram_by_ids(group_data=girls_term, 
                         group_name="Girls term",
                         group_colour=girls_term_colour)
plot_ga_histogram_by_ids(group_data=girls_preterm_steroids, 
                         group_name="Girls with Steroids",
                         group_colour=girls_steroids_colour)
plot_ga_histogram_by_ids(group_data=girls_preterm_no_steroids, 
                         group_name="Girls without Steroids",
                         group_colour=girls_no_steroids_colour)
```

```{r, plot a density plot of boys}

  filtered_boys_preterm_steroids <- 
    boys_preterm_steroids %>% filter(nw_id %in% unique(boys_preterm_steroids$nw_id))
  filtered_boys_preterm_no_steroids <- 
    boys_preterm_no_steroids %>% filter(nw_id %in% unique(boys_preterm_no_steroids$nw_id))
  filtered_boys_term <- 
    boys_term %>% filter(nw_id %in% unique(boys_term$nw_id))


boys_density_plot <-
  ggplot(data=filtered_boys_preterm_steroids, aes(x = ga)) +
    geom_density(data=filtered_boys_preterm_steroids,
                 fill = boys_steroids_colour, 
                 color = boys_steroids_colour,
                 alpha=0.5) +
    geom_density(data=filtered_boys_preterm_no_steroids,
                 fill = boys_no_steroids_colour, 
                 color = boys_no_steroids_colour,
                 alpha=0.5) +
    geom_density(data=filtered_boys_term,
                 fill = boys_term_colour, 
                 color = boys_term_colour,
                 alpha=0.5) +
    labs(
      title = paste0("Density Plot comparing Gestational Age (GA) for boys"),
      subtitle = paste0(
        "n term = ",
        length(unique(filtered_boys_term$nw_id)),
        "; n preterm steroids = ",
        length(unique(filtered_boys_preterm_steroids$nw_id)),
        "; n preterm no steroids = ",
        length(unique(filtered_boys_preterm_no_steroids$nw_id))
      ),
      x = "Gestational Age (weeks)", 
      y = "Frequency") + 
 #   xlim(20, 45) +
#    ylim(0,10) +
    theme_minimal() +
  theme(
    plot.background=element_rect(fill="white", colour=NA) 
  ) 
  boys_density_plot
dir.create("density_plots")
ggsave(filename = paste0("boys_density_plot",
                           ".tif"),
         path = "density_plots",
         plot = boys_density_plot,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
```


```{r, plot a density plot of girls}

  filtered_girls_preterm_steroids <- 
    girls_preterm_steroids %>% filter(nw_id %in% unique(girls_preterm_steroids$nw_id))
  filtered_girls_preterm_no_steroids <- 
    girls_preterm_no_steroids %>% filter(nw_id %in% unique(girls_preterm_no_steroids$nw_id))
  filtered_girls_term <- 
    girls_term %>% filter(nw_id %in% unique(girls_term$nw_id))


girls_density_plot <-
  ggplot(data=filtered_girls_preterm_steroids, aes(x = ga)) +
    geom_density(data=filtered_girls_preterm_steroids,
                 fill = girls_steroids_colour, 
                 color = girls_steroids_colour,
                 alpha=0.5) +
    geom_density(data=filtered_girls_preterm_no_steroids,
                 fill = girls_no_steroids_colour, 
                 color = girls_no_steroids_colour,
                 alpha=0.5) +
    geom_density(data=filtered_girls_term,
                 fill = girls_term_colour, 
                 color = girls_term_colour,
                 alpha=0.5) +
    labs(
      title = paste0("Density Plot comparing Gestational Age (GA) for girls"),
      subtitle = paste0(
        "n term = ",
        length(unique(filtered_girls_term$nw_id)),
        "; n preterm steroids = ",
        length(unique(filtered_girls_preterm_steroids$nw_id)),
        "; n preterm no steroids = ",
        length(unique(filtered_girls_preterm_no_steroids$nw_id))
      ),
      x = "Gestational Age (weeks)", 
      y = "Frequency") + 
 #   xlim(20, 45) +
#    ylim(0,10) +
    theme_minimal() +
  theme(
    plot.background=element_rect(fill="white", colour=NA) 
  ) 
  girls_density_plot
dir.create("density_plots")
ggsave(filename = paste0("girls_density_plot",
                           ".tif"),
         path = "density_plots",
         plot = girls_density_plot,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
```

```{r, plots of raw data height on age coloured by group with term boys}
plot_raw_data_boys <-
  ggplot() +
  geom_line(
    data=boys_preterm_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    linewidth=0.8, 
    colour=boys_steroids_colour,
    alpha=0.5) +
  geom_point(
    data=boys_preterm_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    size=1, 
    colour=boys_steroids_colour,
    alpha=0.2) +
  geom_line(
    data=boys_preterm_no_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    linewidth=0.8, 
    colour="darkgreen",
    alpha=0.5) +
  geom_point(
    data=boys_preterm_no_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    size=1, 
    colour="darkgreen",
    alpha=0.2) +
  geom_line(
    data=boys_term,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    linewidth=0.8, 
    colour="black",
    alpha=0.5) +
  geom_point(
    data=boys_term,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    size=1, 
    colour="black",
    alpha=0.2) +
  labs(title = "Raw data Preterm Boys: Green no steroids, Blue with steroids, Black term",
       x="Age (years)",
       y="Height (cm)") +
  theme_minimal() + 
  theme(
    plot.background=element_rect(fill="white", colour=NA)
  )

plot_raw_data_boys

dir.create("raw_data_plots")
# Save the plot as a TIFF file
  ggsave(filename = paste0("plot_raw_data_boys_with_term", 
                           ".tif"),
         path = "raw_data_plots",
         plot = plot_raw_data_boys,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
```

```{r, plots of raw data height on age coloured by group with term girls}
plot_raw_data_girls <-
  ggplot() +
  geom_line(
    data=girls_preterm_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    linewidth=0.8, 
    colour=girls_steroids_colour,
    alpha=0.5) +
  geom_point(
    data=girls_preterm_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    size=1, 
    colour=girls_steroids_colour,
    alpha=0.2) +
  geom_line(
    data=girls_preterm_no_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    linewidth=0.8, 
    colour="darkgreen",
    alpha=0.5) +
  geom_point(
    data=girls_preterm_no_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    size=1, 
    colour="darkgreen",
    alpha=0.2) +
  geom_line(
    data=girls_term,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    linewidth=0.8, 
    colour="black",
    alpha=0.5) +
  geom_point(
    data=girls_term,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    size=1, 
    colour="black",
    alpha=0.2) +
  labs(title = "Raw data Preterm Girls: Green no steroids, Red with steroids, Black term",
       x="Age (years)",
       y="Height (cm)") +
  theme_minimal() + 
  theme(
    plot.background=element_rect(fill="white", colour=NA)
  )

plot_raw_data_girls

dir.create("raw_data_plots")
# Save the plot as a TIFF file
  ggsave(filename = paste0("plot_raw_data_girls_with_term", 
                           ".tif"),
         path = "raw_data_plots",
         plot = plot_raw_data_girls,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
```


```{r, plots of raw data height on age coloured by group without term boys}
plot_raw_data_boys <-
  ggplot() +
  geom_line(
    data=boys_preterm_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    linewidth=0.8, 
    colour=boys_steroids_colour,
    alpha=0.5) +
  geom_point(
    data=boys_preterm_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    size=1, 
    colour=boys_steroids_colour,
    alpha=0.2) +
  geom_line(
    data=boys_preterm_no_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    linewidth=0.8, 
    colour="darkgreen",
    alpha=0.5) +
  geom_point(
    data=boys_preterm_no_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    size=1, 
    colour="darkgreen",
    alpha=0.2) +
  labs(title = "Raw data Preterm Boys: Green no steroids, Blue with steroids",
       x="Age (years)",
       y="Height (cm)") +
  theme_minimal() + 
  theme(
    plot.background=element_rect(fill="white", colour=NA)
  )

plot_raw_data_boys

dir.create("raw_data_plots")
# Save the plot as a TIFF file
  ggsave(filename = paste0("plot_raw_data_boys_without_term", 
                           ".tif"),
         path = "raw_data_plots",
         plot = plot_raw_data_boys,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
```

```{r, plots of raw data height on age coloured by group without term girls}
plot_raw_data_girls <-
  ggplot() +
  geom_line(
    data=girls_preterm_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    linewidth=0.8, 
    colour=girls_steroids_colour,
    alpha=0.5) +
  geom_point(
    data=girls_preterm_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    size=1, 
    colour=girls_steroids_colour,
    alpha=0.2) +
  geom_line(
    data=girls_preterm_no_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    linewidth=0.8, 
    colour="darkgreen",
    alpha=0.5) +
  geom_point(
    data=girls_preterm_no_steroids,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    size=1, 
    colour="darkgreen",
    alpha=0.2) +
  labs(title = "Raw data Preterm Girls: Green no steroids, Red with steroids",
       x="Age (years)",
       y="Height (cm)") +
  theme_minimal() + 
  theme(
    plot.background=element_rect(fill="white", colour=NA)
  )

plot_raw_data_girls

dir.create("raw_data_plots")
# Save the plot as a TIFF file
  ggsave(filename = paste0("plot_raw_data_girls_without_term", 
                           ".tif"),
         path = "raw_data_plots",
         plot = plot_raw_data_girls,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
```

```{r, missing data plots for those with more than x number of height measurements}
final_patients_with_enough_height <-
  subset(final_df_sorted, n_height_measurements >=3) %>%
  group_by(nw_id) %>%
  slice_max(corrected_age_years, n=1, with_ties=F)

#give us boys and girls separately
final_boys_with_enough_height <-
  subset(final_patients_with_enough_height, sex=="Male")
final_girls_with_enough_height <-
  subset(final_patients_with_enough_height, sex=="Female")

#give us steroid status separately for boys
final_boys_with_enough_height_steroids_yes <-
  subset(final_boys_with_enough_height, STEROIDS=="yes")
final_boys_with_enough_height_steroids_no <-
  subset(final_boys_with_enough_height, STEROIDS=="no")
final_boys_with_enough_height_steroids_missing <-
  subset(final_boys_with_enough_height, is.na(STEROIDS)==T)
final_boys_with_enough_height_steroids_complete <- #for purposes of calculating proportions
  subset(final_boys_with_enough_height, is.na(STEROIDS)==F)

#give us steroid status separately for girls
final_girls_with_enough_height_steroids_yes <-
  subset(final_girls_with_enough_height, STEROIDS=="yes")
final_girls_with_enough_height_steroids_no <-
  subset(final_girls_with_enough_height, STEROIDS=="no")
final_girls_with_enough_height_steroids_missing <-
  subset(final_girls_with_enough_height, is.na(STEROIDS)==T)
final_girls_with_enough_height_steroids_complete <- #for purposes of calculating proportions
  subset(final_girls_with_enough_height, is.na(STEROIDS)==F)

cat("Check our final boys and girls frames have two hundred and two patients  : ")
cat(nrow(final_boys_with_enough_height) +
nrow(final_girls_with_enough_height))

final_patients_prediction_model_columns <-
  final_patients_with_enough_height[,c(
    "ga",
    "sex",
    "STEROIDS",
    "mat_ht",
    "pat_ht"
  )]


# Add a column to classify rows based on missingness
final_patients_prediction_model_columns <- final_patients_prediction_model_columns %>%
  mutate(
    missing_status = case_when(
      is.na(STEROIDS) & is.na(mat_ht) & is.na(pat_ht) ~ "Missing All Covariates",
      is.na(STEROIDS) & is.na(mat_ht) ~ "Missing Steroids and Mat Ht",
      is.na(STEROIDS) & is.na(pat_ht) ~ "Missing Steroids and Pat Ht",
      is.na(mat_ht) & is.na(pat_ht) ~ "Missing Mat Ht and Pat Ht",
      is.na(STEROIDS) ~ "Missing Steroids",
      is.na(mat_ht) ~ "Missing Mat Ht",
      is.na(pat_ht) ~ "Missing Pat Ht",
      T ~ "Complete"
    )
  )


colors <- c(
  "Complete" = "black",
  "Missing Steroids" = "blue",
  "Missing Mat Ht" = "red",
  "Missing Pat Ht" = "red",
  "Missing Steroids and Mat Ht" = "purple",
  "Missing Steroids and Pat Ht" = "purple",
  "Missing Mat Ht and Pat Ht" = "red",
  "Missing All Covariates" = "orange"
)

linetypes <- c(
  "Complete" = "dotted",
  "Missing Steroids" = "solid",
  "Missing Mat Ht" = "solid",
  "Missing Pat Ht" = "solid",
  "Missing Steroids and Mat Ht" = "solid",
  "Missing Steroids and Pat Ht" = "solid",
  "Missing Mat Ht and Pat Ht" = "solid",
  "Missing All Covariates" = "solid"
)

missing_data_by_gestational_age_plot <-
ggplot(final_patients_prediction_model_columns, 
       aes(x = ga, 
           color = missing_status,
           linetype  = missing_status)) +
  geom_linerange(aes(ymin = 0, ymax = 1), size = 1) +  # Vertical lines
  scale_color_manual(values = colors) +  # Use custom colors
  scale_linetype_manual(values = linetypes) +  # Use custom colors
  labs(
    title = "Missing Data Visualization by gestational age",
    subtitle = "Gestational and sex are complete",
    x = "Gestational Age (GA)",
    y = "",
    color = "Missingness Status"
  ) +
  theme_minimal() +
  theme(axis.text.y = element_blank(),  # Remove y-axis text
        axis.ticks.y = element_blank(),  # Remove y-axis ticks
        panel.grid.major.y = element_blank(),  # Remove horizontal grid lines
        panel.grid.minor.y = element_blank())+
  theme(
    plot.background=element_rect(fill="white", colour=NA))
dir.create("missing_data_plots")
  ggsave(filename = paste0("missing_data_by_gestational_age_plot", 
                           ".tif"),
         path = "missing_data_plots",
         plot = missing_data_by_gestational_age_plot,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
```
#########################
table 1
#########################

```{r, addition of ethnicity - add this to the table manually once it is in word}
sink("Ethnicity_of_cohort.txt")
print(nrow(final_boys_with_enough_height))
print(nrow(final_girls_with_enough_height))
summarytools::freq(final_patients_with_enough_height$race)
summarytools::freq(final_boys_with_enough_height$race)
summarytools::freq(final_girls_with_enough_height$race)
sink()
```

```{r}
summarytools::freq(final_df_subset$n_height_measurements)
```



```{r, preparing table 1 for paper}
cat("total number of patients with 3 or more height readings = ")
cat(length(unique(girls_all$nw_id)) +
length(unique(boys_all$nw_id)))


```

```{r, constructing column 1 for table 1 for paper}
table_1_column_1 <-
  data.frame(
    table_1_column_1 = c(
      " ",             #row 1
      
      "n\n(%)",             #row 2
      
      "Gestational Age at Delivery\n(weeks)\nmedian (Q1-Q3)",             #row 3
      
      "Maternal height\n(cm)\nmedian (Q1-Q3)",             #row 4
      
      "Paternal height\n(cm)\nmedian (Q1-Q3)",             #row 5
      
      " ",             #row 6
      
      " ",             #row 7
      
      "n\n(%)",             #row 8
      
      " ",             #row 9
      
      "Gestational Age at Delivery\n(weeks)\nmedian (Q1-Q3)",             #row 10
      
      "Maternal height\n(cm)\nmedian (Q1-Q3)",             #row 11
      
      "Paternal height\n(cm)\nmedian (Q1-Q3)"             #row 12
      
      
    )
    )
```

```{r, constructing column 2 for table 1 for paper}
table_1_column_2 = 
  data.frame(
    table_1_column_2 =
      c(
    
      "Boys",
      
      paste0(
        length(final_boys_with_enough_height$nw_id),
        "\n(",
        round(
        length(final_boys_with_enough_height$nw_id) / 
          length(final_patients_with_enough_height$nw_id) * 100,
        digits=1),
        "%)"),
      
      paste0(
        round(
          median(final_boys_with_enough_height$ga, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_boys_with_enough_height$ga, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_boys_with_enough_height$ga, 0.75, na.rm=T),
        digits=1),
        ")"),
      
      paste0(
        round(
          median(final_boys_with_enough_height$mat_ht, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_boys_with_enough_height$mat_ht, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_boys_with_enough_height$mat_ht, 0.75, na.rm=T),
        digits=1),
        ")"),
      
      paste0(
        round(
          median(final_boys_with_enough_height$pat_ht, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_boys_with_enough_height$pat_ht, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_boys_with_enough_height$pat_ht, 0.75, na.rm=T),
        digits=1),
        ")"),
      
      "Administered\nAntenatal\nSteroids",
      
      "Yes",
      
      paste0(
        length(final_boys_with_enough_height_steroids_yes$nw_id),
        "\n(",
        round(
        length(final_boys_with_enough_height_steroids_yes$nw_id) / 
          length(final_boys_with_enough_height_steroids_complete$nw_id) * 100,
        digits=1),
        "%)"),
      
      paste0(
        "missing = ",
        length(final_boys_with_enough_height_steroids_missing$nw_id)
      ),
      
            
      paste0(
        round(
          median(final_boys_with_enough_height_steroids_yes$ga, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_boys_with_enough_height_steroids_yes$ga, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_boys_with_enough_height_steroids_yes$ga, 0.75, na.rm=T),
        digits=1),
        ")\n missing = ",
        sum(is.na(final_boys_with_enough_height_steroids_yes$ga)==T)),
      
      paste0(
        round(
          median(final_boys_with_enough_height_steroids_yes$mat_ht, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_boys_with_enough_height_steroids_yes$mat_ht, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_boys_with_enough_height_steroids_yes$mat_ht, 0.75, na.rm=T),
        digits=1),
        ")\n missing = ",
        sum(is.na(final_boys_with_enough_height_steroids_yes$mat_ht)==T)),
      
      paste0(
        round(
          median(final_boys_with_enough_height_steroids_yes$pat_ht, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_boys_with_enough_height_steroids_yes$pat_ht, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_boys_with_enough_height_steroids_yes$pat_ht, 0.75, na.rm=T),
        digits=1),
        ")\n missing = ",
        sum(is.na(final_boys_with_enough_height_steroids_yes$pat_ht)==T))
))

write.csv(table_1_column_2, "table_1_column_2.csv")
```

```{r, constructing column 3 for  table 1 for paper}
table_1_column_3 = 
  data.frame(
  table_1_column_3 = c(
    
      " ",
      
      " ",
      
      " ",
      
      " ",
      
      " ",
      
      " ",
      
      "No",
      
      paste0(
        length(final_boys_with_enough_height_steroids_no$nw_id),
        "\n(",
        round(
        length(final_boys_with_enough_height_steroids_no$nw_id) / 
          length(final_boys_with_enough_height_steroids_complete$nw_id) * 100,
        digits=1),
        "%)"),
      
      " ",
      
            
      paste0(
        round(
          median(final_boys_with_enough_height_steroids_no$ga, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_boys_with_enough_height_steroids_no$ga, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_boys_with_enough_height_steroids_no$ga, 0.75, na.rm=T),
        digits=1),
        ")\n missing = ",
        sum(is.na(final_boys_with_enough_height_steroids_no$ga)==T)),
      
      paste0(
        round(
          median(final_boys_with_enough_height_steroids_no$mat_ht, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_boys_with_enough_height_steroids_no$mat_ht, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_boys_with_enough_height_steroids_no$mat_ht, 0.75, na.rm=T),
        digits=1),
        ")\n missing = ",
        sum(is.na(final_boys_with_enough_height_steroids_no$mat_ht)==T)),
      
      paste0(
        round(
          median(final_boys_with_enough_height_steroids_no$pat_ht, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_boys_with_enough_height_steroids_no$pat_ht, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_boys_with_enough_height_steroids_no$pat_ht, 0.75, na.rm=T),
        digits=1),
        ")\n missing = ",
        sum(is.na(final_boys_with_enough_height_steroids_no$pat_ht)==T))
    
    )
    )
```

```{r, constructing column 4 for table 1 for paper}
table_1_column_4 = 
  data.frame(
    table_1_column_4 =
      c(
    
      "Girls",
      
      paste0(
        length(final_girls_with_enough_height$nw_id),
        "\n(",
        round(
        length(final_girls_with_enough_height$nw_id) / 
          length(final_patients_with_enough_height$nw_id) * 100,
        digits=1),
        "%)"),
      
      paste0(
        round(
          median(final_girls_with_enough_height$ga, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_girls_with_enough_height$ga, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_girls_with_enough_height$ga, 0.75, na.rm=T),
        digits=1),
        ")"),
      
      paste0(
        round(
          median(final_girls_with_enough_height$mat_ht, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_girls_with_enough_height$mat_ht, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_girls_with_enough_height$mat_ht, 0.75, na.rm=T),
        digits=1),
        ")"),
      
      paste0(
        round(
          median(final_girls_with_enough_height$pat_ht, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_girls_with_enough_height$pat_ht, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_girls_with_enough_height$pat_ht, 0.75, na.rm=T),
        digits=1),
        ")"),
      
      "Administered\nAntenatal\nSteroids",
      
      "Yes",
      
      paste0(
        length(final_girls_with_enough_height_steroids_yes$nw_id),
        "\n(",
        round(
        length(final_girls_with_enough_height_steroids_yes$nw_id) / 
          length(final_girls_with_enough_height_steroids_complete$nw_id) * 100,
        digits=1),
        "%)"),
      
      paste0(
        "missing = ",
        length(final_girls_with_enough_height_steroids_missing$nw_id)
      ),
      
            
      paste0(
        round(
          median(final_girls_with_enough_height_steroids_yes$ga, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_girls_with_enough_height_steroids_yes$ga, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_girls_with_enough_height_steroids_yes$ga, 0.75, na.rm=T),
        digits=1),
        ")\n missing = ",
        sum(is.na(final_girls_with_enough_height_steroids_yes$ga)==T)),
      
      paste0(
        round(
          median(final_girls_with_enough_height_steroids_yes$mat_ht, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_girls_with_enough_height_steroids_yes$mat_ht, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_girls_with_enough_height_steroids_yes$mat_ht, 0.75, na.rm=T),
        digits=1),
        ")\n missing = ",
        sum(is.na(final_girls_with_enough_height_steroids_yes$mat_ht)==T)),
      
      paste0(
        round(
          median(final_girls_with_enough_height_steroids_yes$pat_ht, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_girls_with_enough_height_steroids_yes$pat_ht, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_girls_with_enough_height_steroids_yes$pat_ht, 0.75, na.rm=T),
        digits=1),
        ")\n missing = ",
        sum(is.na(final_girls_with_enough_height_steroids_yes$pat_ht)==T))
))
```

```{r, constructing column 5 for  table 1 for paper}
table_1_column_5 = 
  data.frame(
  table_1_column_5 = c(
    
      " ",
      
      " ",
      
      " ",
      
      " ",
      
      " ",
      
      " ",
      
      "No",
      
      paste0(
        length(final_girls_with_enough_height_steroids_no$nw_id),
        "\n(",
        round(
        length(final_girls_with_enough_height_steroids_no$nw_id) / 
          length(final_girls_with_enough_height_steroids_complete$nw_id) * 100,
        digits=1),
        "%)"),
      
      " ",
      
            
      paste0(
        round(
          median(final_girls_with_enough_height_steroids_no$ga, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_girls_with_enough_height_steroids_no$ga, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_girls_with_enough_height_steroids_no$ga, 0.75, na.rm=T),
        digits=1),
        ")\n missing = ",
        sum(is.na(final_girls_with_enough_height_steroids_no$ga)==T)),
      
      paste0(
        round(
          median(final_girls_with_enough_height_steroids_no$mat_ht, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_girls_with_enough_height_steroids_no$mat_ht, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_girls_with_enough_height_steroids_no$mat_ht, 0.75, na.rm=T),
        digits=1),
        ")\n missing = ",
        sum(is.na(final_girls_with_enough_height_steroids_no$mat_ht)==T)),
      
      paste0(
        round(
          median(final_girls_with_enough_height_steroids_no$pat_ht, na.rm=T),
          digits=1),
        "\n(",
        round(
        quantile(final_girls_with_enough_height_steroids_no$pat_ht, 0.25, na.rm=T),
        digits=1),
        " - ",
        round(
        quantile(final_girls_with_enough_height_steroids_no$pat_ht, 0.75, na.rm=T),
        digits=1),
        ")\n missing = ",
        sum(is.na(final_girls_with_enough_height_steroids_no$pat_ht)==T))
    
    )
    )
```

```{r, binding together columns of table 1 for paper}
table_1 = cbind(
  table_1_column_1,
  table_1_column_2,
  table_1_column_3,
  table_1_column_4,
  table_1_column_5
)

write.csv(table_1, "table_1.csv", row.names = F)
```

```{r, print table 1 to a word document}
ft <- flextable(table_1)
  
  # Customize the table appearance
  ft <- ft %>%
    theme_vanilla() %>%
    align(align = "center", part = "header") %>%
    align(align = "center", part = "body") %>%  
    autofit()
  
  # Define paragraph formatting with centered alignment
  centered_paragraph <- fp_par(text.align = "center")
  
  doc <- read_docx() %>%
    body_add_flextable(ft) 
  
  print(doc, target = file.path(paste0("table_1", ".docx")))
```


```{r, density plot of missing data}
missing_data_density_plot <-
  ggplot(data=final_patients_prediction_model_columns, aes(x = ga)) +
    geom_density(data=final_patients_prediction_model_columns,
                 aes(fill = missing_status, 
                 color = missing_status),
                 alpha=0.3) +
  scale_color_manual(values = colors) +  # Use custom colors
  scale_fill_manual(values = colors) +  # Use custom colors
    labs(
      title = paste0("Missing data combinations by gestational age"),
      
      x = "Gestational Age (weeks)"#, 
      #y = "Frequency density"
      ) + 
 #   xlim(20, 45) +
#    ylim(0,10) +
    theme_minimal() +
  theme(
    plot.background=element_rect(fill="white", colour=NA) 
  ) 
  missing_data_density_plot
dir.create("missing_data_plots")
ggsave(filename = paste0("missing_data_density_plot",
                           ".tif"),
         path = "missing_data_plots",
         plot = missing_data_density_plot,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
```


```{r, missing data plots for those with more than x number of height measurements}
missing_frequency_table <-
  rownames_to_column(
    as.data.frame(freq(final_patients_prediction_model_columns$missing_status)), 
    var = "Category")

missing_frequency_table$Percent <-
  round(missing_frequency_table$Percent, digits=1)


# Create a flextable from the frequency table
ft <- flextable(missing_frequency_table)

# Customize the table appearance (optional)
ft <- ft %>%
  set_header_labels(
    Missing_Status = "Missing Status",
    Frequency = "Frequency",
    Percent = "Percent"
  ) %>%
  theme_vanilla() %>%
  autofit()

# Save the table to a Word document
doc <- read_docx() %>%
  body_add_flextable(ft) %>%
  body_add_par("Frequency Table of Missing Data", style = "heading 1")

print(doc, target = "missing_data_plots/Frequency_Table.docx")


```

```{r, visdat of missing data}
# Install the package if not already installed
#install.packages("visdat")



final_patients_prediction_model_columns_no_missing_status <-
  final_patients_prediction_model_columns[ , 
    !(names(final_patients_prediction_model_columns) %in% "missing_status")]
                                          
final_patients_prediction_model_columns_no_missing_status <-
  final_patients_prediction_model_columns_no_missing_status[order(
    final_patients_prediction_model_columns_no_missing_status$ga),]

# Visualize missing data
missing_data_plot <-
vis_miss(final_patients_prediction_model_columns_no_missing_status) +
  theme(
    axis.text=element_blank(),
    axis.text.x.top=element_blank(),
    axis.title=element_blank(),
    plot.title=element_blank(),
    plot.subtitle=element_blank(),
    legend.position="none",
    panel.grid.major = element_blank(),           # Major grid lines
    panel.grid.minor = element_blank(),           # Minor grid lines
    plot.background=element_rect(fill="white", colour=NA),
    )

missing_data_plot <- missing_data_plot +
  scale_fill_manual(
    values = c("TRUE"  = rgb(1, 0, 0, alpha = 0.3), 
               "FALSE"  = rgb(0, 0, 1, alpha = 0.3))
  )
missing_data_plot

dir.create("missing_data_plots")
  ggsave(filename = paste0("missing_data_plot.tif"),
         path = "missing_data_plots",
         plot = missing_data_plot,
         device = "tiff",
         width = 2,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
  
  missing_data_plot
```




```{r, function to create long frame to plot survival from study}
create_attrition_frame <-
  function(data_frame_to_assess_attrition){
    
data_frame_to_assess_attrition <- 
  unique(
  data_frame_to_assess_attrition[,c(
    "nw_id",
    "corrected_age_years"
  )]
  )

data_frame_to_assess_attrition <- 
  data_frame_to_assess_attrition %>%
  group_by(nw_id) %>%
  slice_max(n=1, with_ties = F, corrected_age_years)

    
#we now just create a long frame with age down the one column increasing from -0.5 through to 20
attrition_frame <-
  data.frame(
    age = seq(-0.5, 20, by=0.1)
  )

# Calculate the number above each age
attrition_frame$number_still_in_study <- 
  sapply(
  attrition_frame$age,
  function(x) sum(data_frame_to_assess_attrition$corrected_age_years > x) #mean here is a mean of 1's and 0's and therefore represents the proportion
)
# Calculate the proportion above each age
attrition_frame$proportion_still_in_study <- 
  sapply(
  attrition_frame$age,
  function(x) mean(data_frame_to_assess_attrition$corrected_age_years > x) #mean here is a mean of 1's and 0's and therefore represents the proportion
)

attrition_frame$percentage_still_in_study <- 
  attrition_frame$proportion_still_in_study * 100

return(attrition_frame)
}
```

```{r, apply attrition function to each group}
#then we can use that function seperately on each of our groups
all_attrition <- 
  create_attrition_frame(final_df_sorted)

boys_all_attrition <- 
  create_attrition_frame(boys_all)
boys_all_preterm_attrition <- 
  create_attrition_frame(boys_all_preterm)
boys_term_attrition <- 
  create_attrition_frame(boys_term)
boys_preterm_steroids_attrition <- 
  create_attrition_frame(boys_preterm_steroids)
boys_preterm_no_steroids_attrition <- 
  create_attrition_frame(boys_preterm_no_steroids)

girls_all_attrition <- 
  create_attrition_frame(girls_all)
girls_all_preterm_attrition <- 
  create_attrition_frame(girls_all_preterm)
girls_term_attrition <- 
  create_attrition_frame(girls_term)
girls_preterm_steroids_attrition <- 
  create_attrition_frame(girls_preterm_steroids)
girls_preterm_no_steroids_attrition <- 
  create_attrition_frame(girls_preterm_no_steroids)

```

```{r, plot attrition from study boys}
attrition_line_width <- 2

plot_all_boys_attrition <-
  ggplot() +
#plot overall boys
#  geom_line(
#    data=boys_all_attrition,
#    aes(x=age, 
#        y=percentage_still_in_study), 
#        colour="green", 
#    linewidth=attrition_line_width, 
#    alpha=0.5) +
  geom_line(
    data=boys_term_attrition,
    aes(x=age, 
        y=percentage_still_in_study), 
        colour=boys_term_colour, 
    linewidth=attrition_line_width, 
    alpha=0.5) +
  geom_line(
    data=boys_preterm_no_steroids_attrition,
    aes(x=age, 
        y=percentage_still_in_study), 
        colour=boys_no_steroids_colour, 
    linewidth=attrition_line_width, 
    alpha=0.5) +
  geom_line(
    data=boys_preterm_steroids_attrition,
    aes(x=age, 
        y=percentage_still_in_study), 
        colour=boys_steroids_colour, 
    linewidth=attrition_line_width, 
    alpha=0.5) +
  labs(
    title = "Attrition of male patients throughout study",
    subtitle= 
      paste0("n at start: Term (black) = ", 
             boys_term_attrition$number_still_in_study[1],
             ";  Preterm with steroids (light blue) = ", 
             boys_preterm_steroids_attrition$number_still_in_study[1],
             ";  Preterm no steroids (dark blue) = ", 
             boys_preterm_no_steroids_attrition$number_still_in_study[1]),
    y="Proportion remaining in study",
    x="Age (years)") +
  theme_minimal() + 
  coord_cartesian(ylim=c(0,100)) +
  theme(
#    axis.text=element_blank(),
#    plot.title=element_blank(),
#    plot.subtitle=element_blank(),
#    axis.title=element_blank()
    plot.background=element_rect(fill="white", colour=NA),
    )

dir.create("Survival_plots_of_attrition")
  ggsave(filename = 
           paste0("boys_attrition",
                  ".tif"),
         path = "Survival_plots_of_attrition",
         plot = plot_all_boys_attrition,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)

plot_all_boys_attrition
```

```{r, plot attrition from study girls}
attrition_line_width <- 2

plot_all_girls_attrition <-
  ggplot() +
#plot overall girls
#  geom_line(
#    data=girls_all_attrition,
#    aes(x=age, 
#        y=percentage_still_in_study), 
#        colour="green", 
#    linewidth=attrition_line_width, 
#    alpha=0.5) +
  geom_line(
    data=girls_term_attrition,
    aes(x=age, 
        y=percentage_still_in_study), 
        colour=girls_term_colour, 
    linewidth=attrition_line_width, 
    alpha=0.5) +
  geom_line(
    data=girls_preterm_no_steroids_attrition,
    aes(x=age, 
        y=percentage_still_in_study), 
        colour=girls_no_steroids_colour, 
    linewidth=attrition_line_width, 
    alpha=0.5) +
  geom_line(
    data=girls_preterm_steroids_attrition,
    aes(x=age, 
        y=percentage_still_in_study), 
        colour=girls_steroids_colour, 
    linewidth=attrition_line_width, 
    alpha=0.5) +
  labs(
    title = "Attrition of male patients throughout study",
    subtitle= 
      paste0("n at start: Term (black) = ", 
             girls_term_attrition$number_still_in_study[1],
             ";  Preterm with steroids (light red) = ", 
             girls_preterm_steroids_attrition$number_still_in_study[1],
             ";  Preterm no steroids (dark red) = ", 
             girls_preterm_no_steroids_attrition$number_still_in_study[1]),
    y="Percentage remaining in study",
    x="Corrected Gestational Age (years)") +
  theme_minimal() + 
  coord_cartesian(ylim=c(0,100)) +
  theme(
#    axis.text=element_blank(),
#    plot.title=element_blank(),
#    plot.subtitle=element_blank(),
#    axis.title=element_blank()
    plot.background=element_rect(fill="white", colour=NA),
    )

dir.create("Survival_plots_of_attrition")
  ggsave(filename = 
           paste0("girls_attrition",
                  ".tif"),
         path = "Survival_plots_of_attrition",
         plot = plot_all_girls_attrition,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)

plot_all_girls_attrition
```

```{r, plot attrition from study both sexes together}
attrition_line_width <- 2

plot_both_sexes_attrition <-
  ggplot() +
#plot overall boys
  geom_line(
    data=boys_all_attrition,
    aes(x=age, 
        y=percentage_still_in_study), 
        colour="blue", 
    linewidth=attrition_line_width, 
    alpha=0.5) +
#plot overall girls
  geom_line(
    data=girls_all_attrition,
    aes(x=age, 
        y=percentage_still_in_study), 
        colour="red", 
    linewidth=attrition_line_width, 
    alpha=0.5) +
  labs(
    title = "Attrition of patients throughout study",
#    subtitle= 
#      paste0("n at start: Term (black) = ", 
#             boys_term_attrition$number_still_in_study[1],
#             ";  Preterm with steroids (light blue) = ", 
#             boys_preterm_steroids_attrition$number_still_in_study[1],
#             ";  Preterm no steroids (dark blue) = ", 
#             boys_preterm_no_steroids_attrition$number_still_in_study[1]),
    y="Patients remaining in study (%)",
    x="Corrected Gestational Age (years)") +
  theme_minimal() + 
  coord_cartesian(ylim=c(0,100)) +
  theme(
#    axis.text=element_blank(),
#    plot.title=element_blank(),
#    plot.subtitle=element_blank(),
#    axis.title=element_blank()
    plot.background=element_rect(fill="white", colour=NA),
    )

dir.create("Survival_plots_of_attrition")
  ggsave(filename = 
           paste0("both_sexes_attrition",
                  ".tif"),
         path = "Survival_plots_of_attrition",
         plot = plot_both_sexes_attrition,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)

plot_both_sexes_attrition
```

```{r, create violin plots of raw data between steroid groups}
group_to_plot <- "STEROIDS"

for (covariate_to_plot in c(
  "ga",
  "mat_ht",
  "pat_ht")){

  
  y_label <- covariate_to_plot
  #can change the y_label here with if statements
  if (covariate_to_plot=="ga"){
    y_label <- "Gestational Age (Weeks)"
  }
  if (covariate_to_plot=="mat_ht"){
    y_label <- "Maternal Height (cm)"
  }
  if (covariate_to_plot=="pat_ht"){
    y_label <- "Paternal Height (cm)"
  }
  
  stats_to_accompany_plot <- 
    final_patients_prediction_model_columns %>%
    group_by(!!sym(group_to_plot)) %>%
    summarise(
      n_value = n(),
      mean_value = mean(!!sym(covariate_to_plot), na.rm = T),
      sd_value = sd(!!sym(covariate_to_plot), na.rm = T),
      median_value = mean(!!sym(covariate_to_plot), na.rm = T)
  )
  
  #dynamically take the y_max so we can manipulate some labels and ensure they don't get cut off
  y_max <- 
    max(final_patients_prediction_model_columns[[covariate_to_plot]], na.rm = T)
  
steroid_covariate_comparison_plot <- 
  ggplot(
    data=final_patients_prediction_model_columns, 
    aes_string(
      x = group_to_plot, 
      y = covariate_to_plot, 
      fill = group_to_plot)) +
  scale_fill_manual(values = c(
      "yes" = "orange" , 
      "no" = "purple")) +# Use distinct colors for all groups) +
  geom_violin(
    linewidth = 0.5,
    alpha=0.3) +
  geom_jitter(
    size=1, 
    width=0.3,
    alpha=0.4) +
  stat_summary(
    fun = median,  # Specify the median function
    geom = "crossbar",  # Use crossbar to draw a horizontal line
    width = 0.5,  # Control the width of the line
    color = "black",  # Customize the line color
    linewidth = 0.25  # Customize the line thickness
  ) +
  stat_summary(
    fun.data = function(y) {
      data.frame(
        ymin = quantile(y, 0.25),  # 25th percentile
        ymax = quantile(y, 0.75),  # 75th percentile
        y = median(y)  # Needed for the geom used
      )
    },
    geom = "errorbar",  # Use error bars for vertical IQR lines
    width = 0.2,  # Width of the "error bar cap"
    color = "black",  # Customize the color of the IQR lines
    linewidth = 0.75  # Customize the line thickness
  ) +
  geom_text(
    data = stats_to_accompany_plot,
    aes(
      x = !!sym(group_to_plot),
      y = max(final_patients_prediction_model_columns[[covariate_to_plot]], na.rm = T) + 
        0.1 * max(final_patients_prediction_model_columns[[covariate_to_plot]], na.rm = T),  # Adjust to position above the plot
      label = paste0(
        "Mean: ", round(mean_value, 2), 
        "\nSD: ", round(sd_value, 2), 
        "\nn: ", n_value)
    ),
    inherit.aes = FALSE,  # Prevent ggplot from reapplying other mappings
    size = 3,
    hjust = 0.5,
    vjust = 0) +
  scale_y_continuous(
    limits = c(NA, y_max + 0.15 * max(final_patients_prediction_model_columns[[covariate_to_plot]], na.rm = T)),  # Dynamically set the upper limit
    expand = expansion(mult = c(0, 0.1))  # Add extra space at the top
  ) +
  labs(title = paste0(y_label, " between antenatal steroid status"),
       subtitle = "Lines are median with interquartile range",
       x = "Received antenatal steroids",
       y = y_label) +
  theme_minimal() +
#  coord_cartesian(ylim=c(6,16)) +
  theme(
    plot.background=element_rect(fill="white", colour=NA)) 

print(steroid_covariate_comparison_plot)

dir.create("violin_comparison_plots")
dir.create(paste0("violin_comparison_plots/raw_data"))
# Save the plot as a TIFF file
  ggsave(filename = 
           paste0(group_to_plot, 
                  "_",
                  covariate_to_plot,
                  ".tif"),
         path = paste0("violin_comparison_plots/raw_data"),
         plot = steroid_covariate_comparison_plot,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
}
```

##########################
HERE IS THE CHUNK THAT WILL FIT ALL THE SITARS AND PREDICT THE METRICS IN ALL PERMUTATIONS
##########################

```{r, function to fit all the sitar models and predict}

fit_sitar_and_predict_metrics <- 
  function(
    name_of_data_frame, #name_of_data_frame <- "boys_all"  #name_of_data_frame <- "girls_all"
    sitar_degrees_of_freedom, #sitar_degrees_of_freedom <- 8
    sitar_x_variable, #sitar_x_variable <- "transformed_age"
    sitar_y_variable, #sitar_y_variable <- "height_"
    threshold_age_for_final_height,#threshold_age_for_final_height <- 14
    threshold_final_height_velocity#threshold_final_height_velocity <- 2
  ){
    
  #get the data frame from it's name
    data_frame <- as.data.frame(get(name_of_data_frame))
    #put the x and y variables into the data frame that we get, so we can reference them directly within the sitar function
    data_frame$x_variable <-
      data_frame[[sitar_x_variable]]
    data_frame$y_variable <-
      data_frame[[sitar_y_variable]]

  #fit SITAR  
  sitar_model_fit <- 
    sitar(
      x = x_variable,
      y = y_variable, 
      id = nw_id, 
      data = data_frame, 
      df = sitar_degrees_of_freedom
      )
  
  #fit a null model to be able to assess pseudo r2
   null_model_fit <- 
      sitar(
        x = x_variable, 
        y = y_variable, 
        id = nw_id, 
        data = data_frame, 
        df = 0)
  
  # Extract log-likelihoods
  log_likelihood_full_model <- logLik(sitar_model_fit)
  log_likelihood_null_model <- logLik(null_model_fit)
  
  #calculate pseudor2
  pseudo_r2 <- 
    1 - (as.numeric(-2 * log_likelihood_full_model) / 
           as.numeric(-2 * log_likelihood_null_model))
   
 #extract random effects of fit
  sitar_model_random_effects <-
    rownames_to_column(
      ranef(
        sitar_model_fit), 
      var="nw_id")
  
  #add the random effects to the data frame
  data_frame_with_random_effects <-
  left_join(
    data_frame,
    sitar_model_random_effects,
    by = join_by(nw_id)
  )
  
  #add the sitar individual patient level predictions by patient
  data_frame_with_random_effects$sitar_prediction <-
    predict(sitar_model_fit, newdata = data_frame, type = "response")
  
  #add the sitar fixed effects predictions at each data point to allow calculation of marginal and conditional R2 later on
  data_frame_with_random_effects$fixed_effects_prediction <-
    predict(sitar_model_fit, newdata = data_frame, level=0)
  
  rmse <-
    sqrt(
      mean((
        data_frame_with_random_effects$sitar_prediction - 
          data_frame_with_random_effects$y_variable)^2))
  
    #as well as predicting to our data, we also want to predict the fixed effects to a brand new frame
  #we want this for individual patient fits, and later for the average fixed effects fit
  #do individual patients first
  #for every patient, we want to create a random effects frame and then bind them all together
    one_patient_random_effects_data_frame <-
      data.frame(
        x_variable = seq(-0.74, 3, by = 0.05)
      )
    #back transform the age
    one_patient_random_effects_data_frame$corrected_x_variable_years <-
      exp(one_patient_random_effects_data_frame$x_variable) - 0.75
    
    #create an overall frame to bind to
    all_patient_random_effects_fit_data_frame <- data.frame()
    
    #loop around each patient fitting their random effects and bind them to an overall frame
    for (each_patient in unique(data_frame$nw_id)){
      
      this_patients_data <-
        subset(data_frame, nw_id==each_patient)
      
      this_patient_random_effects_data_frame <-
        one_patient_random_effects_data_frame
      
      this_patient_random_effects_data_frame$nw_id <- 
        each_patient
      
      this_patient_random_effects_data_frame$y_variable <- 
        as.numeric(
          predict(
            sitar_model_fit, 
            newdata = this_patient_random_effects_data_frame) ) 
      
      #add the important individual tabular data
      this_patient_random_effects_data_frame$STEROIDS <- 
        this_patients_data$STEROIDS[[1]]
      this_patient_random_effects_data_frame$ga <- 
        this_patients_data$ga[[1]]
      this_patient_random_effects_data_frame$mat_ht <- 
        this_patients_data$mat_ht[[1]]
      this_patient_random_effects_data_frame$pat_ht <- 
        this_patients_data$pat_ht[[1]]
      this_patient_random_effects_data_frame$sex <- 
        this_patients_data$sex[[1]]
      this_patient_random_effects_data_frame$race <- 
        this_patients_data$race[[1]]
      this_patient_random_effects_data_frame$final_height_raw_data <- 
        this_patients_data$final_height[[1]]
      this_patient_random_effects_data_frame$age_at_final_height_velocity_raw_data <- 
        this_patients_data$age_at_final_height_velocity[[1]]
      this_patient_random_effects_data_frame$final_height_velocity_raw_data <- 
        this_patients_data$final_height_velocity[[1]]
      
      #add the growth velocity
      this_patient_random_effects_data_frame <- 
      this_patient_random_effects_data_frame %>%
        mutate(
          years_to_next_reading = 
            lead(corrected_x_variable_years) - corrected_x_variable_years,
          growth_to_next_reading = 
            lead(y_variable) - y_variable,
          growth_velocity_to_next_reading = 
            growth_to_next_reading / years_to_next_reading)
      
      #calculate the salient metrics for this patient
      #take out just data after 6 years of age
      this_patient_random_effects_data_frame_over_six_years <-
        subset(
          this_patient_random_effects_data_frame,
          corrected_x_variable_years > 6)
      
      #take out the whole row with maximum growth velocity after 6
      this_patient_maximum_growth_velocity_row_after_six_years <-
        this_patient_random_effects_data_frame_over_six_years %>%
        slice_max(n=1, with_ties = F, growth_velocity_to_next_reading)
      
      #extract the maximum growth velocity after 6 and the age it occurs
      this_patient_maximum_SITAR_growth_velocity_after_six_years <-
        this_patient_maximum_growth_velocity_row_after_six_years$growth_velocity_to_next_reading
      
      this_patient_age_at_maximum_SITAR_growth_velocity_after_six_years <-
        this_patient_maximum_growth_velocity_row_after_six_years$corrected_x_variable_years
      
      #take out the whole row with growth at 18 years
      this_patient_oldest_row <-
        this_patient_random_effects_data_frame %>%
        slice_max(corrected_x_variable_years, n=1, with_ties = F)
      
      #take out the patients final sitar height and age at which it is calculated 
      this_patient_age_at_final_SITAR_height <-
        this_patient_oldest_row$corrected_x_variable_years
      this_patient_final_SITAR_height <-
        this_patient_oldest_row$y_variable
      
      #add all of our calculated maximum and final metrics to the random effects frame
      this_patient_random_effects_data_frame$age_at_final_SITAR_height <-
        this_patient_age_at_final_SITAR_height
      this_patient_random_effects_data_frame$final_SITAR_height <-
        this_patient_final_SITAR_height
      this_patient_random_effects_data_frame$maximum_SITAR_growth_velocity_after_six_years <-
        this_patient_maximum_SITAR_growth_velocity_after_six_years
      this_patient_random_effects_data_frame$age_at_maximum_SITAR_growth_velocity_after_six_years <-
        this_patient_age_at_maximum_SITAR_growth_velocity_after_six_years
      
      #join in this patients random effects coefficients
      this_patient_random_effects_data_frame <-
        left_join(
          this_patient_random_effects_data_frame,
          sitar_model_random_effects,
          by = join_by(nw_id)
        )

      #bind all the patients together in one long frame
      all_patient_random_effects_fit_data_frame <- 
        rbind(all_patient_random_effects_fit_data_frame, 
              this_patient_random_effects_data_frame)
    }
    
    #from the all_patient_random_effects_fit_data_frame we can extract the important metrics to join back into each patient data frame
    random_effect_metrics_to_join <- 
      unique(
      all_patient_random_effects_fit_data_frame[,c(
        "nw_id",
        "age_at_final_SITAR_height",
        "final_SITAR_height",
        "maximum_SITAR_growth_velocity_after_six_years",
        "age_at_maximum_SITAR_growth_velocity_after_six_years"
        )]
      )

  data_frame_with_random_effect_metrics <-
    left_join(
      data_frame_with_random_effects,
      random_effect_metrics_to_join,
      by = join_by(nw_id)
    )
  
  #rationalise our file names
  data_frame_with_random_effects <- data_frame_with_random_effect_metrics
  
    #now create a fixed effects data frame
    overall_fixed_effects_fit_data_frame <-
      data.frame(
        x_variable = seq(-0.74, 3, by = 0.05)
      )
    
    #then use the sitar fit at level 0 to predict the fixed effects to be able to display the 'average' model
    overall_fixed_effects_fit_data_frame$y_variable <- 
      as.numeric(
        predict(
          sitar_model_fit, 
          newdata = overall_fixed_effects_fit_data_frame,
          level = 0))
    
    #back transform the age
    overall_fixed_effects_fit_data_frame$corrected_x_variable_years <-
      exp(overall_fixed_effects_fit_data_frame$x_variable) - 0.75

    #calculate height velocity 
    overall_fixed_effects_fit_data_frame <- 
      overall_fixed_effects_fit_data_frame %>%
        mutate(
          years_to_next_reading = 
            lead(corrected_x_variable_years) - corrected_x_variable_years,
          growth_to_next_reading = 
            lead(y_variable) - y_variable,
          growth_velocity_to_next_reading = 
            growth_to_next_reading / years_to_next_reading)
      
    #take the peak velocity after age 6 
    peak_pubertal_height_velocity_frame <-
      overall_fixed_effects_fit_data_frame %>%
      filter(corrected_x_variable_years > 6) %>%
      slice_max(growth_velocity_to_next_reading, with_ties = F, n=1)
    
    fixed_effect_peak_pubertal_height_velocity <-
      peak_pubertal_height_velocity_frame$growth_velocity_to_next_reading
    
    age_at_fixed_effect_peak_pubertal_height_velocity <-
      peak_pubertal_height_velocity_frame$corrected_x_variable_years
    
    #take out the final height from the sitar fit
    final_height_from_SITAR_frame <-
      overall_fixed_effects_fit_data_frame %>%
      slice_max(corrected_x_variable_years, with_ties = F, n=1)

    fixed_effect_final_height <-
      final_height_from_SITAR_frame$y_variable
    
    fixed_effect_age_at_final_height <-
      final_height_from_SITAR_frame$corrected_x_variable_years
      

  #predict sitar random effects as our outcome metrics
  #to do this we want to use as much data as possible each time
  #we want to assess gestational_age, parental_heights, and steroid status
  #we want to do it in a forward selection mechanism, assessing how much data we have at each point, all the way up to a combination of the metrics
  
  #we first filter by the functions thresholds and get one patient per row
  data_shaped_for_prediction_models <-
    data_frame_with_random_effects %>%
      group_by(nw_id) %>%
      slice_max(corrected_age_years, n=1, with_ties = F)
  
  #take data with a suitable final height for direct prediction modelling
  data_with_final_height <-
    data_frame_with_random_effects %>%
      group_by(nw_id) %>%
      slice_max(corrected_age_years, n=2, with_ties = F) %>%
      slice(1) %>%
      filter(age_at_final_height_velocity > threshold_age_for_final_height) %>%
      filter(final_height_velocity < threshold_final_height_velocity)
  
  #before we run our loop of prediction models we put the parameters we used for the sitar into a frame
  results_of_sitar_and_prediction_models <- 
    data.frame(
      data = name_of_data_frame,
      number_of_patients_in_sitar = length(unique(names(predict(sitar_model_fit)))),
      number_of_observations_in_sitar = length(predict(sitar_model_fit)),
      sitar_degrees_of_freedom = sitar_degrees_of_freedom,
      sitar_x_variable = sitar_x_variable,
      sitar_y_variable = sitar_y_variable,
      BIC = BIC(sitar_model_fit),
      rmse = rmse,
      pseudo_r2 = pseudo_r2,
      fixed_effect_peak_pubertal_height_velocity = fixed_effect_peak_pubertal_height_velocity,
      age_at_fixed_effect_peak_pubertal_height_velocity = age_at_fixed_effect_peak_pubertal_height_velocity,
      fixed_effect_final_height = fixed_effect_final_height,
      fixed_effect_age_at_final_height = fixed_effect_age_at_final_height
    )


###################################
  #run the prediction models
  #create a function to run a model and give the output as a single column within a dataframe, to facilitate easy binding
  linear_model_row_output <-
    function(
      outcome_variable, #outcome_variable <- "a" #outcome_variable <- "final_height"
      predictor_variable_1, #predictor_variable_1 <- "ga"
      predictor_variable_2, #predictor_variable_2 <- "mat_ht"
      predictor_variable_3, #predictor_variable_3 <- "pat_ht"
      predictor_variable_4, #predictor_variable_4 <- "STEROIDS"
      decimal_places_for_coefficients,#decimal_places_for_coefficients<-2
      decimal_places_for_fit_statistics){ #decimal_places_for_fit_statistics<-2
      
  #we want to paste together the predictors as long as they aren't NA, so we create a vector first then na omit and then paste it into a formula with the outcome variable 
  all_predictors <-
    c(predictor_variable_1, 
      predictor_variable_2, 
      predictor_variable_3, 
      predictor_variable_4)
  
  predictor_string <-
    paste(na.omit(all_predictors), collapse = " + ")
  
  formula_string <-
    paste(outcome_variable, "~", predictor_string)
  
  #create a model
  prediction_model <- 
    lm(
      data=data_shaped_for_prediction_models,
      formula=formula_string
    )
  
  #put a correction in to use the different data frame if we are predicting final height that has subset based on the limits of data attrition
  if (outcome_variable=="final_height"){
  prediction_model <- 
    lm(
      data=data_with_final_height,
      formula=formula_string
    )
  }
  
  summary_of_model <-
    summary(prediction_model)
  
  
  
  #pull out all the coefficients apart from the intercept, and order by t value
  model_coefficients_frame <-
      subset(
      rownames_to_column(
        as.data.frame(
          summary_of_model$coefficients), 
        var="variable"), 
      variable!="(Intercept)")
  
  model_coefficients_frame <-
    model_coefficients_frame[order(model_coefficients_frame$`Pr(>|t|)`),]
  
  #then I just want to pull out all of the aspects of the model in a single column to add to an overarching data frame
  model_output_frame <-
    data.frame(
      new_model_below = "************",
      number_in_model = length(predict(prediction_model)),
      outcome_variable = outcome_variable,
      predictor_variables = predictor_string,
      p_model = round(
        pf(summary_of_model$fstatistic[1], 
           summary_of_model$fstatistic[2], 
           summary_of_model$fstatistic[3], 
           lower.tail = FALSE),
                      digits=decimal_places_for_fit_statistics),
      r_squared_model = 
        round(summary_of_model$r.squared,
                      digits=decimal_places_for_fit_statistics),
      intercept = 
        round(summary_of_model$coefficients[1,1], 
                        digits=decimal_places_for_coefficients),
      predictor_1 = model_coefficients_frame[1,1],
      predictor_1_coefficient = 
        round(model_coefficients_frame[1,2], 
                                      digits=decimal_places_for_coefficients),
      predictor_1_st_error = 
        round(model_coefficients_frame[1,3], 
                                   digits=decimal_places_for_coefficients),
      predictor_1_p_value = 
        round(model_coefficients_frame[1,5], 
                                   digits=decimal_places_for_fit_statistics)
    )
  
  #note here you have to make it numeric, because if it's NA it may be a character
  model_output_frame$predictor_2 <-
    model_coefficients_frame[2,1]
  model_output_frame$predictor_2_coefficient <-
    round(as.numeric(model_coefficients_frame[2,2]), digits=decimal_places_for_coefficients)
  model_output_frame$predictor_2_st_error <-
    round(as.numeric(model_coefficients_frame[2,3]), digits=decimal_places_for_coefficients)
  model_output_frame$predictor_2_p_value <-
    round(as.numeric(model_coefficients_frame[2,5]), digits=decimal_places_for_coefficients)
  
  
  model_output_frame$predictor_3 <-
    model_coefficients_frame[3,1]
  model_output_frame$predictor_3_coefficient <-
    round(as.numeric(model_coefficients_frame[3,2]), digits=decimal_places_for_coefficients)
  model_output_frame$predictor_3_st_error <-
    round(as.numeric(model_coefficients_frame[3,3]), digits=decimal_places_for_coefficients)
  model_output_frame$predictor_3_p_value <-
    round(as.numeric(model_coefficients_frame[3,5]), digits=decimal_places_for_coefficients)
  
  
  model_output_frame$predictor_4 <-
    model_coefficients_frame[4,1]
  model_output_frame$predictor_4_coefficient <-
    round(as.numeric(model_coefficients_frame[4,2]), digits=decimal_places_for_coefficients)
  model_output_frame$predictor_4_st_error <-
    round(as.numeric(model_coefficients_frame[4,3]), digits=decimal_places_for_coefficients)
  model_output_frame$predictor_4_p_value <-
    round(as.numeric(model_coefficients_frame[4,5]), digits=decimal_places_for_coefficients)
  
  return(list(
    model_output_frame,
    prediction_model
    ))
  
    }



#we now run our function through a loop with all the outcomes and predictors that we want to assess

  #add each prediction model to a list whilst we do this
  
list_of_prediction_model_fits <- list()

#to accommodate multiple loops within loops, we incorporate a nested_loop_counter
nested_loop_counter <- 1

#we then loop round putting each variable in or setting it as NA
for(outcome_variable in c(
  "final_height",
  "a", 
  "b", 
  "c",
  "final_SITAR_height",
  "maximum_SITAR_growth_velocity_after_six_years",
  "age_at_maximum_SITAR_growth_velocity_after_six_years")){ #outcome_variable <- "a"
  
  for(predictor_variable_1 in c("ga")){ # predictor_variable_1 <- "ga"
    
  for(predictor_variable_2 in c("mat_ht", NA)){ #predictor_variable_2 <- NA
  
  for(predictor_variable_3 in c("pat_ht", NA)){ #predictor_variable_3 <- NA
  
  for(predictor_variable_4 in c("STEROIDS", NA)){ #predictor_variable_4 <- NA
  
  decimal_places_for_coefficients <- 
    4
  
  decimal_places_for_fit_statistics <- 
    4
  
  #skip out of the loop if everything is NA
  if(is.na(predictor_variable_1) &
     is.na(predictor_variable_2) &
     is.na(predictor_variable_3) &
     is.na(predictor_variable_4))
    next
  
result_of_linear_model_row_output <- 
  
  linear_model_row_output(
  
    outcome_variable = outcome_variable,
  
    predictor_variable_1 = predictor_variable_1,
  
    predictor_variable_2 = predictor_variable_2,
  
    predictor_variable_3 = predictor_variable_3,
  
    predictor_variable_4 = predictor_variable_4,
  
    decimal_places_for_coefficients = 4,
  
    decimal_places_for_fit_statistics = 4)    

  prediction_model_linear_output <- result_of_linear_model_row_output[[1]]
  
  prediction_model <- result_of_linear_model_row_output[[2]]

  #add to the prediction model list and name it
  list_of_prediction_model_fits[[(
    length(list_of_prediction_model_fits)+1)]] <- 
    prediction_model
  names(list_of_prediction_model_fits)[[length(
    list_of_prediction_model_fits)]] <- 
      paste0(
        outcome_variable,
        "_on_",
        predictor_variable_1,
        "_",
        predictor_variable_2,
        "_",
        predictor_variable_3,
        "_",
        predictor_variable_4
      )
  save(list_of_prediction_model_fits,   
     file = paste0("list_of_prediction_model_fits.Rdata"))
  

  nested_loop_counter <- nested_loop_counter + 1

results_of_sitar_and_prediction_models <-
  cbind(results_of_sitar_and_prediction_models, 
        prediction_model_linear_output)

#print(dim(results_of_sitar_and_prediction_models))
#print(dim(prediction_model_linear_output))

#can write each output frame if you want to to check the loop
#write.csv(results_of_sitar_and_prediction_models, paste0("results_of_sitar_and_prediction_models", nested_loop_counter, ".csv"))
#write.csv(prediction_model_linear_output, paste0("prediction_model_linear_output", nested_loop_counter, ".csv"))
  }
  }
  }
  }
}

#here is where we return what we want from the function 'fit_sitar_and_predict_metrics'
return(list(
  data_frame_with_random_effects,
  sitar_model_fit,
  results_of_sitar_and_prediction_models,
  overall_fixed_effects_fit_data_frame,
  all_patient_random_effects_fit_data_frame,
  list_of_prediction_model_fits
  ))
#print(nested_loop_counter)
#end the sitar and prediction function
  }


#run the function through different data sets and capture everything that comes out of the function in separate lists so we can refer to them and visualise them
list_of_data_frames_with_sitar_predictions <- list()

list_of_sitar_model_fits <- list()

list_of_list_of_prediction_model_fits <- list()


#we add the sitar_and_prediciton_results to both a list and a data frame
sitar_and_prediction_results <- data.frame()

list_of_sitar_and_prediction_results <- list()

list_of_overall_fixed_effects_fit_data_frames <- list()

list_of_all_patient_random_effects_fit_data_frames <- list()

for(data_frame_names_to_use in c(
  "girls_all",
  "girls_all_preterm",
  "boys_all",
  "boys_all_preterm"
  )){
  
for(sitar_degrees_of_freedom in c(
  6, 
  7, 
  8, 
  9, 10, 11, 12, 13, 14, 15, 17, #16 caused a singularity problem in boys
  18
  )){
print(paste0("looping through data: ", data_frame_names_to_use))
print(paste0("looping through degrees of freedom: ", sitar_degrees_of_freedom))

fit_sitar_and_predict_metrics_for_this_loop <-
  fit_sitar_and_predict_metrics(
    name_of_data_frame = data_frame_names_to_use, #data_frame_names_to_use <- "girls_all"
    sitar_degrees_of_freedom = sitar_degrees_of_freedom,
    sitar_x_variable = "transformed_age",
    sitar_y_variable = "height_",
    threshold_age_for_final_height = 14,
    threshold_final_height_velocity = 1 
  )

#add to the list and name it and save it
  list_of_data_frames_with_sitar_predictions[[(
    length(list_of_data_frames_with_sitar_predictions)+1)]] <- 
    fit_sitar_and_predict_metrics_for_this_loop[[1]]
  names(list_of_data_frames_with_sitar_predictions)[[length(
    list_of_data_frames_with_sitar_predictions)]] <- 
      paste0(
        data_frame_names_to_use,
        "_degrees_",
        sitar_degrees_of_freedom
      )
  save(list_of_data_frames_with_sitar_predictions,   
     file = paste0("list_of_data_frames_with_sitar_predictions.Rdata"))
      
#add to the list and name it
  list_of_sitar_model_fits[[(
    length(list_of_sitar_model_fits)+1)]] <- 
    fit_sitar_and_predict_metrics_for_this_loop[[2]]
  names(list_of_sitar_model_fits)[[length(
    list_of_sitar_model_fits)]] <- 
      paste0(
        data_frame_names_to_use,
        "_degrees_",
        sitar_degrees_of_freedom
      )
  save(list_of_sitar_model_fits,   
     file = paste0("list_of_sitar_model_fits.Rdata"))

#add to the list and name it
  list_of_list_of_prediction_model_fits[[(
    length(list_of_list_of_prediction_model_fits)+1)]] <- 
    fit_sitar_and_predict_metrics_for_this_loop[[6]]
  names(list_of_list_of_prediction_model_fits)[[length(
    list_of_list_of_prediction_model_fits)]] <- 
      paste0(
        data_frame_names_to_use,
        "_degrees_",
        sitar_degrees_of_freedom
      )
  save(list_of_list_of_prediction_model_fits,   
     file = paste0("list_of_list_of_prediction_model_fits.Rdata"))

  prediction_results_to_bind <- 
    fit_sitar_and_predict_metrics_for_this_loop[[3]]
  list_of_sitar_and_prediction_results[[(
    length(list_of_sitar_and_prediction_results)+1)]] <- 
    fit_sitar_and_predict_metrics_for_this_loop[[3]]
  names(list_of_sitar_and_prediction_results)[[length(
    list_of_sitar_and_prediction_results)]] <- 
      paste0(
        data_frame_names_to_use,
        "_degrees_",
        sitar_degrees_of_freedom
      )
  save(list_of_sitar_and_prediction_results,   
     file = paste0("list_of_sitar_and_prediction_results.Rdata"))
  
  
#  write.csv(
#    prediction_results_to_bind, 
#    paste0("prediction_results_to_bind", runif(1, min = 10, max = 20), ".csv"))

#add to the list and name it
  list_of_overall_fixed_effects_fit_data_frames[[(length(
    list_of_overall_fixed_effects_fit_data_frames)+1)]] <- 
    fit_sitar_and_predict_metrics_for_this_loop[[4]]
  names(list_of_overall_fixed_effects_fit_data_frames)[[length(
    list_of_overall_fixed_effects_fit_data_frames)]] <- 
      paste0(
        data_frame_names_to_use,
        "_degrees_",
        sitar_degrees_of_freedom
      )
  save(list_of_overall_fixed_effects_fit_data_frames,   
     file = paste0("list_of_overall_fixed_effects_fit_data_frames.Rdata"))

#add to the list and name it
  list_of_all_patient_random_effects_fit_data_frames[[(length(
    list_of_all_patient_random_effects_fit_data_frames)+1)]] <- 
    fit_sitar_and_predict_metrics_for_this_loop[[5]]
  names(list_of_all_patient_random_effects_fit_data_frames)[[length(
    list_of_all_patient_random_effects_fit_data_frames)]] <- 
      paste0(
        data_frame_names_to_use,
        "_degrees_",
        sitar_degrees_of_freedom
      )
  save(list_of_all_patient_random_effects_fit_data_frames,   
     file = paste0("list_of_all_patient_random_effects_fit_data_frames.Rdata"))

#beyond the first in the loop we bind them together
if(nrow(sitar_and_prediction_results)>0){
  #standardise the column names
  colnames(sitar_and_prediction_results) <- 
    colnames(prediction_results_to_bind)

sitar_and_prediction_results <-
  rbind(sitar_and_prediction_results, prediction_results_to_bind)

#write.csv(
#  sitar_and_prediction_results, 
#  "sitar_and_prediction_results.test.csv")

}

 #for the first in the loop we make the results the bound results
if(nrow(sitar_and_prediction_results)==0){
sitar_and_prediction_results <-
  prediction_results_to_bind

}

colnames(sitar_and_prediction_results) <- 
  make.unique(colnames(sitar_and_prediction_results))

#after binding everything is a character - turn numbers back into numbers
sitar_and_prediction_results <- 
  sitar_and_prediction_results %>%
  mutate(across(
    where(is.character),
    ~ if (all(!is.na(as.numeric(.)))) as.numeric(.) else .
  ))

# Before writing the final results to CSV you can add trailing zero's but you must bear in mind it's a pain - for them to be retained, the cells have to be clearly characters
#sitar_and_prediction_results <- 
#  sitar_and_prediction_results %>%
#  mutate(across(
#    where(is.numeric), 
#    ~ formatC(.x, format = "f", digits = 2) # Adjust digits as needed
#  ))  #turn it back to a character so it prints to CSV with trailing zeros

#transpose it to make it easier to compare
transposed_sitar_and_prediction_results <-
  as.data.frame(t(sitar_and_prediction_results))

colnames(transposed_sitar_and_prediction_results) <- 
  seq(0, ncol(transposed_sitar_and_prediction_results) - 1)

colnames(transposed_sitar_and_prediction_results) <-
  paste0("model_", colnames(transposed_sitar_and_prediction_results))
str(transposed_sitar_and_prediction_results)

#add a suffix space to each cell to make sure my trailing zeros are retained

#transposed_sitar_and_prediction_results_with_prefix <- 
#  transposed_sitar_and_prediction_results %>%
#  mutate_all(~ paste0("_", .))  # Add space to every cell



# Save to CSV
write.csv(
  transposed_sitar_and_prediction_results, 
  "sitar_and_prediction_results.csv")
#what a pain it is to get trailing zeros in r!

}}

write.csv(
  transposed_sitar_and_prediction_results, 
  "sitar_and_prediction_results.csv")

```

##########################
THIS IS THE END OF THE CHUNK THAT WILL FIT ALL THE SITARS AND PREDICT THE METRICS IN ALL PERMUTATIONS
##########################

```{r, instead of running the chunk, you can then just load all of the lists that were saved}
load("list_of_data_frames_with_sitar_predictions.Rdata")

load("list_of_list_of_prediction_model_fits.Rdata")

load("list_of_sitar_model_fits.Rdata")

load("list_of_sitar_and_prediction_results.Rdata")

load("list_of_overall_fixed_effects_fit_data_frames.Rdata")

load("list_of_all_patient_random_effects_fit_data_frames.Rdata")
```

```{r, show the optimum sitar fit for girls}
girls_optimum_model <- list_of_sitar_model_fits[["girls_all_degrees_12"]]
summary(girls_optimum_model)
```

```{r, show the optimum sitar fit for boys}
boys_optimum_model <- list_of_sitar_model_fits[["boys_all_degrees_15"]]

boys_second_optimum_model <- list_of_sitar_model_fits[["boys_all_degrees_12"]]
```

#################################
plot of optimum sitar model fits over raw data
##################################

```{r, extract our optimum fixed effects data frames}
boys_optimum_fit_fixed_effects_data_frame <-
  list_of_overall_fixed_effects_fit_data_frames[["boys_all_degrees_15"]]
boys_second_optimum_fit_fixed_effects_data_frame <-
  list_of_overall_fixed_effects_fit_data_frames[["boys_all_degrees_12"]]
girls_optimum_fit_fixed_effects_data_frame <-
  list_of_overall_fixed_effects_fit_data_frames[["girls_all_degrees_12"]]
```

```{r, plots of raw data height on age for boys}
sitar_on_raw_data_plot_boys <-
  ggplot() +
  geom_line(
    data=boys_all,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    linewidth=0.6, 
    colour="blue",
    alpha=0.2) +
  geom_point(
    data=boys_all,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    size=1, 
    colour=boys_steroids_colour,
    alpha=0.2) +
  geom_line(
    data=subset(boys_optimum_fit_fixed_effects_data_frame, corrected_x_variable_years<18),
    aes(x=corrected_x_variable_years, 
        y=y_variable), 
    linewidth=1.5, 
    linetype="solid",
    colour="black",
    alpha=1) +  
  labs(title = " ",
       x="Age corrected for prematurity (years)",
       y="Height (cm)") +
  coord_cartesian(xlim = c(-0.5,18)) +
  theme_minimal() + 
  theme(
    plot.background=element_rect(fill="white", colour=NA),
    axis.title=element_blank(),
    axis.text=element_blank()
  )

sitar_on_raw_data_plot_boys


dir.create("sitar_on_raw_data_plots")
# Save the plot as a TIFF file
  ggsave(filename = paste0("sitar_on_raw_data_plot_boys", 
                           ".tif"),
         path = "sitar_on_raw_data_plots",
         plot = sitar_on_raw_data_plot_boys,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
```

```{r, plots of raw data height on age for girls}
sitar_on_raw_data_plot_girls <-
  ggplot() +
  geom_line(
    data=girls_all,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    linewidth=0.6, 
    colour="red",
    alpha=0.2) +
  geom_point(
    data=girls_all,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    size=1, 
    colour=girls_steroids_colour,
    alpha=0.2) +
  geom_line(
    data=subset(girls_optimum_fit_fixed_effects_data_frame, corrected_x_variable_years<18),
    aes(x=corrected_x_variable_years, 
        y=y_variable), 
    linewidth=1.5, 
    linetype="solid",
    colour="black",
    alpha=1) +  
  labs(title = " ",
       x="Age corrected for prematurity (years)",
       y="Height (cm)") +
  coord_cartesian(xlim = c(-0.5,18)) +
  theme_minimal() + 
  theme(
    plot.background=element_rect(fill="white", colour=NA),
    axis.title=element_blank(),
    axis.text=element_blank()
  )

sitar_on_raw_data_plot_girls


dir.create("sitar_on_raw_data_plots")
# Save the plot as a TIFF file
  ggsave(filename = paste0("sitar_on_raw_data_plot_girls", 
                           ".tif"),
         path = "sitar_on_raw_data_plots",
         plot = sitar_on_raw_data_plot_girls,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
```

```{r, grid plot of sitar model fits}
grid_sitar_on_raw_data_plots <-
  grid.arrange(
    sitar_on_raw_data_plot_boys,
    sitar_on_raw_data_plot_girls,
    ncol=1)

dir.create("sitar_on_raw_data_plots")
# Save the plot as a TIFF file
  ggsave(filename = paste0("grid_sitar_on_raw_data_plots", 
                           ".tif"),
         path = "sitar_on_raw_data_plots",
         plot = grid_sitar_on_raw_data_plots,
         device = "tiff",
         width = 10,
         height = 10,
         compression = "lzw",
         limitsize = FALSE)
```

```{r, sensitivity analysis plot of raw data height on age for boys with second optimum fit of 12 degrees of freedom}
sitar_second_optimum_on_raw_data_plot_boys <-
  ggplot() +
  geom_line(
    data=boys_all,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    linewidth=0.6, 
    colour="blue",
    alpha=0.2) +
  geom_point(
    data=boys_all,
    aes(x=corrected_age_years, y=height_, group=nw_id), 
    size=1, 
    colour=boys_steroids_colour,
    alpha=0.2) +
  geom_line(
    data=subset(boys_second_optimum_fit_fixed_effects_data_frame, corrected_x_variable_years<18),
    aes(x=corrected_x_variable_years, 
        y=y_variable), 
    linewidth=1.5, 
    linetype="solid",
    colour="black",
    alpha=1) +  
  labs(title = " ",
       x="Age corrected for prematurity (years)",
       y="Height (cm)") +
  coord_cartesian(xlim = c(-0.5,18)) +
  theme_minimal() + 
  theme(
    plot.background=element_rect(fill="white", colour=NA),
    axis.title=element_blank(),
    axis.text=element_blank()
  )

sitar_second_optimum_on_raw_data_plot_boys


dir.create("sitar_on_raw_data_plots")
# Save the plot as a TIFF file
  ggsave(filename = paste0("sitar_second_optimum_on_raw_data_plot_boys", 
                           ".tif"),
         path = "sitar_on_raw_data_plots",
         plot = sitar_second_optimum_on_raw_data_plot_boys,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
```

```{r, appendix table for model fits both sexes and boys second optimum}
boys_coefficients <- 
  round(
    data.frame(appendix_column_2 = fixef(boys_optimum_model)),
    digits=2)
#select off the last 3 rows of random effects, as we don't want them, we want to report the standard deviation of random effects instead
boys_coefficients <- 
  boys_coefficients[1:(nrow(boys_coefficients) - 3), , drop = F]

boys_second_optimum_coefficients <- 
  round(
    data.frame(appendix_column_4 = fixef(boys_second_optimum_model)),
    digits=2)
#select off the last 3 rows of random effects, as we don't want them, we want to report the standard deviation of random effects instead
boys_second_optimum_coefficients <- 
  boys_second_optimum_coefficients[1:(nrow(boys_second_optimum_coefficients) - 3), , drop = F]

girls_coefficients <- 
  round(
    data.frame(appendix_column_3 = fixef(girls_optimum_model)),
    digits=2)

#select off the last 3 rows of random effects, as we don't want them, we want to report the standard deviation of random effects instead
girls_coefficients <- girls_coefficients[1:(nrow(girls_coefficients) - 3), , drop = F]
```

```{r, constructing appendix & column 1}
appendix_column_1 <-
  data.frame(
    appendix_column_1 = c(
      " ",             #row 1
      
      "n patients in model",             #row 2
      
      "n visits in model",             #row 3
      
      "Degrees of freedom",             #row 4
      
      "Bayesian information criterion",             #row 5
      
      "Fixed effects:",             #row 6
      
      "s1",             #row 7
      
      "s2",             #row 8
      
      "s3",             #row 9
      
      "s4",             #row 10
      
      "s5",             #row 11
      
      "s6",             #row 12
      
      "s7",             #row 13
      
      "s8",             #row 14
      
      "s9",             #row 15
      
      "s10",             #row 16
      
      "s11",             #row 17
      
      "s12",             #row 18
      
      "s13",             #row 19
      
      "s14",             #row 20
      
      "s15",             #row 21
      
      "Random effects:",             #row 22
      
      "a:\nSize\nSD",             #row 23
      
      "b:\nTiming\nSD",             #row 24
      
      "c:\nVelocity\nSD",             #row 25
      
      "Root mean squared error",             #row 26
      
      "Pseudo R²"             #row 27
      
      
    )
    )
```
R²

```{r, Appendix column 2 note i have reordered but kept this called 2}
appendix_column_2_part_1 = 
  data.frame(
    appendix_column_2 =
      c(
      "Boys", # row 1
      
      paste0(
        length(unique(boys_optimum_model$data$nw_id))), # row 2
      
      paste0(
        nrow(boys_optimum_model$data)), # row 3
      
      nrow(as.data.frame(boys_optimum_model$fixDF))-3, # row 4
      
      paste0(
        round(
        BIC(boys_optimum_model),
        digits=0)), # row 5
      
      " "
    ))
      
      

#then I want to add my fixed effects coefficients to the bottom
appendix_column_2_part_1 <-
  rbind(appendix_column_2_part_1, boys_coefficients)

#then create part 2 and add it to the bottom of that
appendix_column_2_part_2 = 
  data.frame(
    appendix_column_2 =
      c(
      " ",
      
      paste0(
        round(
          sd(ranef(boys_optimum_model)$a),
        digits=3)),
      
      paste0(
        round(
          sd(ranef(boys_optimum_model)$b),
        digits=3)),
      
      paste0(
        round(
          sd(ranef(boys_optimum_model)$c),
        digits=3)), # row 5
      
        round(
          calculate_rmse(model=boys_optimum_model,
               boys_optimum_model$data),
          digits=3), # row 6
      
        round(
          calculate_pseudo_r2(full_model=boys_optimum_model,
               boys_optimum_model$data),
          digits=3) # row 7

      )  
    )
appendix_column_2 <-
rbind(appendix_column_2_part_1,
      appendix_column_2_part_2)
```

```{r, Appendix column 3 note i have reordered but kept this called 3}
appendix_column_3_part_1 = 
  data.frame(
    appendix_column_3 =
      c(
      "Girls", # row 1
      
      paste0(
        length(unique(girls_optimum_model$data$nw_id))), # row 2
      
      paste0(
        nrow(girls_optimum_model$data)), # row 3
      
      nrow(as.data.frame(girls_optimum_model$fixDF))-3, # row 4
      
      paste0(
        round(
        BIC(girls_optimum_model),
        digits=0)), # row 5
      
      " "
    ))
      
      

#then I want to add my fixed effects coefficients to the bottom
appendix_column_3_part_1 <-
  rbind(appendix_column_3_part_1, girls_coefficients)

#then create part 2 and add it to the bottom of that
appendix_column_3_part_2 = 
  data.frame(
    appendix_column_3 =
      c(
      " ",
      
      " ",
      
      " ",
      
      " ",
      
      paste0(
        round(
          sd(ranef(girls_optimum_model)$a),
        digits=3)),
      
      paste0(
        round(
          sd(ranef(girls_optimum_model)$b),
        digits=3)),
      
      paste0(
        round(
          sd(ranef(girls_optimum_model)$c),
        digits=3)), # row 5
      
        round(
          calculate_rmse(model=girls_optimum_model,
               girls_optimum_model$data),
          digits=3), # row 6
      
        round(
          calculate_pseudo_r2(full_model=girls_optimum_model,
               girls_optimum_model$data),
          digits=3) # row 7

      )  
    )
appendix_column_3 <-
rbind(appendix_column_3_part_1,
      appendix_column_3_part_2)
```

```{r, Appendix column 4 sensitivity column}
appendix_column_4_part_1 = 
  data.frame(
    appendix_column_4 =
      c(
      "Boys (sensitivity analysis)", # row 1
      
      paste0(
        length(unique(boys_second_optimum_model$data$nw_id))), # row 2
      
      paste0(
        nrow(boys_second_optimum_model$data)), # row 3
      
      nrow(as.data.frame(boys_second_optimum_model$fixDF))-3, # row 4
      
      paste0(
        round(
        BIC(boys_second_optimum_model),
        digits=0)), # row 5
      
      " "
    ))
      
      

#then I want to add my fixed effects coefficients to the bottom
appendix_column_4_part_1 <-
  rbind(appendix_column_4_part_1, boys_second_optimum_coefficients)

#then create part 2 and add it to the bottom of that
appendix_column_4_part_2 = 
  data.frame(
    appendix_column_4 =
      c(
      " ",
      
      " ",
      
      " ",
      
      " ",
      
      paste0(
        round(
          sd(ranef(boys_second_optimum_model)$a),
        digits=3)),
      
      paste0(
        round(
          sd(ranef(boys_second_optimum_model)$b),
        digits=3)),
      
      paste0(
        round(
          sd(ranef(boys_second_optimum_model)$c),
        digits=3)), # row 5
      
        round(
          calculate_rmse(model=boys_second_optimum_model,
               boys_second_optimum_model$data),
          digits=3), # row 6
      
        round(
          calculate_pseudo_r2(full_model=boys_second_optimum_model,
               boys_second_optimum_model$data),
          digits=3) # row 7

      )  
    )
appendix_column_4 <-
rbind(appendix_column_4_part_1,
      appendix_column_4_part_2)
```


```{r}
appendix_table <-
  cbind(
    appendix_column_1,
    appendix_column_3,
    appendix_column_2,
    appendix_column_4
  )
```

```{r, print appendix table to a word document}
ft <- flextable(appendix_table)
  
  # Customize the table appearance
  ft <- ft %>%
    theme_vanilla() %>%
    align(align = "center", part = "header") %>%
    align(align = "center", part = "body") %>%  
    autofit()
  
  # Define paragraph formatting with centered alignment
  centered_paragraph <- fp_par(text.align = "center")
  
  doc <- read_docx() %>%
    body_add_flextable(ft) 
  
  print(doc, target = file.path(paste0("appendix_table", ".docx")))
```

```{r, calculate R2 and rmse for girls}
data_from_girls_optimum_fit <- 
  list_of_data_frames_with_sitar_predictions$girls_all_degrees_12

#calculate residual i.e. the observed minus the predicted for the random effects fit
data_from_girls_optimum_fit$random_residual <- data_from_girls_optimum_fit$height_ - data_from_girls_optimum_fit$sitar_prediction
data_from_girls_optimum_fit$random_residual_squared <- data_from_girls_optimum_fit$random_residual * data_from_girls_optimum_fit$random_residual
random_residual_sum_of_squares <- sum(data_from_girls_optimum_fit$random_residual_squared)


#calculate residual i.e. the observed minus the predicted for the fixed effects fit
data_from_girls_optimum_fit$fixed_residual <- data_from_girls_optimum_fit$height_ - data_from_girls_optimum_fit$fixed_effects_prediction
data_from_girls_optimum_fit$fixed_residual_squared <- data_from_girls_optimum_fit$fixed_residual * data_from_girls_optimum_fit$fixed_residual
fixed_residual_sum_of_squares <- sum(data_from_girls_optimum_fit$fixed_residual_squared)

#this is how llm told me to calculate the values
residual_variance <- girls_optimum_model$sigma^2
random_variance <- sum(as.numeric(VarCorr(girls_optimum_model)[, "Variance"]))
fitted_values <- fitted(girls_optimum_model, level = 0)  # Fitted values without random effects
fixed_variance <- var(fitted_values)
r2_marginal <- fixed_variance / (fixed_variance + random_variance + residual_variance)
r2_conditional <- (fixed_variance + random_variance) / (fixed_variance + random_variance + residual_variance)

#we want to calculate the coefficient of determination so calculate it's parts
mean_of_y <- 
  mean(data_from_girls_optimum_fit$height_)
data_from_girls_optimum_fit$deviation_from_mean_of_y_all_squared <-
  (data_from_girls_optimum_fit$height_ - mean_of_y)^2
total_sum_of_squares <- sum(data_from_girls_optimum_fit$deviation_from_mean_of_y_all_squared)
#r2 = 1 - random_residual_sum_of_squares / total_sum_of_squares
r_squared_random <- 
  1 - (random_residual_sum_of_squares / total_sum_of_squares)
r_squared_fixed <- 
  1 - (fixed_residual_sum_of_squares / total_sum_of_squares)


girls_rmse_krish <-
  calculate_rmse(model=list_of_sitar_model_fits[["girls_all_degrees_12"]],
               list_of_data_frames_with_sitar_predictions$girls_all_degrees_12)

data_from_girls_optimum_fit$pseudo_r2 <-
girls_pseudo_r2_krish <-
  calculate_pseudo_r2(full_model=list_of_sitar_model_fits[["girls_all_degrees_12"]],
               list_of_data_frames_with_sitar_predictions$girls_all_degrees_12)

#calculate rmse - mean of squared residuals 

mean_squared_error <- random_residual_sum_of_squares / length(data_from_girls_optimum_fit$random_residual_squared)

data_from_girls_optimum_fit$root_mean_squared_error <-
root_mean_squared_error <- mean_squared_error^0.5
sink("Optimum_model_fit_coefficient_of_determination_statistics.txt")
cat("For girls with 12 degrees of freedom, the model fits are:\n")
cat(paste0("R squared = ", r_squared_random, "\n"))
cat(paste0("RMSE = ", root_mean_squared_error, "\n"))
cat(paste0("Pseudo R squared = ", girls_pseudo_r2_krish, "\n"))
cat("Please note, the manual calculation of R2 and conditional and marginal R2 don't make any sense in this multilevel context. Stick to pseudo R2 and RMSE, which are less over inflationary")
```

```{r, calculate r2 and rmse for boys}
data_from_boys_optimum_fit <- list_of_data_frames_with_sitar_predictions$boys_all_degrees_15

#calculate residual i.e. the observed minus the predicted
data_from_boys_optimum_fit$random_residual <- data_from_boys_optimum_fit$height_ - data_from_boys_optimum_fit$sitar_prediction
data_from_boys_optimum_fit$random_residual_squared <- data_from_boys_optimum_fit$random_residual * data_from_boys_optimum_fit$random_residual
random_residual_sum_of_squares <- sum(data_from_boys_optimum_fit$random_residual_squared)
#we want to calculate the coefficient of determination so calculate it's parts
mean_of_y <- 
  mean(data_from_boys_optimum_fit$height_)
data_from_boys_optimum_fit$deviation_from_mean_of_y_squared <-
  (data_from_boys_optimum_fit$height_ - mean_of_y)^2
total_sum_of_squares <- sum(data_from_boys_optimum_fit$deviation_from_mean_of_y_squared)
#r2 = 1 - random_residual_sum_of_squares / total_sum_of_squares
r_squared <- 1 - (random_residual_sum_of_squares / total_sum_of_squares)

boys_rmse_krish <-
  calculate_rmse(model=list_of_sitar_model_fits[["boys_all_degrees_15"]],
               list_of_data_frames_with_sitar_predictions$boys_all_degrees_15)

data_from_boys_optimum_fit$pseudo_r2 <-
boys_pseudo_r2_krish <-
  calculate_pseudo_r2(full_model=list_of_sitar_model_fits[["boys_all_degrees_15"]],
               list_of_data_frames_with_sitar_predictions$boys_all_degrees_15)

#calculate rmse - mean of squared residuals 

mean_squared_error <- 
  random_residual_sum_of_squares / length(data_from_boys_optimum_fit$random_residual_squared)
data_from_boys_optimum_fit$root_mean_squared_error <- 
  root_mean_squared_error <- 
  mean_squared_error^0.5

cat("For boys with 12 degrees of freedom, the model fits are:\n")
cat(paste0("R squared = ", r_squared, "\n"))
cat(paste0("RMSE = ", root_mean_squared_error, "\n"))
cat(paste0("Pseudo R squared = ", boys_pseudo_r2_krish, "\n"))
sink()
```

```{r, describe and plot residuals}
descr(data_from_girls_optimum_fit$random_residual)
ggplot(data=data_from_girls_optimum_fit, aes(x=age, y=height_)) + geom_point()
ggplot(data=data_from_girls_optimum_fit, aes(x=age, y=random_residual, colour=sex)) + geom_point()

descr(data_from_boys_optimum_fit$random_residual)
ggplot(data=data_from_boys_optimum_fit, aes(x=age, y=height_)) + geom_point()
ggplot(data=data_from_boys_optimum_fit, aes(x=age, y=random_residual, colour=sex)) + geom_point()

```

################################
constructing table 2 for paper
################################

```{r, create data frames of sitar patient fits with just one row per patient}
#take data_from_boys_optimum_fit and data_from_girls_optimum_fit and slice just one row per patient, let's take the largest age
single_row_data_from_girls_optimum_fit <-
  data_from_girls_optimum_fit %>% group_by(nw_id) %>%
  slice_max(age, n=1, with_ties = F)
print("Number of height measurements for girls:")
summarytools::descr(single_row_data_from_girls_optimum_fit$n_height_measurements)

single_row_data_from_boys_optimum_fit <-
  data_from_boys_optimum_fit %>% group_by(nw_id) %>%
  slice_max(age, n=1, with_ties = F)
print("Number of height measurements for boys:")
summarytools::descr(single_row_data_from_boys_optimum_fit$n_height_measurements)

#take each within those of steroids and no steroids
single_row_data_from_girls_optimum_fit_steroids_yes <- 
  subset(single_row_data_from_girls_optimum_fit, STEROIDS=="yes")
single_row_data_from_girls_optimum_fit_steroids_no <- 
  subset(single_row_data_from_girls_optimum_fit, STEROIDS=="no")
single_row_data_from_boys_optimum_fit_steroids_yes <- 
  subset(single_row_data_from_boys_optimum_fit, STEROIDS=="yes")
single_row_data_from_boys_optimum_fit_steroids_no <- 
  subset(single_row_data_from_boys_optimum_fit, STEROIDS=="no")

#take out those with a final raw height
single_row_data_from_boys_with_raw_final_height <-
  subset(single_row_data_from_boys_optimum_fit, final_height_velocity<1)
single_row_data_from_boys_with_raw_final_height_steroids_yes <-
  subset(single_row_data_from_boys_with_raw_final_height, STEROIDS=="yes")
single_row_data_from_boys_with_raw_final_height_steroids_no <-
  subset(single_row_data_from_boys_with_raw_final_height, STEROIDS=="no")

single_row_data_from_girls_with_raw_final_height <-
  subset(single_row_data_from_girls_optimum_fit, final_height_velocity<1)
single_row_data_from_girls_with_raw_final_height_steroids_yes <-
  subset(single_row_data_from_girls_with_raw_final_height, STEROIDS=="yes")
single_row_data_from_girls_with_raw_final_height_steroids_no <-
  subset(single_row_data_from_girls_with_raw_final_height, STEROIDS=="no")
```


```{r, table 2 development}
#this table wants to show the boys and girls, n in the models
# i need data frames with one row per patient and the derived random effects parameters and calculated metrics
```

```{r, constructing table 2 column 1}
table_2_column_1 <-
  data.frame(
    table_2_column_1 = c(
      " ",             #row 1
      
      "SITAR Patient level random effects",             #row 2
      
      "'Size' parameter\nmean (SD)",             #row 3
      
      "by_group",                                #row 3.5
      
      "'Timing' parameter\nmean (SD)",             #row 4
      
      "by_group",                                #row 4.5

      "'Velocity' parameter\nmean (SD)",             #row 5

      "by_group",                                #row 5.5
      
      " ",             #row 6
      
      "Final height from raw data*\n(cm)\n(n)\nmean (SD)",             #row 7
      
      "by_group",                                #row 7.5
      
      " ",             #row 8
      
      "Model derived parameters",             #row 9
      
      "Height at 18.5 years\n(cm)\nmean (SD)",             #row 10
      "by_group",                                #row 10.5
      
      "Height velocity at peak pubertal growth spurt\n(cm/year)\nmean (SD)",             #row 11
      "by_group",                                #row 11.5
      
      "Age at height velocity at peak pubertal growth spurt\n(years)\nmean (SD)",             #row 12
      "by_group",                                #row 12.5
      
      "Root mean squared error\n(cm)",             #row 13
      
      "McFadden's Pseudo R²"             #row 14
      
      
    )
    )
```

```{r, constructing table 2 column 2}
table_2_column_2 = 
  data.frame(
    table_2_column_2 =
      c(
    
      "Boys", # row 1
      
      "No", # row 2
      
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit$a),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit$a),
        digits=3),
        ")"), # row 3
      
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit_steroids_no$a),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit_steroids_no$a),
        digits=3),
        ")"), # row 3.5
      
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit$b),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit$b),
        digits=3),
        ")"), # row 4
      
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit_steroids_no$b),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit_steroids_no$b),
        digits=3),
        ")"), # row 4.5
      
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit$c),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit$c),
        digits=3),
        ")"), # row 5
      
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit_steroids_no$c),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit_steroids_no$c),
        digits=3),
        ")"), # row 5
      
      " ", # row 6
      
      paste0(
        round(
          mean(single_row_data_from_boys_with_raw_final_height$final_height),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_boys_with_raw_final_height$final_height),
        digits=1),
        ")\nn=",
        nrow(single_row_data_from_boys_with_raw_final_height)), # row 7
      
      paste0(
        round(
          mean(single_row_data_from_boys_with_raw_final_height_steroids_no$final_height),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_boys_with_raw_final_height_steroids_no$final_height),
        digits=1),
        ")\nn=",
        nrow(single_row_data_from_boys_with_raw_final_height_steroids_no)), # row 7.5
      
      " ", # row 8
      
      " ", # row 9
      
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit$final_SITAR_height),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit$final_SITAR_height),
        digits=1),
        ")"), # row 10
      
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit_steroids_no$final_SITAR_height),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit_steroids_no$final_SITAR_height),
        digits=1),
        ")"), # row 10.5
      
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit$maximum_SITAR_growth_velocity_after_six_years),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit$maximum_SITAR_growth_velocity_after_six_years),
        digits=1),
        ")"), #row 11
      
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit_steroids_no$maximum_SITAR_growth_velocity_after_six_years),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit_steroids_no$maximum_SITAR_growth_velocity_after_six_years),
        digits=1),
        ")"), #row 11.5
      
            
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit$age_at_maximum_SITAR_growth_velocity_after_six_years),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit$age_at_maximum_SITAR_growth_velocity_after_six_years),
        digits=1),
        ")"), #row 12
      
            
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit_steroids_no$age_at_maximum_SITAR_growth_velocity_after_six_years),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit_steroids_no$age_at_maximum_SITAR_growth_velocity_after_six_years),
        digits=1),
        ")"), #row 12.5
      
      paste0(
        round(
          single_row_data_from_boys_optimum_fit$root_mean_squared_error[1],
          digits=3)), #row 13
      
      paste0(
        round(
          single_row_data_from_boys_optimum_fit$pseudo_r2[1],
          digits=3)) #row 14
))

write.csv(table_2_column_2, "table_2_column_2.csv")
```

```{r, constructing table 2 column 3}
table_2_column_3 = 
  data.frame(
    table_2_column_3 =
      c(
    
      "Boys", # row 1
      
      "Yes", # row 2
      
      " ", # row 3
      
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit_steroids_yes$a),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit_steroids_yes$a),
        digits=3),
        ")"), # row 3.5
      
      " ", # row 4
      
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit_steroids_yes$b),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit_steroids_yes$b),
        digits=3),
        ")"), # row 4.5
      
      " ", # row 5
      
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit_steroids_yes$c),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit_steroids_yes$c),
        digits=3),
        ")"), # row 5.5
      
      " ", # row 6
      
      " ", # row 7
      
      paste0(
        round(
          mean(single_row_data_from_boys_with_raw_final_height_steroids_yes$final_height),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_boys_with_raw_final_height_steroids_yes$final_height),
        digits=1),
        ")\nn=",
        nrow(single_row_data_from_boys_with_raw_final_height_steroids_yes)), # row 7.5
      
      " ", # row 8
      
      " ", # row 9
      
      " ", # row 10
      
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit_steroids_yes$final_SITAR_height),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit_steroids_yes$final_SITAR_height),
        digits=1),
        ")"), # row 10.5
      
      " ", #row 11
      
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit_steroids_yes$maximum_SITAR_growth_velocity_after_six_years),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit_steroids_yes$maximum_SITAR_growth_velocity_after_six_years),
        digits=1),
        ")"), #row 11.5
      
            
      " ", #row 12
      
            
      paste0(
        round(
          mean(single_row_data_from_boys_optimum_fit_steroids_yes$age_at_maximum_SITAR_growth_velocity_after_six_years),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_boys_optimum_fit_steroids_yes$age_at_maximum_SITAR_growth_velocity_after_six_years),
        digits=1),
        ")"), #row 12.5
      
      " ", #row 13
      
      " " #row 14
))

write.csv(table_2_column_2, "table_2_column_2.csv")
```

```{r, constructing table 2 column 4}
table_2_column_4 = 
  data.frame(
    table_2_column_4 =
      c(
    
      "Girls", # row 1
      
      "No", # row 2
      
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit$a),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit$a),
        digits=3),
        ")"), # row 3
      
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit_steroids_no$a),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit_steroids_no$a),
        digits=3),
        ")"), # row 3.5
      
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit$b),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit$b),
        digits=3),
        ")"), # row 4
      
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit_steroids_no$b),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit_steroids_no$b),
        digits=3),
        ")"), # row 4.5
      
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit$c),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit$c),
        digits=3),
        ")"), # row 5
      
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit_steroids_no$c),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit_steroids_no$c),
        digits=3),
        ")"), # row 5
      
      " ", # row 6
      
      paste0(
        round(
          mean(single_row_data_from_girls_with_raw_final_height$final_height),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_girls_with_raw_final_height$final_height),
        digits=1),
        ")\nn=",
        nrow(single_row_data_from_girls_with_raw_final_height)), # row 7
      
      paste0(
        round(
          mean(single_row_data_from_girls_with_raw_final_height_steroids_no$final_height),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_girls_with_raw_final_height_steroids_no$final_height),
        digits=1),
        ")\nn=",
        nrow(single_row_data_from_girls_with_raw_final_height_steroids_no)), # row 7.5
      
      " ", # row 8
      
      " ", # row 9
      
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit$final_SITAR_height),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit$final_SITAR_height),
        digits=1),
        ")"), # row 10
      
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit_steroids_no$final_SITAR_height),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit_steroids_no$final_SITAR_height),
        digits=1),
        ")"), # row 10.5
      
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit$maximum_SITAR_growth_velocity_after_six_years),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit$maximum_SITAR_growth_velocity_after_six_years),
        digits=1),
        ")"), #row 11
      
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit_steroids_no$maximum_SITAR_growth_velocity_after_six_years),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit_steroids_no$maximum_SITAR_growth_velocity_after_six_years),
        digits=1),
        ")"), #row 11.5
      
            
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit$age_at_maximum_SITAR_growth_velocity_after_six_years),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit$age_at_maximum_SITAR_growth_velocity_after_six_years),
        digits=1),
        ")"), #row 12
      
            
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit_steroids_no$age_at_maximum_SITAR_growth_velocity_after_six_years),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit_steroids_no$age_at_maximum_SITAR_growth_velocity_after_six_years),
        digits=1),
        ")"), #row 12.5
      
      paste0(
        round(
          single_row_data_from_girls_optimum_fit$root_mean_squared_error[1],
          digits=3)), #row 13
      
      paste0(
        round(
          single_row_data_from_girls_optimum_fit$pseudo_r2[1],
          digits=3)) #row 14
))

write.csv(table_2_column_2, "table_2_column_2.csv")
```

```{r, constructing table 2 column 5}
table_2_column_5 = 
  data.frame(
    table_2_column_5 =
      c(
    
      "Girls", # row 1
      
      "Yes", # row 2
      
      " ", # row 3
      
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit_steroids_yes$a),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit_steroids_yes$a),
        digits=3),
        ")"), # row 3.5
      
      " ", # row 4
      
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit_steroids_yes$b),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit_steroids_yes$b),
        digits=3),
        ")"), # row 4.5
      
      " ", # row 5
      
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit_steroids_yes$c),
          digits=3),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit_steroids_yes$c),
        digits=3),
        ")"), # row 5.5
      
      " ", # row 6
      
      " ", # row 7
      
      paste0(
        round(
          mean(single_row_data_from_girls_with_raw_final_height_steroids_yes$final_height),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_girls_with_raw_final_height_steroids_yes$final_height),
        digits=1),
        ")\nn=",
        nrow(single_row_data_from_girls_with_raw_final_height_steroids_yes)), # row 7.5
      
      " ", # row 8
      
      " ", # row 9
      
      " ", # row 10
      
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit_steroids_yes$final_SITAR_height),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit_steroids_yes$final_SITAR_height),
        digits=1),
        ")"), # row 10.5
      
      " ", #row 11
      
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit_steroids_yes$maximum_SITAR_growth_velocity_after_six_years),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit_steroids_yes$maximum_SITAR_growth_velocity_after_six_years),
        digits=1),
        ")"), #row 11.5
      
            
      " ", #row 12
      
            
      paste0(
        round(
          mean(single_row_data_from_girls_optimum_fit_steroids_yes$age_at_maximum_SITAR_growth_velocity_after_six_years),
          digits=1),
        "\n(",
        round(
        sd(single_row_data_from_girls_optimum_fit_steroids_yes$age_at_maximum_SITAR_growth_velocity_after_six_years),
        digits=1),
        ")"), #row 12.5
      
      " ", #row 13
      
      " " #row 14
))

write.csv(table_2_column_2, "table_2_column_2.csv")
```



```{r, binding together columns of table 2 for paper}
table_2 = cbind(
  table_2_column_1,
  table_2_column_2,
  table_2_column_3,
  table_2_column_4,
  table_2_column_5
  
)

write.csv(table_2, "table_2.csv", row.names = F)
```

```{r, print table 2 to a word document}
ft <- flextable(table_2)
  
  # Customize the table appearance
  ft <- ft %>%
    theme_vanilla() %>%
    align(align = "center", part = "header") %>%
    align(align = "center", part = "body") %>%  
    autofit()
  
  # Define paragraph formatting with centered alignment
  centered_paragraph <- 
    fp_par(text.align = "center")
  
  doc <- read_docx() %>%
    body_add_flextable(ft) 
  
  print(doc, target = file.path(paste0("table_2", ".docx")))
```


```{r, sink all the sitar fits}
dir.create("sitar_model_fit_summaries")
for (each_fit in names(list_of_sitar_model_fits)){
  print((each_fit))
  each_fit_summary <- (list_of_sitar_model_fits[[each_fit]])
  sink(paste0("sitar_model_fit_summaries/", each_fit, ".txt"))
  print(each_fit_summary)
  sink()
}
```


```{r, pulling out the optimum SITAR fits from the lists}

girls_optimum <-
  as.data.frame(list_of_data_frames_with_sitar_predictions[["girls_all_degrees_12"]])

boys_optimum <- 
  as.data.frame(list_of_data_frames_with_sitar_predictions[["boys_all_degrees_15"]])

boys_second_optimum <- 
  as.data.frame(list_of_data_frames_with_sitar_predictions[["boys_all_degrees_12"]])

girls_optimum_single <-
  girls_optimum %>%
  group_by(nw_id) %>%
  slice_max(corrected_age_years, n=1, with_ties = F)

boys_optimum_single <-
  boys_optimum %>%
  group_by(nw_id) %>%
  slice_max(corrected_age_years, n=1, with_ties = F)

boys_second_optimum_single <-
  boys_second_optimum %>%
  group_by(nw_id) %>%
  slice_max(corrected_age_years, n=1, with_ties = F)

optimum_fits <-
  rbind(girls_optimum_single, boys_optimum_single)

#correct final_height if 
optimum_fits$final_height_raw <-
  ifelse(optimum_fits$final_height_velocity>1,
         NA,
         optimum_fits$final_height)

nrow(optimum_fits)
nrow(girls_optimum_single)
nrow(boys_optimum_single)

descr(girls_optimum_single$a)
descr(boys_optimum_single$a)


```

```{r, bluntly separate optimum fits into those with and without steroids}
girls_optimum_single_steroids_yes <-
  subset(girls_optimum_single, STEROIDS=="yes")
girls_optimum_single_steroids_no <-
  subset(girls_optimum_single, STEROIDS=="no")
boys_optimum_single_steroids_yes <-
  subset(boys_optimum_single, STEROIDS=="yes")
boys_optimum_single_steroids_no <-
  subset(boys_optimum_single, STEROIDS=="no")

summarytools::descr(girls_optimum_single_steroids_yes$final_SITAR_height)
summarytools::descr(girls_optimum_single_steroids_no$final_SITAR_height)

summarytools::descr(boys_optimum_single_steroids_yes$final_SITAR_height)
summarytools::descr(boys_optimum_single_steroids_no$final_SITAR_height)

summarytools::descr(girls_optimum_single_steroids_yes$final_height)
summarytools::descr(girls_optimum_single_steroids_no$final_height)

summarytools::descr(boys_optimum_single_steroids_yes$final_height)
summarytools::descr(boys_optimum_single_steroids_no$final_height)

```


```{r, boys optimum prediction models}
boys_optimum_prediction_model_a <-
  lm(data=boys_optimum_single,
           formula=a~STEROIDS+mat_ht+pat_ht+ga)
boys_optimum_prediction_model_b <-
  lm(data=boys_optimum_single,
           formula=b~STEROIDS+mat_ht+pat_ht+ga)
boys_optimum_prediction_model_c <-
  lm(data=boys_optimum_single,
           formula=c~STEROIDS+mat_ht+pat_ht+ga)
boys_optimum_prediction_model_final_height <-
  lm(data=single_row_data_from_boys_with_raw_final_height,
           formula=final_height~STEROIDS+mat_ht+pat_ht+ga)
boys_optimum_prediction_model_final_SITAR_height <-
  lm(data=boys_optimum_single,
           formula=final_SITAR_height~STEROIDS+mat_ht+pat_ht+ga)
boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years <-
  lm(data=boys_optimum_single,
           formula=maximum_SITAR_growth_velocity_after_six_years~STEROIDS+mat_ht+pat_ht+ga)
boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years <-
  lm(data=boys_optimum_single,
           formula=age_at_maximum_SITAR_growth_velocity_after_six_years~STEROIDS+mat_ht+pat_ht+ga)
```

```{r, girls optimum prediction model}
girls_optimum_prediction_model_a <-
  lm(data=girls_optimum_single,
           formula=a~STEROIDS+mat_ht+pat_ht+ga)
girls_optimum_prediction_model_b <-
  lm(data=girls_optimum_single,
           formula=b~STEROIDS+mat_ht+pat_ht+ga)
girls_optimum_prediction_model_c <-
  lm(data=girls_optimum_single,
           formula=c~STEROIDS+mat_ht+pat_ht+ga)
girls_optimum_prediction_model_final_height <-
  lm(data=single_row_data_from_girls_with_raw_final_height,
           formula=final_height~STEROIDS+mat_ht+pat_ht+ga)
girls_optimum_prediction_model_final_SITAR_height <-
  lm(data=girls_optimum_single,
           formula=final_SITAR_height~STEROIDS+mat_ht+pat_ht+ga)
girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years <-
  lm(data=girls_optimum_single,
           formula=maximum_SITAR_growth_velocity_after_six_years~STEROIDS+mat_ht+pat_ht+ga)
girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years <-
  lm(data=girls_optimum_single,
           formula=age_at_maximum_SITAR_growth_velocity_after_six_years~STEROIDS+mat_ht+pat_ht+ga)
```

```{r, boys second optimum prediction models for sensitivity analysis second optimum referring to the second optimum sitar fit}
boys_second_optimum_prediction_model_a <-
  lm(data=boys_second_optimum_single,
           formula=a~STEROIDS+mat_ht+pat_ht+ga)
boys_second_optimum_prediction_model_b <-
  lm(data=boys_second_optimum_single,
           formula=b~STEROIDS+mat_ht+pat_ht+ga)
boys_second_optimum_prediction_model_c <-
  lm(data=boys_second_optimum_single,
           formula=c~STEROIDS+mat_ht+pat_ht+ga)
boys_second_optimum_prediction_model_final_height <-
  lm(data=single_row_data_from_boys_with_raw_final_height,
           formula=final_height~STEROIDS+mat_ht+pat_ht+ga)
boys_second_optimum_prediction_model_final_SITAR_height <-
  lm(data=boys_second_optimum_single,
           formula=final_SITAR_height~STEROIDS+mat_ht+pat_ht+ga)
boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years <-
  lm(data=boys_second_optimum_single,
           formula=maximum_SITAR_growth_velocity_after_six_years~STEROIDS+mat_ht+pat_ht+ga)
boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years <-
  lm(data=boys_second_optimum_single,
           formula=age_at_maximum_SITAR_growth_velocity_after_six_years~STEROIDS+mat_ht+pat_ht+ga)
```

****************************
Imputation of data and recreation of prediction models - boys
****************************

```{r, impute missing data with missforest for boys}
#first we just take out the columns we are interested in
boys_optimum_single_to_impute <-
  as.data.frame(
    boys_optimum_single[,c(
    "ga",
    "STEROIDS",
    "mat_ht",
    "pat_ht",
    "a",
    "b",
    "c",
    "final_height",
    "final_height_velocity",
    "age_at_final_height_velocity",
    "final_SITAR_height",
    "age_at_maximum_SITAR_growth_velocity_after_six_years",
    "maximum_SITAR_growth_velocity_after_six_years"
  )])
#only use final height if the final_height_velocity is <1 or the age is >18
boys_optimum_single_to_impute$final_height <-
  ifelse(boys_optimum_single_to_impute$final_height_velocity>=1 &
           boys_optimum_single_to_impute$age_at_final_height_velocity<18,
         NA,
         boys_optimum_single_to_impute$final_height
         )
#then get rid of the columns that we just use to define final height
boys_optimum_single_to_impute$final_height_velocity <- NULL
boys_optimum_single_to_impute$age_at_final_height_velocity <- NULL

#make sure the indicator variable is a factor
boys_optimum_single_to_impute$STEROIDS <-
  as.factor(boys_optimum_single_to_impute$STEROIDS)

#create a list of bootstrapped replications of the data
bootstrap_data_list_boys <- 
  as.list(NULL)
for (i in 1:500){
  data <- boys_optimum_single_to_impute[sample(1:nrow(boys_optimum_single_to_impute), replace=T),]
  bootstrap_data_list_boys[[length(bootstrap_data_list_boys)+1]] <- data
}

#create vectors to add each coefficient derived from bootstrapping to
intercept_boys_coefficient_vector_a <- vector()
steroid_boys_coefficient_vector_a <- vector()
ga_boys_coefficient_vector_a <- vector()
maternal_boys_coefficient_vector_a <- vector()
paternal_boys_coefficient_vector_a <- vector()
r2_boys_coefficient_vector_a <- vector()

intercept_boys_coefficient_vector_b <- vector()
steroid_boys_coefficient_vector_b <- vector()
ga_boys_coefficient_vector_b <- vector()
maternal_boys_coefficient_vector_b <- vector()
paternal_boys_coefficient_vector_b <- vector()
r2_boys_coefficient_vector_b <- vector()

intercept_boys_coefficient_vector_c <- vector()
steroid_boys_coefficient_vector_c <- vector()
ga_boys_coefficient_vector_c <- vector()
maternal_boys_coefficient_vector_c <- vector()
paternal_boys_coefficient_vector_c <- vector()
r2_boys_coefficient_vector_c <- vector()

intercept_boys_coefficient_vector_final_study_height <- vector()
steroid_boys_coefficient_vector_final_study_height <- vector()
ga_boys_coefficient_vector_final_study_height <- vector()
maternal_boys_coefficient_vector_final_study_height <- vector()
paternal_boys_coefficient_vector_final_study_height <- vector()
r2_boys_coefficient_vector_final_study_height <- vector()

intercept_boys_coefficient_vector_final_sitar_height <- vector()
steroid_boys_coefficient_vector_final_sitar_height <- vector()
ga_boys_coefficient_vector_final_sitar_height <- vector()
maternal_boys_coefficient_vector_final_sitar_height <- vector()
paternal_boys_coefficient_vector_final_sitar_height <- vector()
r2_boys_coefficient_vector_final_sitar_height <- vector()

intercept_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- vector()
steroid_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- vector()
ga_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- vector()
maternal_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- vector()
paternal_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- vector()
r2_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- vector()

intercept_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- vector()
steroid_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- vector()
ga_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- vector()
maternal_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- vector()
paternal_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- vector()
r2_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- vector()

for (i in 1:length(bootstrap_data_list_boys)){
  
imputed_data_frame_boys <- 
  missForest(bootstrap_data_list_boys[[i]], parallelize = 'no')$ximp

#assess outcome a
boys_model_a <- 
  summary(lm(data=imputed_data_frame_boys,
          formula=a~STEROIDS+mat_ht+pat_ht+ga))

intercept_boys_coefficient_vector_a <- 
  c(intercept_boys_coefficient_vector_a , (boys_model_a$coefficients["(Intercept)",][1]))
steroid_boys_coefficient_vector_a <- 
  c(steroid_boys_coefficient_vector_a , (boys_model_a$coefficients["STEROIDSyes",][1]))
ga_boys_coefficient_vector_a <- 
  c(ga_boys_coefficient_vector_a , (boys_model_a$coefficients["ga",][1]))
maternal_boys_coefficient_vector_a <- 
  c(maternal_boys_coefficient_vector_a , (boys_model_a$coefficients["mat_ht",][1]))
paternal_boys_coefficient_vector_a <- 
  c(paternal_boys_coefficient_vector_a , (boys_model_a$coefficients["pat_ht",][1]))
r2_boys_coefficient_vector_a <- 
  c(r2_boys_coefficient_vector_a , (boys_model_a$r.squared))

#assess outcome b
boys_model_b <- 
  summary(lm(data=imputed_data_frame_boys,
          formula=b~STEROIDS+mat_ht+pat_ht+ga))

intercept_boys_coefficient_vector_b <- 
  c(intercept_boys_coefficient_vector_b , (boys_model_b$coefficients["(Intercept)",][1]))
steroid_boys_coefficient_vector_b <- 
  c(steroid_boys_coefficient_vector_b , (boys_model_b$coefficients["STEROIDSyes",][1]))
ga_boys_coefficient_vector_b <- 
  c(ga_boys_coefficient_vector_b , (boys_model_b$coefficients["ga",][1]))
maternal_boys_coefficient_vector_b <- 
  c(maternal_boys_coefficient_vector_b , (boys_model_b$coefficients["mat_ht",][1]))
paternal_boys_coefficient_vector_b <- 
  c(paternal_boys_coefficient_vector_b , (boys_model_b$coefficients["pat_ht",][1]))
r2_boys_coefficient_vector_b <- 
  c(r2_boys_coefficient_vector_b , (boys_model_b$r.squared))

#assess outcome c
boys_model_c <- 
  summary(lm(data=imputed_data_frame_boys,
          formula=c~STEROIDS+mat_ht+pat_ht+ga))

intercept_boys_coefficient_vector_c <- 
  c(intercept_boys_coefficient_vector_c , (boys_model_c$coefficients["(Intercept)",][1]))
steroid_boys_coefficient_vector_c <- 
  c(steroid_boys_coefficient_vector_c , (boys_model_c$coefficients["STEROIDSyes",][1]))
ga_boys_coefficient_vector_c <- 
  c(ga_boys_coefficient_vector_c , (boys_model_c$coefficients["ga",][1]))
maternal_boys_coefficient_vector_c <- 
  c(maternal_boys_coefficient_vector_c , (boys_model_c$coefficients["mat_ht",][1]))
paternal_boys_coefficient_vector_c <- 
  c(paternal_boys_coefficient_vector_c , (boys_model_c$coefficients["pat_ht",][1]))
r2_boys_coefficient_vector_c <- 
  c(r2_boys_coefficient_vector_c , (boys_model_c$r.squared))

#assess outcome final_study_height
boys_model_final_study_height <- 
  summary(lm(data=imputed_data_frame_boys,
          formula=final_height~STEROIDS+mat_ht+pat_ht+ga))

intercept_boys_coefficient_vector_final_study_height <- 
  c(intercept_boys_coefficient_vector_final_study_height , (boys_model_final_study_height$coefficients["(Intercept)",][1]))
steroid_boys_coefficient_vector_final_study_height <- 
  c(steroid_boys_coefficient_vector_final_study_height , (boys_model_final_study_height$coefficients["STEROIDSyes",][1]))
ga_boys_coefficient_vector_final_study_height <- 
  c(ga_boys_coefficient_vector_final_study_height , (boys_model_final_study_height$coefficients["ga",][1]))
maternal_boys_coefficient_vector_final_study_height <- 
  c(maternal_boys_coefficient_vector_final_study_height , (boys_model_final_study_height$coefficients["mat_ht",][1]))
paternal_boys_coefficient_vector_final_study_height <- 
  c(paternal_boys_coefficient_vector_final_study_height , (boys_model_final_study_height$coefficients["pat_ht",][1]))
r2_boys_coefficient_vector_final_study_height <- 
  c(r2_boys_coefficient_vector_final_study_height , (boys_model_final_study_height$r.squared))

#assess outcome final_sitar_height
boys_model_final_sitar_height <- 
  summary(lm(data=imputed_data_frame_boys,
          formula=final_SITAR_height~STEROIDS+mat_ht+pat_ht+ga))

intercept_boys_coefficient_vector_final_sitar_height <- 
  c(steroid_boys_coefficient_vector_final_sitar_height , (boys_model_final_sitar_height$coefficients["(Intercept)",][1]))
steroid_boys_coefficient_vector_final_sitar_height <- 
  c(steroid_boys_coefficient_vector_final_sitar_height , (boys_model_final_sitar_height$coefficients["STEROIDSyes",][1]))
ga_boys_coefficient_vector_final_sitar_height <- 
  c(ga_boys_coefficient_vector_final_sitar_height , (boys_model_final_sitar_height$coefficients["ga",][1]))
maternal_boys_coefficient_vector_final_sitar_height <- 
  c(maternal_boys_coefficient_vector_final_sitar_height , (boys_model_final_sitar_height$coefficients["mat_ht",][1]))
paternal_boys_coefficient_vector_final_sitar_height <- 
  c(paternal_boys_coefficient_vector_final_sitar_height , (boys_model_final_sitar_height$coefficients["pat_ht",][1]))
r2_boys_coefficient_vector_final_sitar_height <- 
  c(r2_boys_coefficient_vector_final_sitar_height , (boys_model_final_sitar_height$r.squared))

#assess outcome maximum_SITAR_growth_velocity_after_six_years
boys_model_maximum_SITAR_growth_velocity_after_six_years <- 
  summary(lm(data=imputed_data_frame_boys,
          formula=maximum_SITAR_growth_velocity_after_six_years~STEROIDS+mat_ht+pat_ht+ga))

intercept_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- 
  c(intercept_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years , (boys_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["(Intercept)",][1]))
steroid_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- 
  c(steroid_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years , (boys_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["STEROIDSyes",][1]))
ga_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- 
  c(ga_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years , (boys_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["ga",][1]))
maternal_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- 
  c(maternal_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years , (boys_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["mat_ht",][1]))
paternal_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- 
  c(paternal_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years , (boys_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["pat_ht",][1]))
r2_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- 
  c(r2_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years , (boys_model_maximum_SITAR_growth_velocity_after_six_years$r.squared))


#assess outcome age_at_maximum_SITAR_growth_velocity_after_six_years
boys_model_age_at_maximum_SITAR_growth_velocity_after_six_years <- 
  summary(lm(data=imputed_data_frame_boys,
          formula=age_at_maximum_SITAR_growth_velocity_after_six_years~STEROIDS+mat_ht+pat_ht+ga))

intercept_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- 
  c(intercept_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years , (boys_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["(Intercept)",][1]))
steroid_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- 
  c(steroid_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years , (boys_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["STEROIDSyes",][1]))
ga_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- 
  c(ga_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years , (boys_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["ga",][1]))
maternal_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- 
  c(maternal_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years , (boys_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["mat_ht",][1]))
paternal_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- 
  c(paternal_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years , (boys_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["pat_ht",][1]))
r2_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- 
  c(r2_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years , (boys_model_age_at_maximum_SITAR_growth_velocity_after_six_years$r.squared))


}
```

for each vector we then take the mean and standard deviation to define the estimates as per rubins rules

```{r, define imputed bootstrapped estimates and error for outcome _final_study_height_}
#outcome_boys final_study_height
outcome_boys_final_study_height_intercept_estimate <- 
  mean(intercept_boys_coefficient_vector_final_study_height)
outcome_boys_final_study_height_intercept_sem <- 
  sd(intercept_boys_coefficient_vector_final_study_height)

outcome_boys_final_study_height_steroid_estimate <- 
  mean(steroid_boys_coefficient_vector_final_study_height)
outcome_boys_final_study_height_steroid_sem <- 
  sd(steroid_boys_coefficient_vector_final_study_height)

outcome_boys_final_study_height_ga_estimate <- 
  mean(ga_boys_coefficient_vector_final_study_height)
outcome_boys_final_study_height_ga_sem <- 
  sd(ga_boys_coefficient_vector_final_study_height)

outcome_boys_final_study_height_mat_ht_estimate <- 
  mean(maternal_boys_coefficient_vector_final_study_height)
outcome_boys_final_study_height_mat_ht_sem <- 
  sd(maternal_boys_coefficient_vector_final_study_height)

outcome_boys_final_study_height_pat_ht_estimate <- 
  mean(paternal_boys_coefficient_vector_final_study_height)
outcome_boys_final_study_height_pat_ht_sem <- 
  sd(paternal_boys_coefficient_vector_final_study_height)

outcome_boys_final_study_height_r2_estimate <- 
  mean(r2_boys_coefficient_vector_final_sitar_height)
outcome_boys_final_study_height_r2_sem <- 
  sd(r2_boys_coefficient_vector_final_sitar_height)
```

```{r, define imputed bootstrapped estimates and error for outcome_boys _a_}
#outcome_boys a
outcome_boys_a_intercept_estimate <- 
  mean(intercept_boys_coefficient_vector_a)
outcome_boys_a_intercept_sem <- 
  sd(intercept_boys_coefficient_vector_a)

outcome_boys_a_steroid_estimate <- 
  mean(steroid_boys_coefficient_vector_a)
outcome_boys_a_steroid_sem <- 
  sd(steroid_boys_coefficient_vector_a)

outcome_boys_a_ga_estimate <- 
  mean(ga_boys_coefficient_vector_a)
outcome_boys_a_ga_sem <- 
  sd(ga_boys_coefficient_vector_a)

outcome_boys_a_mat_ht_estimate <- 
  mean(maternal_boys_coefficient_vector_a)
outcome_boys_a_mat_ht_sem <- 
  sd(maternal_boys_coefficient_vector_a)

outcome_boys_a_pat_ht_estimate <- 
  mean(paternal_boys_coefficient_vector_a)
outcome_boys_a_pat_ht_sem <- 
  sd(paternal_boys_coefficient_vector_a)

outcome_boys_a_r2_estimate <- 
  mean(r2_boys_coefficient_vector_a)
outcome_boys_a_r2_sem <- 
  sd(r2_boys_coefficient_vector_a)
```

```{r, define imputed bootstrapped estimates and error for outcome_boys _b_}
#outcome_boys a
outcome_boys_b_intercept_estimate <- 
  mean(intercept_boys_coefficient_vector_b)
outcome_boys_b_intercept_sem <- 
  sd(intercept_boys_coefficient_vector_b)

outcome_boys_b_steroid_estimate <- 
  mean(steroid_boys_coefficient_vector_b)
outcome_boys_b_steroid_sem <- 
  sd(steroid_boys_coefficient_vector_b)

outcome_boys_b_ga_estimate <- 
  mean(ga_boys_coefficient_vector_b)
outcome_boys_b_ga_sem <- 
  sd(ga_boys_coefficient_vector_b)

outcome_boys_b_mat_ht_estimate <- 
  mean(maternal_boys_coefficient_vector_b)
outcome_boys_b_mat_ht_sem <- 
  sd(maternal_boys_coefficient_vector_b)

outcome_boys_b_pat_ht_estimate <- 
  mean(paternal_boys_coefficient_vector_b)
outcome_boys_b_pat_ht_sem <- 
  sd(paternal_boys_coefficient_vector_b)

outcome_boys_b_r2_estimate <- 
  mean(r2_boys_coefficient_vector_b)
outcome_boys_b_r2_sem <- 
  sd(r2_boys_coefficient_vector_b)
```

```{r, define imputed bootstrapped estimates and error for outcome_boys _c_}
#outcome_boys c
outcome_boys_c_intercept_estimate <- 
  mean(intercept_boys_coefficient_vector_c)
outcome_boys_c_intercept_sem <- 
  sd(intercept_boys_coefficient_vector_c)

outcome_boys_c_steroid_estimate <- 
  mean(steroid_boys_coefficient_vector_c)
outcome_boys_c_steroid_sem <- 
  sd(steroid_boys_coefficient_vector_c)

outcome_boys_c_ga_estimate <- 
  mean(ga_boys_coefficient_vector_c)
outcome_boys_c_ga_sem <- 
  sd(ga_boys_coefficient_vector_c)

outcome_boys_c_mat_ht_estimate <- 
  mean(maternal_boys_coefficient_vector_c)
outcome_boys_c_mat_ht_sem <- 
  sd(maternal_boys_coefficient_vector_c)

outcome_boys_c_pat_ht_estimate <- 
  mean(paternal_boys_coefficient_vector_c)
outcome_boys_c_pat_ht_sem <- 
  sd(paternal_boys_coefficient_vector_c)

outcome_boys_c_r2_estimate <- 
  mean(r2_boys_coefficient_vector_c)
outcome_boys_c_r2_sem <- 
  sd(r2_boys_coefficient_vector_c)
```

```{r, define imputed bootstrapped estimates and error for outcome_boys _final_sitar_height_}
#outcome_boys final_sitar_height
outcome_boys_final_sitar_height_intercept_estimate <- 
  mean(intercept_boys_coefficient_vector_final_sitar_height)
outcome_boys_final_sitar_height_intercept_sem <- 
  sd(intercept_boys_coefficient_vector_final_sitar_height)

outcome_boys_final_sitar_height_steroid_estimate <- 
  mean(steroid_boys_coefficient_vector_final_sitar_height)
outcome_boys_final_sitar_height_steroid_sem <- 
  sd(steroid_boys_coefficient_vector_final_sitar_height)

outcome_boys_final_sitar_height_ga_estimate <- 
  mean(ga_boys_coefficient_vector_final_sitar_height)
outcome_boys_final_sitar_height_ga_sem <- 
  sd(ga_boys_coefficient_vector_final_sitar_height)

outcome_boys_final_sitar_height_mat_ht_estimate <- 
  mean(maternal_boys_coefficient_vector_final_sitar_height)
outcome_boys_final_sitar_height_mat_ht_sem <- 
  sd(maternal_boys_coefficient_vector_final_sitar_height)

outcome_boys_final_sitar_height_pat_ht_estimate <- 
  mean(paternal_boys_coefficient_vector_final_sitar_height)
outcome_boys_final_sitar_height_pat_ht_sem <- 
  sd(paternal_boys_coefficient_vector_final_sitar_height)

outcome_boys_final_sitar_height_r2_estimate <- 
  mean(r2_boys_coefficient_vector_final_sitar_height)
outcome_boys_final_sitar_height_r2_sem <- 
  sd(r2_boys_coefficient_vector_final_sitar_height)
```

```{r, define imputed bootstrapped estimates and error for outcome_boys _maximum_SITAR_growth_velocity_after_six_years_}
#outcome_boys final_sitar_height
outcome_boys_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate <- 
  mean(intercept_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)
outcome_boys_maximum_SITAR_growth_velocity_after_six_years_intercept_sem <- 
  sd(intercept_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)

outcome_boys_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate <- 
  mean(steroid_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)
outcome_boys_maximum_SITAR_growth_velocity_after_six_years_steroid_sem <- 
  sd(steroid_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)

outcome_boys_maximum_SITAR_growth_velocity_after_six_years_ga_estimate <- 
  mean(ga_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)
outcome_boys_maximum_SITAR_growth_velocity_after_six_years_ga_sem <- 
  sd(ga_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)

outcome_boys_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate <- 
  mean(maternal_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)
outcome_boys_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem <- 
  sd(maternal_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)

outcome_boys_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate <- 
  mean(paternal_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)
outcome_boys_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem <- 
  sd(paternal_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)

outcome_boys_maximum_SITAR_growth_velocity_after_six_years_r2_estimate <- 
  mean(r2_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)
outcome_boys_maximum_SITAR_growth_velocity_after_six_years_r2_sem <- 
  sd(r2_boys_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)
```

```{r, define imputed bootstrapped estimates and error for outcome_boys age_at_maximum_SITAR_growth_velocity_after_six_years_}
#outcome_boys final_sitar_height
outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate <- 
  mean(intercept_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)
outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_intercept_sem <- 
  sd(intercept_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)

outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate <- 
  mean(steroid_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)
outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_sem <- 
  sd(steroid_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)

outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_estimate <- 
  mean(ga_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)
outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_sem <- 
  sd(ga_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)

outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate <- 
  mean(maternal_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)
outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem <- 
  sd(maternal_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)

outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate <- 
  mean(paternal_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)
outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem <- 
  sd(paternal_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)

outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_r2_estimate <- 
  mean(r2_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)
outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_r2_sem <- 
  sd(r2_boys_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)
```

****************************
Imputation of data and recreation of prediction models - girls
****************************

```{r, impute missing data with missforest for girls}
#first we just take out the columns we are interested in
girls_optimum_single_to_impute <-
  as.data.frame(
    girls_optimum_single[,c(
    "ga",
    "STEROIDS",
    "mat_ht",
    "pat_ht",
    "a",
    "b",
    "c",
    "final_height",
    "final_height_velocity",
    "age_at_final_height_velocity",
    "final_SITAR_height",
    "age_at_maximum_SITAR_growth_velocity_after_six_years",
    "maximum_SITAR_growth_velocity_after_six_years"
  )])
#only use final height if the final_height_velocity is <1 or the age is >18
girls_optimum_single_to_impute$final_height <-
  ifelse(girls_optimum_single_to_impute$final_height_velocity>=1 &
           girls_optimum_single_to_impute$age_at_final_height_velocity<18,
         NA,
         girls_optimum_single_to_impute$final_height
         )
#then get rid of the columns that we just use to define final height
girls_optimum_single_to_impute$final_height_velocity <- NULL
girls_optimum_single_to_impute$age_at_final_height_velocity <- NULL

#make sure the indicator variable is a factor
girls_optimum_single_to_impute$STEROIDS <-
  as.factor(girls_optimum_single_to_impute$STEROIDS)

#create a list of bootstrapped replications of the data
bootstrap_data_list_girls <- 
  as.list(NULL)
for (i in 1:500){
  data <- girls_optimum_single_to_impute[sample(1:nrow(girls_optimum_single_to_impute), replace=T),]
  bootstrap_data_list_girls[[length(bootstrap_data_list_girls)+1]] <- data
}

#create vectors to add each coefficient derived from bootstrapping to
intercept_girls_coefficient_vector_a <- vector()
steroid_girls_coefficient_vector_a <- vector()
ga_girls_coefficient_vector_a <- vector()
maternal_girls_coefficient_vector_a <- vector()
paternal_girls_coefficient_vector_a <- vector()
r2_girls_coefficient_vector_a <- vector()

intercept_girls_coefficient_vector_b <- vector()
steroid_girls_coefficient_vector_b <- vector()
ga_girls_coefficient_vector_b <- vector()
maternal_girls_coefficient_vector_b <- vector()
paternal_girls_coefficient_vector_b <- vector()
r2_girls_coefficient_vector_b <- vector()

intercept_girls_coefficient_vector_c <- vector()
steroid_girls_coefficient_vector_c <- vector()
ga_girls_coefficient_vector_c <- vector()
maternal_girls_coefficient_vector_c <- vector()
paternal_girls_coefficient_vector_c <- vector()
r2_girls_coefficient_vector_c <- vector()

intercept_girls_coefficient_vector_final_study_height <- vector()
steroid_girls_coefficient_vector_final_study_height <- vector()
ga_girls_coefficient_vector_final_study_height <- vector()
maternal_girls_coefficient_vector_final_study_height <- vector()
paternal_girls_coefficient_vector_final_study_height <- vector()
r2_girls_coefficient_vector_final_study_height <- vector()

intercept_girls_coefficient_vector_final_sitar_height <- vector()
steroid_girls_coefficient_vector_final_sitar_height <- vector()
ga_girls_coefficient_vector_final_sitar_height <- vector()
maternal_girls_coefficient_vector_final_sitar_height <- vector()
paternal_girls_coefficient_vector_final_sitar_height <- vector()
r2_girls_coefficient_vector_final_sitar_height <- vector()

intercept_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- vector()
steroid_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- vector()
ga_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- vector()
maternal_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- vector()
paternal_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- vector()
r2_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- vector()

intercept_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- vector()
steroid_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- vector()
ga_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- vector()
maternal_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- vector()
paternal_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- vector()
r2_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- vector()

for (i in 1:length(bootstrap_data_list_girls)){
  
imputed_data_frame_girls <- 
  missForest(bootstrap_data_list_girls[[i]], parallelize = 'no')$ximp

#assess outcome a
girls_model_a <- 
  summary(lm(data=imputed_data_frame_girls,
          formula=a~STEROIDS+mat_ht+pat_ht+ga))

intercept_girls_coefficient_vector_a <- 
  c(intercept_girls_coefficient_vector_a , (girls_model_a$coefficients["(Intercept)",][1]))
steroid_girls_coefficient_vector_a <- 
  c(steroid_girls_coefficient_vector_a , (girls_model_a$coefficients["STEROIDSyes",][1]))
ga_girls_coefficient_vector_a <- 
  c(ga_girls_coefficient_vector_a , (girls_model_a$coefficients["ga",][1]))
maternal_girls_coefficient_vector_a <- 
  c(maternal_girls_coefficient_vector_a , (girls_model_a$coefficients["mat_ht",][1]))
paternal_girls_coefficient_vector_a <- 
  c(paternal_girls_coefficient_vector_a , (girls_model_a$coefficients["pat_ht",][1]))
r2_girls_coefficient_vector_a <- 
  c(r2_girls_coefficient_vector_a , (girls_model_a$r.squared))

#assess outcome b
girls_model_b <- 
  summary(lm(data=imputed_data_frame_girls,
          formula=b~STEROIDS+mat_ht+pat_ht+ga))

intercept_girls_coefficient_vector_b <- 
  c(intercept_girls_coefficient_vector_b , (girls_model_b$coefficients["(Intercept)",][1]))
steroid_girls_coefficient_vector_b <- 
  c(steroid_girls_coefficient_vector_b , (girls_model_b$coefficients["STEROIDSyes",][1]))
ga_girls_coefficient_vector_b <- 
  c(ga_girls_coefficient_vector_b , (girls_model_b$coefficients["ga",][1]))
maternal_girls_coefficient_vector_b <- 
  c(maternal_girls_coefficient_vector_b , (girls_model_b$coefficients["mat_ht",][1]))
paternal_girls_coefficient_vector_b <- 
  c(paternal_girls_coefficient_vector_b , (girls_model_b$coefficients["pat_ht",][1]))
r2_girls_coefficient_vector_b <- 
  c(r2_girls_coefficient_vector_b , (girls_model_b$r.squared))

#assess outcome c
girls_model_c <- 
  summary(lm(data=imputed_data_frame_girls,
          formula=c~STEROIDS+mat_ht+pat_ht+ga))

intercept_girls_coefficient_vector_c <- 
  c(intercept_girls_coefficient_vector_c , (girls_model_c$coefficients["(Intercept)",][1]))
steroid_girls_coefficient_vector_c <- 
  c(steroid_girls_coefficient_vector_c , (girls_model_c$coefficients["STEROIDSyes",][1]))
ga_girls_coefficient_vector_c <- 
  c(ga_girls_coefficient_vector_c , (girls_model_c$coefficients["ga",][1]))
maternal_girls_coefficient_vector_c <- 
  c(maternal_girls_coefficient_vector_c , (girls_model_c$coefficients["mat_ht",][1]))
paternal_girls_coefficient_vector_c <- 
  c(paternal_girls_coefficient_vector_c , (girls_model_c$coefficients["pat_ht",][1]))
r2_girls_coefficient_vector_c <- 
  c(r2_girls_coefficient_vector_c , (girls_model_c$r.squared))

#assess outcome final_study_height
girls_model_final_study_height <- 
  summary(lm(data=imputed_data_frame_girls,
          formula=final_height~STEROIDS+mat_ht+pat_ht+ga))

intercept_girls_coefficient_vector_final_study_height <- 
  c(intercept_girls_coefficient_vector_final_study_height , (girls_model_final_study_height$coefficients["(Intercept)",][1]))
steroid_girls_coefficient_vector_final_study_height <- 
  c(steroid_girls_coefficient_vector_final_study_height , (girls_model_final_study_height$coefficients["STEROIDSyes",][1]))
ga_girls_coefficient_vector_final_study_height <- 
  c(ga_girls_coefficient_vector_final_study_height , (girls_model_final_study_height$coefficients["ga",][1]))
maternal_girls_coefficient_vector_final_study_height <- 
  c(maternal_girls_coefficient_vector_final_study_height , (girls_model_final_study_height$coefficients["mat_ht",][1]))
paternal_girls_coefficient_vector_final_study_height <- 
  c(paternal_girls_coefficient_vector_final_study_height , (girls_model_final_study_height$coefficients["pat_ht",][1]))
r2_girls_coefficient_vector_final_study_height <- 
  c(r2_girls_coefficient_vector_final_study_height , (girls_model_final_study_height$r.squared))

#assess outcome final_sitar_height
girls_model_final_sitar_height <- 
  summary(lm(data=imputed_data_frame_girls,
          formula=final_SITAR_height~STEROIDS+mat_ht+pat_ht+ga))

intercept_girls_coefficient_vector_final_sitar_height <- 
  c(steroid_girls_coefficient_vector_final_sitar_height , (girls_model_final_sitar_height$coefficients["(Intercept)",][1]))
steroid_girls_coefficient_vector_final_sitar_height <- 
  c(steroid_girls_coefficient_vector_final_sitar_height , (girls_model_final_sitar_height$coefficients["STEROIDSyes",][1]))
ga_girls_coefficient_vector_final_sitar_height <- 
  c(ga_girls_coefficient_vector_final_sitar_height , (girls_model_final_sitar_height$coefficients["ga",][1]))
maternal_girls_coefficient_vector_final_sitar_height <- 
  c(maternal_girls_coefficient_vector_final_sitar_height , (girls_model_final_sitar_height$coefficients["mat_ht",][1]))
paternal_girls_coefficient_vector_final_sitar_height <- 
  c(paternal_girls_coefficient_vector_final_sitar_height , (girls_model_final_sitar_height$coefficients["pat_ht",][1]))
r2_girls_coefficient_vector_final_sitar_height <- 
  c(r2_girls_coefficient_vector_final_sitar_height , (girls_model_final_sitar_height$r.squared))

#assess outcome maximum_SITAR_growth_velocity_after_six_years
girls_model_maximum_SITAR_growth_velocity_after_six_years <- 
  summary(lm(data=imputed_data_frame_girls,
          formula=maximum_SITAR_growth_velocity_after_six_years~STEROIDS+mat_ht+pat_ht+ga))

intercept_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- 
  c(intercept_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years , (girls_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["(Intercept)",][1]))
steroid_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- 
  c(steroid_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years , (girls_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["STEROIDSyes",][1]))
ga_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- 
  c(ga_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years , (girls_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["ga",][1]))
maternal_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- 
  c(maternal_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years , (girls_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["mat_ht",][1]))
paternal_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- 
  c(paternal_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years , (girls_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["pat_ht",][1]))
r2_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years <- 
  c(r2_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years , (girls_model_maximum_SITAR_growth_velocity_after_six_years$r.squared))


#assess outcome age_at_maximum_SITAR_growth_velocity_after_six_years
girls_model_age_at_maximum_SITAR_growth_velocity_after_six_years <- 
  summary(lm(data=imputed_data_frame_girls,
          formula=age_at_maximum_SITAR_growth_velocity_after_six_years~STEROIDS+mat_ht+pat_ht+ga))

intercept_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- 
  c(intercept_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years , (girls_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["(Intercept)",][1]))
steroid_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- 
  c(steroid_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years , (girls_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["STEROIDSyes",][1]))
ga_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- 
  c(ga_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years , (girls_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["ga",][1]))
maternal_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- 
  c(maternal_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years , (girls_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["mat_ht",][1]))
paternal_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- 
  c(paternal_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years , (girls_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["pat_ht",][1]))
r2_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years <- 
  c(r2_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years , (girls_model_age_at_maximum_SITAR_growth_velocity_after_six_years$r.squared))


}


```

for each vector we then take the mean and standard deviation to define the estimates as per rubins rules

```{r, define imputed bootstrapped estimates and error for outcome _final_study_height_}
#outcome_girls final_study_height
outcome_girls_final_study_height_intercept_estimate <- 
  mean(intercept_girls_coefficient_vector_final_study_height)
outcome_girls_final_study_height_intercept_sem <- 
  sd(intercept_girls_coefficient_vector_final_study_height)

outcome_girls_final_study_height_steroid_estimate <- 
  mean(steroid_girls_coefficient_vector_final_study_height)
outcome_girls_final_study_height_steroid_sem <- 
  sd(steroid_girls_coefficient_vector_final_study_height)

outcome_girls_final_study_height_ga_estimate <- 
  mean(ga_girls_coefficient_vector_final_study_height)
outcome_girls_final_study_height_ga_sem <- 
  sd(ga_girls_coefficient_vector_final_study_height)

outcome_girls_final_study_height_mat_ht_estimate <- 
  mean(maternal_girls_coefficient_vector_final_study_height)
outcome_girls_final_study_height_mat_ht_sem <- 
  sd(maternal_girls_coefficient_vector_final_study_height)

outcome_girls_final_study_height_pat_ht_estimate <- 
  mean(paternal_girls_coefficient_vector_final_study_height)
outcome_girls_final_study_height_pat_ht_sem <- 
  sd(paternal_girls_coefficient_vector_final_study_height)

outcome_girls_final_study_height_r2_estimate <- 
  mean(r2_girls_coefficient_vector_final_sitar_height)
outcome_girls_final_study_height_r2_sem <- 
  sd(r2_girls_coefficient_vector_final_sitar_height)
```

```{r, define imputed bootstrapped estimates and error for outcome_girls _a_}
#outcome_girls a
outcome_girls_a_intercept_estimate <- 
  mean(intercept_girls_coefficient_vector_a)
outcome_girls_a_intercept_sem <- 
  sd(intercept_girls_coefficient_vector_a)

outcome_girls_a_steroid_estimate <- 
  mean(steroid_girls_coefficient_vector_a)
outcome_girls_a_steroid_sem <- 
  sd(steroid_girls_coefficient_vector_a)

outcome_girls_a_ga_estimate <- 
  mean(ga_girls_coefficient_vector_a)
outcome_girls_a_ga_sem <- 
  sd(ga_girls_coefficient_vector_a)

outcome_girls_a_mat_ht_estimate <- 
  mean(maternal_girls_coefficient_vector_a)
outcome_girls_a_mat_ht_sem <- 
  sd(maternal_girls_coefficient_vector_a)

outcome_girls_a_pat_ht_estimate <- 
  mean(paternal_girls_coefficient_vector_a)
outcome_girls_a_pat_ht_sem <- 
  sd(paternal_girls_coefficient_vector_a)

outcome_girls_a_r2_estimate <- 
  mean(r2_girls_coefficient_vector_a)
outcome_girls_a_r2_sem <- 
  sd(r2_girls_coefficient_vector_a)
```

```{r, define imputed bootstrapped estimates and error for outcome_girls _b_}
#outcome_girls a
outcome_girls_b_intercept_estimate <- 
  mean(intercept_girls_coefficient_vector_b)
outcome_girls_b_intercept_sem <- 
  sd(intercept_girls_coefficient_vector_b)

outcome_girls_b_steroid_estimate <- 
  mean(steroid_girls_coefficient_vector_b)
outcome_girls_b_steroid_sem <- 
  sd(steroid_girls_coefficient_vector_b)

outcome_girls_b_ga_estimate <- 
  mean(ga_girls_coefficient_vector_b)
outcome_girls_b_ga_sem <- 
  sd(ga_girls_coefficient_vector_b)

outcome_girls_b_mat_ht_estimate <- 
  mean(maternal_girls_coefficient_vector_b)
outcome_girls_b_mat_ht_sem <- 
  sd(maternal_girls_coefficient_vector_b)

outcome_girls_b_pat_ht_estimate <- 
  mean(paternal_girls_coefficient_vector_b)
outcome_girls_b_pat_ht_sem <- 
  sd(paternal_girls_coefficient_vector_b)

outcome_girls_b_r2_estimate <- 
  mean(r2_girls_coefficient_vector_b)
outcome_girls_b_r2_sem <- 
  sd(r2_girls_coefficient_vector_b)
```

```{r, define imputed bootstrapped estimates and error for outcome_girls _c_}
#outcome_girls c
outcome_girls_c_intercept_estimate <- 
  mean(intercept_girls_coefficient_vector_c)
outcome_girls_c_intercept_sem <- 
  sd(intercept_girls_coefficient_vector_c)

outcome_girls_c_steroid_estimate <- 
  mean(steroid_girls_coefficient_vector_c)
outcome_girls_c_steroid_sem <- 
  sd(steroid_girls_coefficient_vector_c)

outcome_girls_c_ga_estimate <- 
  mean(ga_girls_coefficient_vector_c)
outcome_girls_c_ga_sem <- 
  sd(ga_girls_coefficient_vector_c)

outcome_girls_c_mat_ht_estimate <- 
  mean(maternal_girls_coefficient_vector_c)
outcome_girls_c_mat_ht_sem <- 
  sd(maternal_girls_coefficient_vector_c)

outcome_girls_c_pat_ht_estimate <- 
  mean(paternal_girls_coefficient_vector_c)
outcome_girls_c_pat_ht_sem <- 
  sd(paternal_girls_coefficient_vector_c)

outcome_girls_c_r2_estimate <- 
  mean(r2_girls_coefficient_vector_c)
outcome_girls_c_r2_sem <- 
  sd(r2_girls_coefficient_vector_c)
```

```{r, define imputed bootstrapped estimates and error for outcome_girls _final_sitar_height_}
#outcome_girls final_sitar_height
outcome_girls_final_sitar_height_intercept_estimate <- 
  mean(intercept_girls_coefficient_vector_final_sitar_height)
outcome_girls_final_sitar_height_intercept_sem <- 
  sd(intercept_girls_coefficient_vector_final_sitar_height)

outcome_girls_final_sitar_height_steroid_estimate <- 
  mean(steroid_girls_coefficient_vector_final_sitar_height)
outcome_girls_final_sitar_height_steroid_sem <- 
  sd(steroid_girls_coefficient_vector_final_sitar_height)

outcome_girls_final_sitar_height_ga_estimate <- 
  mean(ga_girls_coefficient_vector_final_sitar_height)
outcome_girls_final_sitar_height_ga_sem <- 
  sd(ga_girls_coefficient_vector_final_sitar_height)

outcome_girls_final_sitar_height_mat_ht_estimate <- 
  mean(maternal_girls_coefficient_vector_final_sitar_height)
outcome_girls_final_sitar_height_mat_ht_sem <- 
  sd(maternal_girls_coefficient_vector_final_sitar_height)

outcome_girls_final_sitar_height_pat_ht_estimate <- 
  mean(paternal_girls_coefficient_vector_final_sitar_height)
outcome_girls_final_sitar_height_pat_ht_sem <- 
  sd(paternal_girls_coefficient_vector_final_sitar_height)

outcome_girls_final_sitar_height_r2_estimate <- 
  mean(r2_girls_coefficient_vector_final_sitar_height)
outcome_girls_final_sitar_height_r2_sem <- 
  sd(r2_girls_coefficient_vector_final_sitar_height)
```

```{r, define imputed bootstrapped estimates and error for outcome_girls _maximum_SITAR_growth_velocity_after_six_years_}
#outcome_girls final_sitar_height
outcome_girls_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate <- 
  mean(intercept_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)
outcome_girls_maximum_SITAR_growth_velocity_after_six_years_intercept_sem <- 
  sd(intercept_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)

outcome_girls_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate <- 
  mean(steroid_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)
outcome_girls_maximum_SITAR_growth_velocity_after_six_years_steroid_sem <- 
  sd(steroid_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)

outcome_girls_maximum_SITAR_growth_velocity_after_six_years_ga_estimate <- 
  mean(ga_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)
outcome_girls_maximum_SITAR_growth_velocity_after_six_years_ga_sem <- 
  sd(ga_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)

outcome_girls_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate <- 
  mean(maternal_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)
outcome_girls_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem <- 
  sd(maternal_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)

outcome_girls_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate <- 
  mean(paternal_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)
outcome_girls_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem <- 
  sd(paternal_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)

outcome_girls_maximum_SITAR_growth_velocity_after_six_years_r2_estimate <- 
  mean(r2_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)
outcome_girls_maximum_SITAR_growth_velocity_after_six_years_r2_sem <- 
  sd(r2_girls_coefficient_vector_maximum_SITAR_growth_velocity_after_six_years)
```

```{r, define imputed bootstrapped estimates and error for outcome_girls age_at_maximum_SITAR_growth_velocity_after_six_years_}
#outcome_girls final_sitar_height
outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate <- 
  mean(intercept_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)
outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_intercept_sem <- 
  sd(intercept_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)

outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate <- 
  mean(steroid_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)
outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_sem <- 
  sd(steroid_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)

outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_estimate <- 
  mean(ga_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)
outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_sem <- 
  sd(ga_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)

outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate <- 
  mean(maternal_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)
outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem <- 
  sd(maternal_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)

outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate <- 
  mean(paternal_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)
outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem <- 
  sd(paternal_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)

outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_r2_estimate <- 
  mean(r2_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)
outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_r2_sem <- 
  sd(r2_girls_coefficient_vector_age_at_maximum_SITAR_growth_velocity_after_six_years)
```

#################
table 3 for paper - the multivariable models in both sexes
#################

```{r, establish decimal places for table 3}
table_3_dp_estimate <- 3
table_3_dp_std_error <- 3
table_3_dp_r_squared <- 3
table_3_dp_p_value <- 5
```

```{r, constructing table 3 column 1}
table_3_column_1 <-
  data.frame(
    table_3_column_1 = c(
      "Boys",             #row 1
      
      "Dependent Variable:",             #row 2
      
      "Raw data:",             #row 3
      
      "Final study height (cm)*",             #row 4
      
      "Metrics calculated from SITAR modelling:",             #row 5
      
      "Height at 18.5 years (cm)",             #row 6
      
      "Peak pubertal height velocity (cm/year)",             #row 7
      
      "Age at peak pubertal height velocity (years)",             #row 8
      
      "SITAR model patient level random effects",             #row 9
      
      "a: \"Size\"",             #row 10
      
      "b: \"Timing\"",             #row 11
      
      "c: \"Velocity\"",             #row 12
      
      "Girls",             #row 13
      
      "Dependent Variable:",             #row 14
      
      "Raw data:",             #row 15
      
      "Final study height (cm)*",             #row 16
      
      "Metrics calculated from SITAR modelling:",            #row 17
      
      "Height at 18.5 years (cm)",             #row 18
      
      "Peak pubertal height velocity (cm/year)",             #row 19
      
      "Age at peak pubertal height velocity (years)",             #row 20
      
      "SITAR model patient level random effects",             #row 21
      
      "a: \"Size\"",             #row 22
      
      "b: \"Timing\"",             #row 23
      
      "c: \"Velocity\""             #row 24
      

    )
    )
```

```{r, constructing table 3 column 2}
table_3_column_2 <-
  data.frame(
    table_3_column_2 = c(
      " ",             #row 1
      
      " ",             #row 2
      
      "Intercept",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_final_height$coefficients["(Intercept)"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_final_height)$coefficients["(Intercept)", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_final_height)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_final_SITAR_height$coefficients["(Intercept)"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_final_SITAR_height)$coefficients["(Intercept)", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_final_SITAR_height)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["(Intercept)"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["(Intercept)", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["(Intercept)"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["(Intercept)", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_a$coefficients["(Intercept)"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_a)$coefficients["(Intercept)", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_a)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_b$coefficients["(Intercept)"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_b)$coefficients["(Intercept)", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_b)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_c$coefficients["(Intercept)"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_c)$coefficients["(Intercept)", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_c)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      " ",             #row 13
      
      " ",           #row 14
      
      "Intercept",             #row 15
      
      #row 16 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_final_height$coefficients["(Intercept)"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_final_height)$coefficients["(Intercept)", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_final_height)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 17 next is empty
      " ",
      
      #row 18 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_final_SITAR_height$coefficients["(Intercept)"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_final_SITAR_height)$coefficients["(Intercept)", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_final_SITAR_height)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 19 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["(Intercept)"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["(Intercept)", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 20 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["(Intercept)"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["(Intercept)", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 21 next is empty:
      " ",
      
      #row 22 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_a$coefficients["(Intercept)"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_a)$coefficients["(Intercept)", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_a)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 23 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_b$coefficients["(Intercept)"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_b)$coefficients["(Intercept)", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_b)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 24 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_c$coefficients["(Intercept)"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_c)$coefficients["(Intercept)", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_c)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        )
      

    )
  )
  
```

```{r, constructing table 3 column 3}
table_3_column_3 <-
  data.frame(
    table_3_column_3 = c(
      " ",             #row 1
      
      "Independent Variables: Estimate (SEM) p-value",             #row 2
      
      "Exposure to antenatal steroids: Yes",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_final_height$coefficients["STEROIDSyes"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_final_height)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_final_height)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_final_SITAR_height$coefficients["STEROIDSyes"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_final_SITAR_height)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_final_SITAR_height)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["STEROIDSyes"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["STEROIDSyes"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_a$coefficients["STEROIDSyes"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_a)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_a)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_b$coefficients["STEROIDSyes"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_b)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_b)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_c$coefficients["STEROIDSyes"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_c)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_c)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      " ",             #row 13
      
      "Independent Variables: Estimate (SEM) p-value",           #row 14
      
      "Exposure to antenatal steroids: Yes",             #row 15
      
      #row 16 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_final_height$coefficients["STEROIDSyes"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_final_height)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_final_height)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 17 next is empty
      " ",
      
      #row 18 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_final_SITAR_height$coefficients["STEROIDSyes"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_final_SITAR_height)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_final_SITAR_height)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 19 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["STEROIDSyes"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 20 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["STEROIDSyes"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 21 next is empty:
      " ",
      
      #row 22 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_a$coefficients["STEROIDSyes"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_a)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_a)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 23 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_b$coefficients["STEROIDSyes"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_b)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_b)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 24 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_c$coefficients["STEROIDSyes"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_c)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_c)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        )
      

    )
  )
  
```

```{r, constructing table 3 column 4}
table_3_column_4 <-
  data.frame(
    table_3_column_4 = c(
      " ",             #row 1
      
      " ",             #row 2
      
      "GA at delivery\n(weeks)",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_final_height$coefficients["ga"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_final_height)$coefficients["ga", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_final_height)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_final_SITAR_height$coefficients["ga"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_final_SITAR_height)$coefficients["ga", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_final_SITAR_height)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["ga"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["ga", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["ga"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["ga", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_a$coefficients["ga"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_a)$coefficients["ga", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_a)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_b$coefficients["ga"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_b)$coefficients["ga", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_b)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_c$coefficients["ga"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_c)$coefficients["ga", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_c)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      " ",             #row 13
      
      " ",           #row 14
      
      "GA at delivery\n(weeks)",             #row 15
      
      #row 16 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_final_height$coefficients["ga"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_final_height)$coefficients["ga", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_final_height)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 17 next is empty
      " ",
      
      #row 18 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_final_SITAR_height$coefficients["ga"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_final_SITAR_height)$coefficients["ga", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_final_SITAR_height)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 19 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["ga"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["ga", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 20 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["ga"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["ga", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 21 next is empty:
      " ",
      
      #row 22 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_a$coefficients["ga"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_a)$coefficients["ga", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_a)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 23 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_b$coefficients["ga"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_b)$coefficients["ga", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_b)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 24 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_c$coefficients["ga"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_c)$coefficients["ga", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_c)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        )
      

    )
  )
  
```

```{r, constructing table 3 column 5}
table_3_column_5 <-
  data.frame(
    table_3_column_5 = c(
      " ",             #row 1
      
      " ",             #row 2
      
      "Maternal Height\n(cm)",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_final_height$coefficients["mat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_final_height)$coefficients["mat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_final_height)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_final_SITAR_height$coefficients["mat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_final_SITAR_height)$coefficients["mat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_final_SITAR_height)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["mat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["mat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["mat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["mat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_a$coefficients["mat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_a)$coefficients["mat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_a)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_b$coefficients["mat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_b)$coefficients["mat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_b)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_c$coefficients["mat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_c)$coefficients["mat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_c)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      " ",             #row 13
      
      " ",           #row 14
      
      "Maternal Height\n(cm)",             #row 15
      
      #row 16 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_final_height$coefficients["mat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_final_height)$coefficients["mat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_final_height)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 17 next is empty
      " ",
      
      #row 18 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_final_SITAR_height$coefficients["mat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_final_SITAR_height)$coefficients["mat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_final_SITAR_height)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 19 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["mat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["mat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 20 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["mat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["mat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 21 next is empty:
      " ",
      
      #row 22 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_a$coefficients["mat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_a)$coefficients["mat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_a)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 23 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_b$coefficients["mat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_b)$coefficients["mat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_b)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 24 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_c$coefficients["mat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_c)$coefficients["mat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_c)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        )
      

    )
  )
  
```

```{r, constructing table 3 column 6}
table_3_column_6 <-
  data.frame(
    table_3_column_6 = c(
      " ",             #row 1
      
      " ",             #row 2
      
      "Paternal Height\n(cm)",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_final_height$coefficients["pat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_final_height)$coefficients["pat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_final_height)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_final_SITAR_height$coefficients["pat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_final_SITAR_height)$coefficients["pat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_final_SITAR_height)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["pat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["pat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["pat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["pat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_a$coefficients["pat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_a)$coefficients["pat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_a)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_b$coefficients["pat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_b)$coefficients["pat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_b)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_optimum_prediction_model_c$coefficients["pat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_optimum_prediction_model_c)$coefficients["pat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_optimum_prediction_model_c)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      " ",             #row 13
      
      " ",           #row 14
      
      "Paternal Height\n(cm)",             #row 15
      
      #row 16 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_final_height$coefficients["pat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_final_height)$coefficients["pat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_final_height)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 17 next is empty
      " ",
      
      #row 18 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_final_SITAR_height$coefficients["pat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_final_SITAR_height)$coefficients["pat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_final_SITAR_height)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 19 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["pat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["pat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 20 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["pat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["pat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 21 next is empty:
      " ",
      
      #row 22 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_a$coefficients["pat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_a)$coefficients["pat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_a)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 23 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_b$coefficients["pat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_b)$coefficients["pat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_b)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 24 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(girls_optimum_prediction_model_c$coefficients["pat_ht"]),
        digits=table_3_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(girls_optimum_prediction_model_c)$coefficients["pat_ht", "Std. Error"],
        digits=table_3_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(girls_optimum_prediction_model_c)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        )
      

    )
  )
  
```

```{r, constructing table 3 column 7}
#column 6 gives us the number in the model
table_3_column_7 <-
  data.frame(
    table_3_column_7 = c(
      " ",             #row 1
      
      "n in model\n(patients)",             #row 2
      
      " ",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the number in the model:
        nrow(boys_optimum_prediction_model_final_height$model)),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the number in the model:
        
        nrow(boys_optimum_prediction_model_final_SITAR_height$model)

        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the number in the model:
        
        nrow(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$model)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the number in the model:
        
        nrow(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$model)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the number in the model:
        
        nrow(boys_optimum_prediction_model_a$model)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the number in the model:
        
        nrow(boys_optimum_prediction_model_b$model)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the number in the model:
        
        nrow(boys_optimum_prediction_model_c$model)
        ),
      
      " ",             #row 13
      
      "n in model\n(patients)",           #row 14
      
      " ",             #row 15
      
      #row 16 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the number in the model:
        
        nrow(girls_optimum_prediction_model_final_height$model)
        ),
      
      #row 17 next is empty
      " ",
      
      #row 18 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the number in the model:
        
        nrow(girls_optimum_prediction_model_final_SITAR_height$model)
        ),
      
      #row 19 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the number in the model:
        
        nrow(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$model)
        ),
      
      #row 20 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the number in the model:
        
        nrow(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$model)
        ),
      
      #row 21 next is empty:
      " ",
      
      #row 22 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the number in the model:
        
        nrow(girls_optimum_prediction_model_a$model)
        ),
      
      #row 23 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the number in the model:
        
        nrow(girls_optimum_prediction_model_b$model)
        ),
      
      #row 24 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the number in the model:
        
        nrow(girls_optimum_prediction_model_c$model)
        )
      

    )
  )
  
```

```{r, constructing table 3 column 8}
table_3_column_8 <-
  data.frame(
    table_3_column_8 = c(
      
      " ",             #row 1
      
      "Model fit\nR²\np-value",             #row 2
      
      " ",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
          summary(boys_optimum_prediction_model_final_height)$r.squared,
        digits=table_3_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(boys_optimum_prediction_model_final_height)$fstatistic[1], 
              summary(boys_optimum_prediction_model_final_height)$fstatistic[2], 
              summary(boys_optimum_prediction_model_final_height)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_3_dp_p_value)
        ),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
          summary(boys_optimum_prediction_model_final_SITAR_height)$r.squared,
        digits=table_3_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(boys_optimum_prediction_model_final_SITAR_height)$fstatistic[1], 
              summary(boys_optimum_prediction_model_final_SITAR_height)$fstatistic[2], 
              summary(boys_optimum_prediction_model_final_SITAR_height)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_3_dp_p_value)
        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
          summary(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$r.squared,
        digits=table_3_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(boys_optimum_prediction_model_final_SITAR_height)$fstatistic[1], 
              summary(boys_optimum_prediction_model_final_SITAR_height)$fstatistic[2], 
              summary(boys_optimum_prediction_model_final_SITAR_height)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_3_dp_p_value)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
            paste0(
        #put in the estimate:
        round(
          summary(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$r.squared,
        digits=table_3_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$fstatistic[1], 
              summary(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$fstatistic[2], 
              summary(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_3_dp_p_value)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
          paste0(
        #put in the estimate:
        round(
          summary(boys_optimum_prediction_model_a)$r.squared,
        digits=table_3_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(boys_optimum_prediction_model_a)$fstatistic[1], 
              summary(boys_optimum_prediction_model_a)$fstatistic[2], 
              summary(boys_optimum_prediction_model_a)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_3_dp_p_value)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
        paste0(
        #put in the estimate:
        round(
          summary(boys_optimum_prediction_model_b)$r.squared,
        digits=table_3_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(boys_optimum_prediction_model_b)$fstatistic[1], 
              summary(boys_optimum_prediction_model_b)$fstatistic[2], 
              summary(boys_optimum_prediction_model_b)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_3_dp_p_value)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
     paste0(
        #put in the estimate:
        round(
          summary(boys_optimum_prediction_model_c)$r.squared,
        digits=table_3_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(boys_optimum_prediction_model_c)$fstatistic[1], 
              summary(boys_optimum_prediction_model_c)$fstatistic[2], 
              summary(boys_optimum_prediction_model_c)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_3_dp_p_value)
        ),
      
      " ",             #row 13
      
      "Model fit\nR²\np-value",           #row 14
      
      " ",             #row 15
      
      #row 16 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
          summary(girls_optimum_prediction_model_final_height)$r.squared,
        digits=table_3_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(girls_optimum_prediction_model_final_height)$fstatistic[1], 
              summary(girls_optimum_prediction_model_final_height)$fstatistic[2], 
              summary(girls_optimum_prediction_model_final_height)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_3_dp_p_value)
        ),
      
            #row 17 next is empty
      " ",
      
      #row 18 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
          summary(girls_optimum_prediction_model_final_SITAR_height)$r.squared,
        digits=table_3_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(girls_optimum_prediction_model_final_SITAR_height)$fstatistic[1], 
              summary(girls_optimum_prediction_model_final_SITAR_height)$fstatistic[2], 
              summary(girls_optimum_prediction_model_final_SITAR_height)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_3_dp_p_value)
        ),
      
      #row 19 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
          summary(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$r.squared,
        digits=table_3_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(girls_optimum_prediction_model_final_SITAR_height)$fstatistic[1], 
              summary(girls_optimum_prediction_model_final_SITAR_height)$fstatistic[2], 
              summary(girls_optimum_prediction_model_final_SITAR_height)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_3_dp_p_value)
        ),
      
      #row 20 next pertaining to outcome variable age at peak pubertal height velocity:
            paste0(
        #put in the estimate:
        round(
          summary(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$r.squared,
        digits=table_3_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$fstatistic[1], 
              summary(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$fstatistic[2], 
              summary(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_3_dp_p_value)
        ),
      
      #row 21 next is empty:
      " ",
      
      #row 22 next pertaining to outcome variable SITAR a size:
          paste0(
        #put in the estimate:
        round(
          summary(girls_optimum_prediction_model_a)$r.squared,
        digits=table_3_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(girls_optimum_prediction_model_a)$fstatistic[1], 
              summary(girls_optimum_prediction_model_a)$fstatistic[2], 
              summary(girls_optimum_prediction_model_a)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_3_dp_p_value)
        ),
      
      #row 23 next pertaining to outcome variable SITAR b timing:
        paste0(
        #put in the estimate:
        round(
          summary(girls_optimum_prediction_model_b)$r.squared,
        digits=table_3_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(girls_optimum_prediction_model_b)$fstatistic[1], 
              summary(girls_optimum_prediction_model_b)$fstatistic[2], 
              summary(girls_optimum_prediction_model_b)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_3_dp_p_value)
        ),
      
      #row 24 next pertaining to outcome variable SITAR c velocity:
     paste0(
        #put in the estimate:
        round(
          summary(girls_optimum_prediction_model_c)$r.squared,
        digits=table_3_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(girls_optimum_prediction_model_c)$fstatistic[1], 
              summary(girls_optimum_prediction_model_c)$fstatistic[2], 
              summary(girls_optimum_prediction_model_c)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_3_dp_p_value)
        )
      

    )
  )
  
```

```{r, binding together columns of table 3 for paper}
table_3 <- cbind(
  table_3_column_1,
  table_3_column_2,
  table_3_column_3,
  table_3_column_4,
  table_3_column_5,
  table_3_column_6,
  table_3_column_7,
  table_3_column_8
)

write.csv(table_3, "table_3.csv", row.names = F)
```

```{r, print table 3 to a word document}
ft <- flextable(table_3) #will have to make it landscape manually as I couldn't figure out how to do that
  
  # Customize the table appearance
  ft <- ft %>%
    theme_vanilla() %>%
    align(align = "center", part = "header") %>%
    align(align = "center", part = "body") %>%  
    autofit()
  
  # Define paragraph formatting with centered alignment
  centered_paragraph <- 
    fp_par(text.align = "center")
  
  doc <- read_docx() %>%
    body_add_flextable(ft) 
  
  print(doc, target = file.path(paste0("table_3", ".docx")))
```

#################
table 5 for appendix of paper - the multivariable models in both sexes with imputed data
#################

```{r, establish decimal places for table 5}
table_5_dp_estimate <- 3
table_5_dp_std_error <- 3
table_5_dp_r_squared <- 3
table_5_dp_p_value <- 5
```

```{r, constructing table 5 column 1}
table_5_column_1 <-
  data.frame(
    table_5_column_1 = c(
      "Boys",             #row 1
      
      "Dependent Variable:",             #row 2
      
      "Raw data:",             #row 3
      
      "Final study height (cm)*",             #row 4
      
      "Metrics calculated from SITAR modelling:",             #row 5
      
      "Height at 18.5 years (cm)",             #row 6
      
      "Peak pubertal height velocity (cm/year)",             #row 7
      
      "Age at peak pubertal height velocity (years)",             #row 8
      
      "SITAR model patient level random effects",             #row 9
      
      "a: \"Size\"",             #row 10
      
      "b: \"Timing\"",             #row 11
      
      "c: \"Velocity\"",             #row 12
      
      "Girls",             #row 13
      
      "Dependent Variable:",             #row 14
      
      "Raw data:",             #row 15
      
      "Final study height (cm)*",             #row 16
      
      "Metrics calculated from SITAR modelling:",            #row 17
      
      "Height at 18.5 years (cm)",             #row 18
      
      "Peak pubertal height velocity (cm/year)",             #row 19
      
      "Age at peak pubertal height velocity (years)",             #row 20
      
      "SITAR model patient level random effects",             #row 21
      
      "a: \"Size\"",             #row 22
      
      "b: \"Timing\"",             #row 23
      
      "c: \"Velocity\""             #row 24
      

    )
    )
```

```{r, constructing table 5 column 2}
table_5_column_2 <-
  data.frame(
    table_5_column_2 = c(
      " ",             #row 1
      
      " ",             #row 2
      
      "Intercept",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_final_study_height_intercept_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_final_study_height_intercept_estimate - 
            outcome_boys_final_study_height_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_final_study_height_intercept_estimate + 
            outcome_boys_final_study_height_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_final_sitar_height_intercept_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_final_sitar_height_intercept_estimate - 
            outcome_boys_final_sitar_height_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_final_sitar_height_intercept_estimate + 
            outcome_boys_final_sitar_height_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate - 
            outcome_boys_maximum_SITAR_growth_velocity_after_six_years_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate + 
            outcome_boys_maximum_SITAR_growth_velocity_after_six_years_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate - 
            outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate + 
            outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_a_intercept_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_a_intercept_estimate - 
            outcome_boys_a_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_a_intercept_estimate + 
            outcome_boys_a_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_b_intercept_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_b_intercept_estimate - 
            outcome_boys_b_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_b_intercept_estimate + 
            outcome_boys_b_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_c_intercept_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_c_intercept_estimate - 
            outcome_boys_c_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_c_intercept_estimate + 
            outcome_boys_c_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      " ",             #row 13
      
      " ",           #row 14
      
      "Intercept",           #row 15  
      
      #row 16 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_final_study_height_intercept_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_final_study_height_intercept_estimate - 
            outcome_girls_final_study_height_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_final_study_height_intercept_estimate + 
            outcome_girls_final_study_height_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 17 next is empty
      " ",
      
      #row 18 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_final_sitar_height_intercept_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_final_sitar_height_intercept_estimate - 
            outcome_girls_final_sitar_height_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_final_sitar_height_intercept_estimate + 
            outcome_girls_final_sitar_height_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 19 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate - 
            outcome_girls_maximum_SITAR_growth_velocity_after_six_years_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate + 
            outcome_girls_maximum_SITAR_growth_velocity_after_six_years_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 20 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate - 
            outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_intercept_estimate + 
            outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 21 next is empty:
      " ",
      
      #row 22 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_a_intercept_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_a_intercept_estimate - 
            outcome_girls_a_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_a_intercept_estimate + 
            outcome_girls_a_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 23 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_b_intercept_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_b_intercept_estimate - 
            outcome_girls_b_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_b_intercept_estimate + 
            outcome_girls_b_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 24 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_c_intercept_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_c_intercept_estimate - 
            outcome_girls_c_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_c_intercept_estimate + 
            outcome_girls_c_intercept_sem * 1.96),
        digits=table_5_dp_std_error),
        ")")
      

    )
  )
  
```

```{r, constructing table 5 column 3}
table_5_column_3 <-
  data.frame(
    table_5_column_3 = c(
      " ",             #row 1
      
      "Independent Variables: Estimate (95% Confidence Interval)",             #row 2
      
      "Exposure to antenatal steroids: Yes",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_final_study_height_steroid_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_final_study_height_steroid_estimate - 
            outcome_boys_final_study_height_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_final_study_height_steroid_estimate + 
            outcome_boys_final_study_height_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_final_sitar_height_steroid_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_final_sitar_height_steroid_estimate - 
            outcome_boys_final_sitar_height_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_final_sitar_height_steroid_estimate + 
            outcome_boys_final_sitar_height_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate - 
            outcome_boys_maximum_SITAR_growth_velocity_after_six_years_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate + 
            outcome_boys_maximum_SITAR_growth_velocity_after_six_years_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate - 
            outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate + 
            outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_a_steroid_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_a_steroid_estimate - 
            outcome_boys_a_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_a_steroid_estimate + 
            outcome_boys_a_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_b_steroid_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_b_steroid_estimate - 
            outcome_boys_b_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_b_steroid_estimate + 
            outcome_boys_b_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_c_steroid_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_c_steroid_estimate - 
            outcome_boys_c_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_c_steroid_estimate + 
            outcome_boys_c_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      " ",             #row 13
      
      "Independent Variables: Estimate (95% Confidence Interval)",             #row 14
      
      "Exposure to antenatal steroids: Yes",             #row 15
      
      #row 16 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_final_study_height_steroid_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_final_study_height_steroid_estimate - 
            outcome_girls_final_study_height_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_final_study_height_steroid_estimate + 
            outcome_girls_final_study_height_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 17 next is empty
      " ",
      
      #row 18 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_final_sitar_height_steroid_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_final_sitar_height_steroid_estimate - 
            outcome_girls_final_sitar_height_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_final_sitar_height_steroid_estimate + 
            outcome_girls_final_sitar_height_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 19 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate - 
            outcome_girls_maximum_SITAR_growth_velocity_after_six_years_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate + 
            outcome_girls_maximum_SITAR_growth_velocity_after_six_years_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 20 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate - 
            outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate + 
            outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 21 next is empty:
      " ",
      
      #row 22 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_a_steroid_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_a_steroid_estimate - 
            outcome_girls_a_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_a_steroid_estimate + 
            outcome_girls_a_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 23 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_b_steroid_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_b_steroid_estimate - 
            outcome_girls_b_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_b_steroid_estimate + 
            outcome_girls_b_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 24 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_c_steroid_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_c_steroid_estimate - 
            outcome_girls_c_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_c_steroid_estimate + 
            outcome_girls_c_steroid_sem * 1.96),
        digits=table_5_dp_std_error),
        ")")
      

    )
  )
  
```

```{r, constructing table 5 column 4}
table_5_column_4 <-
  data.frame(
    table_5_column_4 = c(
      " ",             #row 1
      
      " ",             #row 2
      
      "GA at delivery\n(weeks)",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_final_study_height_ga_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_final_study_height_ga_estimate - 
            outcome_boys_final_study_height_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_final_study_height_ga_estimate + 
            outcome_boys_final_study_height_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_final_sitar_height_ga_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_final_sitar_height_ga_estimate - 
            outcome_boys_final_sitar_height_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_final_sitar_height_ga_estimate + 
            outcome_boys_final_sitar_height_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_maximum_SITAR_growth_velocity_after_six_years_ga_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_maximum_SITAR_growth_velocity_after_six_years_ga_estimate - 
            outcome_boys_maximum_SITAR_growth_velocity_after_six_years_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_maximum_SITAR_growth_velocity_after_six_years_ga_estimate + 
            outcome_boys_maximum_SITAR_growth_velocity_after_six_years_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_estimate - 
            outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_estimate + 
            outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_a_ga_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_a_ga_estimate - 
            outcome_boys_a_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_a_ga_estimate + 
            outcome_boys_a_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_b_ga_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_b_ga_estimate - 
            outcome_boys_b_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_b_ga_estimate + 
            outcome_boys_b_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_c_ga_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_c_ga_estimate - 
            outcome_boys_c_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_c_ga_estimate + 
            outcome_boys_c_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      " ",             #row 13
      
      " ",             #row 14
      
      "GA at delivery\n(weeks)",             #row 15
      
      #row 16 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_final_study_height_ga_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_final_study_height_ga_estimate - 
            outcome_girls_final_study_height_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_final_study_height_ga_estimate + 
            outcome_girls_final_study_height_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 17 next is empty
      " ",
      
      #row 18 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_final_sitar_height_ga_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_final_sitar_height_ga_estimate - 
            outcome_girls_final_sitar_height_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_final_sitar_height_ga_estimate + 
            outcome_girls_final_sitar_height_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 19 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_maximum_SITAR_growth_velocity_after_six_years_ga_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_maximum_SITAR_growth_velocity_after_six_years_ga_estimate - 
            outcome_girls_maximum_SITAR_growth_velocity_after_six_years_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_maximum_SITAR_growth_velocity_after_six_years_ga_estimate + 
            outcome_girls_maximum_SITAR_growth_velocity_after_six_years_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 20 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_estimate - 
            outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_estimate + 
            outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 21 next is empty:
      " ",
      
      #row 22 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_a_ga_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_a_ga_estimate - 
            outcome_girls_a_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_a_ga_estimate + 
            outcome_girls_a_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 23 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_b_ga_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_b_ga_estimate - 
            outcome_girls_b_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_b_ga_estimate + 
            outcome_girls_b_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 24 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_c_ga_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_c_ga_estimate - 
            outcome_girls_c_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_c_ga_estimate + 
            outcome_girls_c_ga_sem * 1.96),
        digits=table_5_dp_std_error),
        ")")
      

    )
  )
  
```

```{r, constructing table 5 column 5}
table_5_column_5 <-
  data.frame(
    table_5_column_5 = c(
      " ",             #row 1
      
      " ",             #row 2
      
      "Maternal Height\n(cm)",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_final_study_height_mat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_final_study_height_mat_ht_estimate - 
            outcome_boys_final_study_height_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_final_study_height_mat_ht_estimate + 
            outcome_boys_final_study_height_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_final_sitar_height_mat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_final_sitar_height_mat_ht_estimate - 
            outcome_boys_final_sitar_height_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_final_sitar_height_mat_ht_estimate + 
            outcome_boys_final_sitar_height_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate - 
            outcome_boys_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate + 
            outcome_boys_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate - 
            outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate + 
            outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_a_mat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_a_mat_ht_estimate - 
            outcome_boys_a_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_a_mat_ht_estimate + 
            outcome_boys_a_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_b_mat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_b_mat_ht_estimate - 
            outcome_boys_b_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_b_mat_ht_estimate + 
            outcome_boys_b_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_c_mat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_c_mat_ht_estimate - 
            outcome_boys_c_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_c_mat_ht_estimate + 
            outcome_boys_c_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      " ",             #row 13
      
      " ",             #row 14
      
      "Maternal Height\n(cm)",             #row 15
      
      #row 16 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_final_study_height_mat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_final_study_height_mat_ht_estimate - 
            outcome_girls_final_study_height_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_final_study_height_mat_ht_estimate + 
            outcome_girls_final_study_height_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 17 next is empty
      " ",
      
      #row 18 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_final_sitar_height_mat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_final_sitar_height_mat_ht_estimate - 
            outcome_girls_final_sitar_height_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_final_sitar_height_mat_ht_estimate + 
            outcome_girls_final_sitar_height_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 19 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate - 
            outcome_girls_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate + 
            outcome_girls_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 20 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate - 
            outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate + 
            outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 21 next is empty:
      " ",
      
      #row 22 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_a_mat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_a_mat_ht_estimate - 
            outcome_girls_a_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_a_mat_ht_estimate + 
            outcome_girls_a_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 23 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_b_mat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_b_mat_ht_estimate - 
            outcome_girls_b_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_b_mat_ht_estimate + 
            outcome_girls_b_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 24 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_c_mat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_c_mat_ht_estimate - 
            outcome_girls_c_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_c_mat_ht_estimate + 
            outcome_girls_c_mat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")")
      

    )
  )
  
```

```{r, constructing table 5 column 6}
table_5_column_6 <-
  data.frame(
    table_5_column_6 = c(
      " ",             #row 1
      
      " ",             #row 2
      
      "Paternal Height\n(cm)",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_final_study_height_pat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_final_study_height_pat_ht_estimate - 
            outcome_boys_final_study_height_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_final_study_height_pat_ht_estimate + 
            outcome_boys_final_study_height_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_final_sitar_height_pat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_final_sitar_height_pat_ht_estimate - 
            outcome_boys_final_sitar_height_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_final_sitar_height_pat_ht_estimate + 
            outcome_boys_final_sitar_height_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate - 
            outcome_boys_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate + 
            outcome_boys_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate - 
            outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate + 
            outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_a_pat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_a_pat_ht_estimate - 
            outcome_boys_a_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_a_pat_ht_estimate + 
            outcome_boys_a_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_b_pat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_b_pat_ht_estimate - 
            outcome_boys_b_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_b_pat_ht_estimate + 
            outcome_boys_b_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_boys_c_pat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_boys_c_pat_ht_estimate - 
            outcome_boys_c_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_boys_c_pat_ht_estimate + 
            outcome_boys_c_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      " ",             #row 13
      
      " ",             #row 14
      
      "Paternal Height\n(cm)",             #row 15
      
      #row 16 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_final_study_height_pat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_final_study_height_pat_ht_estimate - 
            outcome_girls_final_study_height_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_final_study_height_pat_ht_estimate + 
            outcome_girls_final_study_height_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 17 next is empty
      " ",
      
      #row 18 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_final_sitar_height_pat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_final_sitar_height_pat_ht_estimate - 
            outcome_girls_final_sitar_height_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_final_sitar_height_pat_ht_estimate + 
            outcome_girls_final_sitar_height_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 19 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate - 
            outcome_girls_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate + 
            outcome_girls_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 20 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate - 
            outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate + 
            outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 21 next is empty:
      " ",
      
      #row 22 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_a_pat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_a_pat_ht_estimate - 
            outcome_girls_a_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_a_pat_ht_estimate + 
            outcome_girls_a_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 23 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_b_pat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_b_pat_ht_estimate - 
            outcome_girls_b_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_b_pat_ht_estimate + 
            outcome_girls_b_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")"),
      
      #row 24 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(outcome_girls_c_pat_ht_estimate),
        digits=table_5_dp_estimate),
        #put the confidence interval in brackets:
        " \n(",
        round(
          (outcome_girls_c_pat_ht_estimate - 
            outcome_girls_c_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        " to ",
        round(
          (outcome_girls_c_pat_ht_estimate + 
            outcome_girls_c_pat_ht_sem * 1.96),
        digits=table_5_dp_std_error),
        ")")
      

    )
  )
  
```

```{r, constructing table 5 column 7}
#column 6 gives us the number in the model
table_5_column_7 <-
  data.frame(
    table_5_column_7 = c(
      " ",             #row 1
      
      "n in model\n(patients)",             #row 2
      
      " ",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the number in the model:
        length(boys_model_final_study_height$residuals)),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the number in the model:
        
        length(boys_model_final_sitar_height$residuals)

        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the number in the model:
        
        length(boys_model_maximum_SITAR_growth_velocity_after_six_years$residuals)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the number in the model:
        
        length(boys_model_age_at_maximum_SITAR_growth_velocity_after_six_years$residuals)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the number in the model:
        
        length(boys_model_a$residuals)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the number in the model:
        
        length(boys_model_b$residuals)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the number in the model:
        
        length(boys_model_c$residuals)
        ),
      
      " ",             #row 13
      
      "n in model\n(patients)",           #row 14
      
      " ",             #row 15
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the number in the model:
        length(girls_model_final_study_height$residuals)),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the number in the model:
        
        length(girls_model_final_sitar_height$residuals)

        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the number in the model:
        
        length(girls_model_maximum_SITAR_growth_velocity_after_six_years$residuals)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the number in the model:
        
        length(girls_model_age_at_maximum_SITAR_growth_velocity_after_six_years$residuals)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the number in the model:
        
        length(girls_model_a$residuals)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the number in the model:
        
        length(girls_model_b$residuals)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the number in the model:
        
        length(girls_model_c$residuals)
        )      

    )
  )
  
```

```{r, constructing table 5 column 8}
table_5_column_8 <-
  data.frame(
    table_5_column_8 = c(
      
      " ",             #row 1
      
      "Model fit\nR²\n(95% CI)",             #row 2
      
      " ",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate of r2:
        round(
          outcome_boys_final_study_height_r2_estimate,
        digits=table_5_dp_r_squared),
        #put the confidence interval in brackets:
        "\n(",
        round(
          (outcome_boys_final_study_height_r2_estimate - 
            1.96 * outcome_boys_final_study_height_r2_sem),
        digits=table_5_dp_r_squared),
        " to ",
        round(
          (outcome_boys_final_study_height_r2_estimate +
            1.96 * outcome_boys_final_study_height_r2_sem),
        digits=table_5_dp_r_squared),
        ")"
        
        ),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate of r2:
        round(
          outcome_boys_final_sitar_height_r2_estimate,
        digits=table_5_dp_r_squared),
        #put the confidence interval in brackets:
        "\n(",
        round(
          (outcome_boys_final_sitar_height_r2_estimate - 
            1.96 * outcome_boys_final_sitar_height_r2_sem),
        digits=table_5_dp_r_squared),
        " to ",
        round(
          (outcome_boys_final_sitar_height_r2_estimate +
            1.96 * outcome_boys_final_sitar_height_r2_sem),
        digits=table_5_dp_r_squared),
        ")"
        
        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate of r2:
        round(
          outcome_boys_maximum_SITAR_growth_velocity_after_six_years_r2_estimate,
        digits=table_5_dp_r_squared),
        #put the confidence interval in brackets:
        "\n(",
        round(
          (outcome_boys_maximum_SITAR_growth_velocity_after_six_years_r2_estimate - 
            1.96 * outcome_boys_maximum_SITAR_growth_velocity_after_six_years_r2_sem),
        digits=table_5_dp_r_squared),
        " to ",
        round(
          (outcome_boys_maximum_SITAR_growth_velocity_after_six_years_r2_estimate +
            1.96 * outcome_boys_maximum_SITAR_growth_velocity_after_six_years_r2_sem),
        digits=table_5_dp_r_squared),
        ")"
        
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate of r2:
        round(
          outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_r2_estimate,
        digits=table_5_dp_r_squared),
        #put the confidence interval in brackets:
        "\n(",
        round(
          (outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_r2_estimate - 
            1.96 * outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_r2_sem),
        digits=table_5_dp_r_squared),
        " to ",
        round(
          (outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_r2_estimate +
            1.96 * outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_r2_sem),
        digits=table_5_dp_r_squared),
        ")"
        
        ),
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate of r2:
        round(
          outcome_boys_a_r2_estimate,
        digits=table_5_dp_r_squared),
        #put the confidence interval in brackets:
        "\n(",
        round(
          (outcome_boys_a_r2_estimate - 
            1.96 * outcome_boys_a_r2_sem),
        digits=table_5_dp_r_squared),
        " to ",
        round(
          (outcome_boys_a_r2_estimate +
            1.96 * outcome_boys_a_r2_sem),
        digits=table_5_dp_r_squared),
        ")"
        
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate of r2:
        round(
          outcome_boys_b_r2_estimate,
        digits=table_5_dp_r_squared),
        #put the confidence interval in brackets:
        "\n(",
        round(
          (outcome_boys_b_r2_estimate - 
            1.96 * outcome_boys_b_r2_sem),
        digits=table_5_dp_r_squared),
        " to ",
        round(
          (outcome_boys_b_r2_estimate +
            1.96 * outcome_boys_b_r2_sem),
        digits=table_5_dp_r_squared),
        ")"
        
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate of r2:
        round(
          outcome_boys_c_r2_estimate,
        digits=table_5_dp_r_squared),
        #put the confidence interval in brackets:
        "\n(",
        round(
          (outcome_boys_c_r2_estimate - 
            1.96 * outcome_boys_c_r2_sem),
        digits=table_5_dp_r_squared),
        " to ",
        round(
          (outcome_boys_c_r2_estimate +
            1.96 * outcome_boys_c_r2_sem),
        digits=table_5_dp_r_squared),
        ")"
        
        ),
      
      " ",             #row 13
      
      "Model fit\nR²\n(95% CI)",           #row 14
      
      " ",             #row 15
      
      #row 16 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate of r2:
        round(
          outcome_girls_final_study_height_r2_estimate,
        digits=table_5_dp_r_squared),
        #put the confidence interval in brackets:
        "\n(",
        round(
          (outcome_girls_final_study_height_r2_estimate - 
            1.96 * outcome_girls_final_study_height_r2_sem),
        digits=table_5_dp_r_squared),
        " to ",
        round(
          (outcome_girls_final_study_height_r2_estimate +
            1.96 * outcome_girls_final_study_height_r2_sem),
        digits=table_5_dp_r_squared),
        ")"
        
        ),
      
      #row 17 next is empty
      " ",
      
      #row 18 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate of r2:
        round(
          outcome_girls_final_sitar_height_r2_estimate,
        digits=table_5_dp_r_squared),
        #put the confidence interval in brackets:
        "\n(",
        round(
          (outcome_girls_final_sitar_height_r2_estimate - 
            1.96 * outcome_girls_final_sitar_height_r2_sem),
        digits=table_5_dp_r_squared),
        " to ",
        round(
          (outcome_girls_final_sitar_height_r2_estimate +
            1.96 * outcome_girls_final_sitar_height_r2_sem),
        digits=table_5_dp_r_squared),
        ")"
        
        ),
      
      #row 19 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate of r2:
        round(
          outcome_girls_maximum_SITAR_growth_velocity_after_six_years_r2_estimate,
        digits=table_5_dp_r_squared),
        #put the confidence interval in brackets:
        "\n(",
        round(
          (outcome_girls_maximum_SITAR_growth_velocity_after_six_years_r2_estimate - 
            1.96 * outcome_girls_maximum_SITAR_growth_velocity_after_six_years_r2_sem),
        digits=table_5_dp_r_squared),
        " to ",
        round(
          (outcome_girls_maximum_SITAR_growth_velocity_after_six_years_r2_estimate +
            1.96 * outcome_girls_maximum_SITAR_growth_velocity_after_six_years_r2_sem),
        digits=table_5_dp_r_squared),
        ")"
        
        ),
      
      #row 20 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate of r2:
        round(
          outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_r2_estimate,
        digits=table_5_dp_r_squared),
        #put the confidence interval in brackets:
        "\n(",
        round(
          (outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_r2_estimate - 
            1.96 * outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_r2_sem),
        digits=table_5_dp_r_squared),
        " to ",
        round(
          (outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_r2_estimate +
            1.96 * outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_r2_sem),
        digits=table_5_dp_r_squared),
        ")"
        
        ),
      #row 21 next is empty:
      " ",
      
      #row 22 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate of r2:
        round(
          outcome_girls_a_r2_estimate,
        digits=table_5_dp_r_squared),
        #put the confidence interval in brackets:
        "\n(",
        round(
          (outcome_girls_a_r2_estimate - 
            1.96 * outcome_girls_a_r2_sem),
        digits=table_5_dp_r_squared),
        " to ",
        round(
          (outcome_girls_a_r2_estimate +
            1.96 * outcome_girls_a_r2_sem),
        digits=table_5_dp_r_squared),
        ")"
        
        ),
      
      #row 23 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate of r2:
        round(
          outcome_girls_b_r2_estimate,
        digits=table_5_dp_r_squared),
        #put the confidence interval in brackets:
        "\n(",
        round(
          (outcome_girls_b_r2_estimate - 
            1.96 * outcome_girls_b_r2_sem),
        digits=table_5_dp_r_squared),
        " to ",
        round(
          (outcome_girls_b_r2_estimate +
            1.96 * outcome_girls_b_r2_sem),
        digits=table_5_dp_r_squared),
        ")"
        
        ),
      
      #row 24 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate of r2:
        round(
          outcome_girls_c_r2_estimate,
        digits=table_5_dp_r_squared),
        #put the confidence interval in brackets:
        "\n(",
        round(
          (outcome_girls_c_r2_estimate - 
            1.96 * outcome_girls_c_r2_sem),
        digits=table_5_dp_r_squared),
        " to ",
        round(
          (outcome_girls_c_r2_estimate +
            1.96 * outcome_girls_c_r2_sem),
        digits=table_5_dp_r_squared)
        
        )      

    )
  )
  
```

```{r, binding together columns of table 5 for paper}
table_5 <- cbind(
  table_5_column_1,
  table_5_column_2,
  table_5_column_3,
  table_5_column_4,
  table_5_column_5,
  table_5_column_6,
  table_5_column_7,
  table_5_column_8
)

write.csv(table_5, "table_5.csv", row.names = F)
```

```{r, print table 5 to a word document}
ft <- flextable(table_5) #will have to make it landscape manually as I couldn't figure out how to do that
  
  # Customize the table appearance
  ft <- ft %>%
    theme_vanilla() %>%
    align(align = "center", part = "header") %>%
    align(align = "center", part = "body") %>%  
    autofit()
  
  # Define paragraph formatting with centered alignment
  centered_paragraph <- 
    fp_par(text.align = "center")
  
  doc <- read_docx() %>%
    body_add_flextable(ft) 
  
  print(doc, target = file.path(paste0("table_5", ".docx")))
```

############################
table 6 appendix for paper - boys prediction models using SITAR model fits with 12 degrees of freedom instead of 15 - the 'second optimum' model
############################
Note - second optimum refers to the sitar fit, not the multivariable prediction modelling which remains the same covariates

#################
table 6 for paper - the sensitivity analysis just for boys using the second optimum model fit
#################

```{r, establish decimal places for table 6}
table_6_dp_estimate <- 3
table_6_dp_std_error <- 3
table_6_dp_r_squared <- 3
table_6_dp_p_value <- 5
```

```{r, constructing table 6 column 1}
table_6_column_1 <-
  data.frame(
    table_6_column_1 = c(
      "Boys",             #row 1
      
      "Dependent Variable:",             #row 2
      
      "Raw data:",             #row 3
      
      "Final study height (cm)*",             #row 4
      
      "Metrics calculated from SITAR modelling:",             #row 5
      
      "Height at 18.5 years (cm)",             #row 6
      
      "Peak pubertal height velocity (cm/year)",             #row 7
      
      "Age at peak pubertal height velocity (years)",             #row 8
      
      "SITAR model patient level random effects",             #row 9
      
      "a: \"Size\"",             #row 10
      
      "b: \"Timing\"",             #row 11
      
      "c: \"Velocity\""

    )
    )
```

```{r, constructing table 6 column 2}
table_6_column_2 <-
  data.frame(
    table_6_column_2 = c(
      " ",             #row 1
      
      " ",             #row 2
      
      "Intercept",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_final_height$coefficients["(Intercept)"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_final_height)$coefficients["(Intercept)", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_final_height)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_final_SITAR_height$coefficients["(Intercept)"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_final_SITAR_height)$coefficients["(Intercept)", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_final_SITAR_height)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["(Intercept)"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["(Intercept)", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["(Intercept)"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["(Intercept)", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_a$coefficients["(Intercept)"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_a)$coefficients["(Intercept)", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_a)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_b$coefficients["(Intercept)"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_b)$coefficients["(Intercept)", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_b)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_c$coefficients["(Intercept)"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_c)$coefficients["(Intercept)", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_c)$coefficients["(Intercept)", "Pr(>|t|)"],
        digits=3)
        )
    )
  )
  
```

```{r, constructing table 6 column 3}
table_6_column_3 <-
  data.frame(
    table_6_column_3 = c(
      " ",             #row 1
      
      "Independent Variables: Estimate (SEM) p-value",             #row 2
      
      "Exposure to antenatal steroids: Yes",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_final_height$coefficients["STEROIDSyes"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_final_height)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_final_height)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_final_SITAR_height$coefficients["STEROIDSyes"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_final_SITAR_height)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_final_SITAR_height)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["STEROIDSyes"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["STEROIDSyes"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_a$coefficients["STEROIDSyes"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_a)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_a)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_b$coefficients["STEROIDSyes"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_b)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_b)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_c$coefficients["STEROIDSyes"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_c)$coefficients["STEROIDSyes", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_c)$coefficients["STEROIDSyes", "Pr(>|t|)"],
        digits=3)
        )

    )
  )
  
```

```{r, constructing table 6 column 4}
table_6_column_4 <-
  data.frame(
    table_6_column_4 = c(
      " ",             #row 1
      
      " ",             #row 2
      
      "GA at delivery\n(weeks)",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_final_height$coefficients["ga"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_final_height)$coefficients["ga", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_final_height)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_final_SITAR_height$coefficients["ga"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_final_SITAR_height)$coefficients["ga", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_final_SITAR_height)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["ga"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["ga", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["ga"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["ga", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_a$coefficients["ga"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_a)$coefficients["ga", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_a)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_b$coefficients["ga"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_b)$coefficients["ga", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_b)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_c$coefficients["ga"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_c)$coefficients["ga", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_c)$coefficients["ga", "Pr(>|t|)"],
        digits=3)
        )

    )
  )
  
```

```{r, constructing table 6 column 5}
table_6_column_5 <-
  data.frame(
    table_6_column_5 = c(
      " ",             #row 1
      
      " ",             #row 2
      
      "Maternal Height\n(cm)",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_final_height$coefficients["mat_ht"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_final_height)$coefficients["mat_ht", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_final_height)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_final_SITAR_height$coefficients["mat_ht"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_final_SITAR_height)$coefficients["mat_ht", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_final_SITAR_height)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["mat_ht"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["mat_ht", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["mat_ht"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["mat_ht", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_a$coefficients["mat_ht"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_a)$coefficients["mat_ht", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_a)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_b$coefficients["mat_ht"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_b)$coefficients["mat_ht", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_b)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_c$coefficients["mat_ht"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_c)$coefficients["mat_ht", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_c)$coefficients["mat_ht", "Pr(>|t|)"],
        digits=3)
        )

    )
  )
  
```

```{r, constructing table 6 column 6}
table_6_column_6 <-
  data.frame(
    table_6_column_6 = c(
      " ",             #row 1
      
      " ",             #row 2
      
      "Paternal Height\n(cm)",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_final_height$coefficients["pat_ht"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_final_height)$coefficients["pat_ht", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_final_height)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_final_SITAR_height$coefficients["pat_ht"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_final_SITAR_height)$coefficients["pat_ht", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_final_SITAR_height)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$coefficients["pat_ht"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["pat_ht", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$coefficients["pat_ht"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["pat_ht", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_a$coefficients["pat_ht"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_a)$coefficients["pat_ht", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_a)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_b$coefficients["pat_ht"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_b)$coefficients["pat_ht", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_b)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the estimate:
        round(
        as.numeric(boys_second_optimum_prediction_model_c$coefficients["pat_ht"]),
        digits=table_6_dp_estimate),
        #put the standard error in brackets:
        " (",
        round(
          summary(boys_second_optimum_prediction_model_c)$coefficients["pat_ht", "Std. Error"],
        digits=table_6_dp_std_error),
        ")\n",
        #put the p value on the next line),             
        "p=",
        round(
          summary(boys_second_optimum_prediction_model_c)$coefficients["pat_ht", "Pr(>|t|)"],
        digits=3)
        )
    )
  )
  
```

```{r, constructing table 6 column 7}
#column 6 gives us the number in the model
table_6_column_7 <-
  data.frame(
    table_6_column_7 = c(
      " ",             #row 1
      
      "n in model\n(patients)",             #row 2
      
      " ",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the number in the model:
        nrow(boys_second_optimum_prediction_model_final_height$model)),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the number in the model:
        
        nrow(boys_second_optimum_prediction_model_final_SITAR_height$model)

        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the number in the model:
        
        nrow(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years$model)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
      paste0(
        #put in the number in the model:
        
        nrow(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years$model)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
      paste0(
        #put in the number in the model:
        
        nrow(boys_second_optimum_prediction_model_a$model)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
      paste0(
        #put in the number in the model:
        
        nrow(boys_second_optimum_prediction_model_b$model)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
      paste0(
        #put in the number in the model:
        
        nrow(boys_second_optimum_prediction_model_c$model)
        )

    )
  )
  
```

```{r, constructing table 6 column 8}
table_6_column_8 <-
  data.frame(
    table_6_column_8 = c(
      
      " ",             #row 1
      
      "Model fit\nR²\np-value",             #row 2
      
      " ",             #row 3
      
      #row 4 next pertaining to outcome variable raw data final height:
      paste0(
        #put in the estimate:
        round(
          summary(boys_second_optimum_prediction_model_final_height)$r.squared,
        digits=table_6_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(boys_second_optimum_prediction_model_final_height)$fstatistic[1], 
              summary(boys_second_optimum_prediction_model_final_height)$fstatistic[2], 
              summary(boys_second_optimum_prediction_model_final_height)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_6_dp_p_value)
        ),
      
      #row 5 next is empty
      " ",
      
      #row 6 next pertaining to outcome variable SITAR height at 18.5 years:
      paste0(
        #put in the estimate:
        round(
          summary(boys_second_optimum_prediction_model_final_SITAR_height)$r.squared,
        digits=table_6_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(boys_second_optimum_prediction_model_final_SITAR_height)$fstatistic[1], 
              summary(boys_second_optimum_prediction_model_final_SITAR_height)$fstatistic[2], 
              summary(boys_second_optimum_prediction_model_final_SITAR_height)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_6_dp_p_value)
        ),
      
      #row 7 next pertaining to outcome variable peak pubertal height velocity:
      paste0(
        #put in the estimate:
        round(
          summary(boys_second_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years)$r.squared,
        digits=table_6_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(boys_second_optimum_prediction_model_final_SITAR_height)$fstatistic[1], 
              summary(boys_second_optimum_prediction_model_final_SITAR_height)$fstatistic[2], 
              summary(boys_second_optimum_prediction_model_final_SITAR_height)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_6_dp_p_value)
        ),
      
      #row 8 next pertaining to outcome variable age at peak pubertal height velocity:
            paste0(
        #put in the estimate:
        round(
          summary(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$r.squared,
        digits=table_6_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$fstatistic[1], 
              summary(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$fstatistic[2], 
              summary(boys_second_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_6_dp_p_value)
        ),
      
      #row 9 next is empty:
      " ",
      
      #row 10 next pertaining to outcome variable SITAR a size:
          paste0(
        #put in the estimate:
        round(
          summary(boys_second_optimum_prediction_model_a)$r.squared,
        digits=table_6_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(boys_second_optimum_prediction_model_a)$fstatistic[1], 
              summary(boys_second_optimum_prediction_model_a)$fstatistic[2], 
              summary(boys_second_optimum_prediction_model_a)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_6_dp_p_value)
        ),
      
      #row 11 next pertaining to outcome variable SITAR b timing:
        paste0(
        #put in the estimate:
        round(
          summary(boys_second_optimum_prediction_model_b)$r.squared,
        digits=table_6_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(boys_second_optimum_prediction_model_b)$fstatistic[1], 
              summary(boys_second_optimum_prediction_model_b)$fstatistic[2], 
              summary(boys_second_optimum_prediction_model_b)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_6_dp_p_value)
        ),
      
      #row 12 next pertaining to outcome variable SITAR c velocity:
     paste0(
        #put in the estimate:
        round(
          summary(boys_second_optimum_prediction_model_c)$r.squared,
        digits=table_6_dp_r_squared),
        #put the standard error in brackets:
        "\n ",
        round(
          pf(summary(boys_second_optimum_prediction_model_c)$fstatistic[1], 
              summary(boys_second_optimum_prediction_model_c)$fstatistic[2], 
              summary(boys_second_optimum_prediction_model_c)$fstatistic[3], 
              lower.tail = FALSE),
        digits=table_6_dp_p_value)
        )
    )
  )
  
```

```{r, binding together columns of table 6 for paper}
table_6 <- cbind(
  table_6_column_1,
  table_6_column_2,
  table_6_column_3,
  table_6_column_4,
  table_6_column_5,
  table_6_column_6,
  table_6_column_7,
  table_6_column_8
)

write.csv(table_6, "table_6.csv", row.names = F)
```

```{r, print table 6 to a word document}
ft <- flextable(table_6) #will have to make it landscape manually as I couldn't figure out how to do that
  
  # Customize the table appearance
  ft <- ft %>%
    theme_vanilla() %>%
    align(align = "center", part = "header") %>%
    align(align = "center", part = "body") %>%  
    autofit()
  
  # Define paragraph formatting with centered alignment
  centered_paragraph <- 
    fp_par(text.align = "center")
  
  doc <- read_docx() %>%
    body_add_flextable(ft) 
  
  print(doc, target = file.path(paste0("table_6", ".docx")))
```


***************************************
Effect size plots
***************************************

To draw attention to the difference in the effect between boys and girls, we want to plot each effect size separately
As the effect sizes all span different scales, we want to create each plot separately
Then we can combine them with grid arrange and add the different axis labels in adobe illustrator 

```{r, effect size plot for models comparing boys and girls complete data}
# Function to extract coefficients and confidence intervals
extract_coefficient_frame <- function(model, model_name = "Model") {
  tidy_model <- broom::tidy(model) %>%
    mutate(
      lower_ci = estimate - 1.96 * std.error,
      upper_ci = estimate + 1.96 * std.error,
      model = model_name
    )
  tidy_model <- as.data.frame(tidy_model)
  rownames(tidy_model) <- (tidy_model[,1])
  tidy_model$term <- NULL
  return(tidy_model)
}

#create a list to add to
    list_of_limited_coefficient_sex_comparison_plot <- list()

#start the loop of dependent variables
#set the dependent variable 
for (dependent_variable in c(
  "final_height",
  "final_SITAR_height",
  "maximum_SITAR_growth_velocity_after_six_years",
  "age_at_maximum_SITAR_growth_velocity_after_six_years",
  "a",
  "b",
  "c")){
  
#loop round the independent variable
for (independent_variable in c(
       "STEROIDSyes",
       "ga",
       "mat_ht",
       "pat_ht")){
  
#find the appropriate data and set the appropriate limits
  
if (dependent_variable == "final_height"){
  girls_coefficient_frame <- (extract_coefficient_frame(girls_optimum_prediction_model_final_height))
  boys_coefficient_frame <- (extract_coefficient_frame(boys_optimum_prediction_model_final_height))
  #set the x axis limits based on which independent variable we have
  if (independent_variable == "STEROIDSyes"){
  x_limits <-   coord_cartesian(xlim = c(-20,20))
  }
  if (independent_variable == "ga"){
  x_limits <-   coord_cartesian(xlim = c(-2,2))
  }
  if (independent_variable == "mat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  }
  if (independent_variable == "pat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  }

  }
  
if (dependent_variable == "final_SITAR_height"){
  girls_coefficient_frame <- (extract_coefficient_frame(girls_optimum_prediction_model_final_SITAR_height))
  boys_coefficient_frame <- (extract_coefficient_frame(boys_optimum_prediction_model_final_SITAR_height))
  
    #set the x axis limits based on which independent variable we have
  if (independent_variable == "STEROIDSyes"){
  x_limits <-   coord_cartesian(xlim = c(-10,10))
  }
  if (independent_variable == "ga"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  }
  if (independent_variable == "mat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  }
  if (independent_variable == "pat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  }
}
  
if (dependent_variable == "maximum_SITAR_growth_velocity_after_six_years"){
  girls_coefficient_frame <- (extract_coefficient_frame(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years))
  boys_coefficient_frame <- (extract_coefficient_frame(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years))
  
    #set the x axis limits based on which independent variable we have
  if (independent_variable == "STEROIDSyes"){
  x_limits <-   coord_cartesian(xlim = c(-2,2))
  }
  if (independent_variable == "ga"){
  x_limits <-   coord_cartesian(xlim = c(-0.2,0.2))
  }
  if (independent_variable == "mat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.1,0.1))
  }
  if (independent_variable == "pat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.1,0.1))
  }
}
  
if (dependent_variable == "age_at_maximum_SITAR_growth_velocity_after_six_years"){
  girls_coefficient_frame <- (extract_coefficient_frame(girls_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years))
  boys_coefficient_frame <- (extract_coefficient_frame(boys_optimum_prediction_model_age_at_maximum_SITAR_growth_velocity_after_six_years))
  
    #set the x axis limits based on which independent variable we have
  if (independent_variable == "STEROIDSyes"){
  x_limits <-   coord_cartesian(xlim = c(-2,2))
  }
  if (independent_variable == "ga"){
  x_limits <-   coord_cartesian(xlim = c(-0.2,0.2))
  }
  if (independent_variable == "mat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.1,0.1))
  }
  if (independent_variable == "pat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.1,0.1))
  }
}
  
if (dependent_variable == "a"){
  girls_coefficient_frame <- (extract_coefficient_frame(girls_optimum_prediction_model_a))
  boys_coefficient_frame <- (extract_coefficient_frame(boys_optimum_prediction_model_a))
  
    #set the x axis limits based on which independent variable we have
  if (independent_variable == "STEROIDSyes"){
  x_limits <-   coord_cartesian(xlim = c(-10,10))
  }
  if (independent_variable == "ga"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  }
  if (independent_variable == "mat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  }
  if (independent_variable == "pat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  }
}
  
if (dependent_variable == "b"){
  girls_coefficient_frame <- (extract_coefficient_frame(girls_optimum_prediction_model_b))
  boys_coefficient_frame <- (extract_coefficient_frame(boys_optimum_prediction_model_b))
  
    #set the x axis limits based on which independent variable we have
  if (independent_variable == "STEROIDSyes"){
  x_limits <-   coord_cartesian(xlim = c(-0.1,0.1))
  }
  if (independent_variable == "ga"){
  x_limits <-   coord_cartesian(xlim = c(-0.01,0.01))
  }
  if (independent_variable == "mat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.01,0.01))
  }
  if (independent_variable == "pat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.01,0.01))
  }
}
  
if (dependent_variable == "c"){
  girls_coefficient_frame <- (extract_coefficient_frame(girls_optimum_prediction_model_c))
  boys_coefficient_frame <- (extract_coefficient_frame(boys_optimum_prediction_model_c))
  
    #set the x axis limits based on which independent variable we have
  if (independent_variable == "STEROIDSyes"){
  x_limits <-   coord_cartesian(xlim = c(-0.1,0.1))
  }
  if (independent_variable == "ga"){
  x_limits <-   coord_cartesian(xlim = c(-0.005,0.005))
  }
  if (independent_variable == "mat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.01,0.01))
  }
  if (independent_variable == "pat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.01,0.01))
  }
}
  
#set colours and other parameters
girls_colour <- "darkred"
boys_colour <- "darkblue"
geom_vline_linewidth <- 1
geom_hline_linewidth <- 0.2
geom_error_line_width <- 2
geom_point_size <- 12
x_axis_offset <- 0.2

#extract the necessary estimates outside of ggplot so that the individual plots remain unique in our list at the end
boys_estimate <- boys_coefficient_frame[independent_variable,"estimate"]
boys_lower_ci <- boys_coefficient_frame[independent_variable, "lower_ci"]
boys_upper_ci <- boys_coefficient_frame[independent_variable, "upper_ci"]


#this approach isn't working to keep the plots rendering how they originally rendered in R = given up and just decided to combine in illustrator as that is straight forward enough when you make them all the same size
girls_estimate <- girls_coefficient_frame[independent_variable,"estimate"]
girls_lower_ci <- girls_coefficient_frame[independent_variable, "lower_ci"]
girls_upper_ci <- girls_coefficient_frame[independent_variable, "upper_ci"]

       


  # Create a ggplot for the current term
coefficient_sex_comparison_plot <- 
    ggplot() +
    geom_vline(xintercept=0, 
               linewidth=geom_vline_linewidth, 
               colour="black") +
    geom_hline(yintercept=0, 
               linewidth=geom_hline_linewidth, 
               colour="black") +
  
    geom_point(
        aes(
        x=boys_estimate,
        y=x_axis_offset
      ),
      size = geom_point_size,
      colour=boys_colour) +
    geom_errorbarh(
        aes(
        xmin = boys_lower_ci, 
        xmax = boys_upper_ci,
        y=x_axis_offset),
      linewidth=geom_error_line_width,
      height = 0.2,
      colour=boys_colour
    ) +
  
    geom_point(
      aes(
        x=girls_estimate,
        y=-x_axis_offset
      ),
      size = geom_point_size,
      colour=girls_colour) +
    geom_errorbarh(
      aes(
        xmin = girls_lower_ci, 
        xmax = girls_upper_ci,
        y=-x_axis_offset),
      linewidth=geom_error_line_width,
      height = 0.2,
      colour=girls_colour
    ) +
  
    theme_minimal() +
  theme(
    plot.background=element_rect(fill="white", colour=NA)) 
  
  dir.create("coefficient_sex_comparison_plots", showWarnings = F)
  dir.create(paste0("coefficient_sex_comparison_plots/IV_", independent_variable), showWarnings = F)
  
    ggsave(filename = 
           paste0("DV_", dependent_variable,
                  ".tif"),
         path = paste0("coefficient_sex_comparison_plots/IV_", independent_variable),
         plot = coefficient_sex_comparison_plot,
         device = "tiff",
         width = 10,
         height = 2,
         compression = "lzw",
         limitsize = FALSE)
  
#limit the x axis separately
limited_coefficient_sex_comparison_plot <-
  coefficient_sex_comparison_plot +
  x_limits +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.text.y = element_blank(),
    axis.text.x = element_text(vjust = 0.5),
    axis.title=element_blank())

    ggsave(filename = 
           paste0("limited_DV_", dependent_variable,
                  ".tif"),
         path = paste0("coefficient_sex_comparison_plots/IV_", independent_variable),
         plot = limited_coefficient_sex_comparison_plot,
         device = "tiff",
         width = 10,
         height = 2,
         compression = "lzw",
         limitsize = FALSE)
    
list_of_limited_coefficient_sex_comparison_plot[[length(
  list_of_limited_coefficient_sex_comparison_plot) + 
    1]] <- limited_coefficient_sex_comparison_plot    
    #end the loop for independent variables
}
    #end the loop of dependent variables
}
    
```

***************************************
Repeat effect size plots in imputed data
***************************************

```{r, effect size plot for models comparing boys and girls imputed data}
#create a list to add to
    list_of_limited_imputed_coefficient_sex_comparison_plot <- list()

#start the loop of dependent variables
#set the dependent variable 
for (dependent_variable in c(
  "final_height",
  "final_SITAR_height",
  "maximum_SITAR_growth_velocity_after_six_years",
  "age_at_maximum_SITAR_growth_velocity_after_six_years",
  "a",
  "b",
  "c")){
  
#loop round the independent variable
for (independent_variable in c(
       "STEROIDSyes",
       "ga",
       "mat_ht",
       "pat_ht")){
  
#find the appropriate data and set the appropriate limits
  #this time we don't have a coefficient frame to refer to, we've bootstrapped our estimates and have them all saved as individual variables, so we get them here dependent upon the dependent variable
  
if (dependent_variable == "final_height"){
  #set the x axis limits based on which independent variable we have
  if (independent_variable == "STEROIDSyes"){
  x_limits <-   coord_cartesian(xlim = c(-20,20))
  boys_estimate <- outcome_boys_final_study_height_steroid_estimate
  boys_lower_ci <- outcome_boys_final_study_height_steroid_estimate - 1.96 *
    outcome_boys_final_study_height_steroid_sem
  boys_upper_ci <- outcome_boys_final_study_height_steroid_estimate + 1.96 *
    outcome_boys_final_study_height_steroid_sem
  girls_estimate <- outcome_girls_final_study_height_steroid_estimate
  girls_lower_ci <- outcome_girls_final_study_height_steroid_estimate - 1.96 *
    outcome_girls_final_study_height_steroid_sem
  girls_upper_ci <- outcome_girls_final_study_height_steroid_estimate + 1.96 *
    outcome_girls_final_study_height_steroid_sem
  }
  if (independent_variable == "ga"){
  x_limits <-   coord_cartesian(xlim = c(-2,2))
  girls_estimate <- outcome_girls_final_study_height_ga_estimate
  girls_lower_ci <- outcome_girls_final_study_height_ga_estimate - 1.96 *
    outcome_girls_final_study_height_ga_sem
  girls_upper_ci <- outcome_girls_final_study_height_ga_estimate + 1.96 *
    outcome_girls_final_study_height_ga_sem
  boys_estimate <- outcome_boys_final_study_height_ga_estimate
  boys_lower_ci <- outcome_boys_final_study_height_ga_estimate - 1.96 *
    outcome_boys_final_study_height_ga_sem
  boys_upper_ci <- outcome_boys_final_study_height_ga_estimate + 1.96 *
    outcome_boys_final_study_height_ga_sem
  }
  if (independent_variable == "mat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  boys_estimate <- outcome_boys_final_study_height_mat_ht_estimate
  boys_lower_ci <- outcome_boys_final_study_height_mat_ht_estimate - 1.96 *
    outcome_boys_final_study_height_mat_ht_sem
  boys_upper_ci <- outcome_boys_final_study_height_mat_ht_estimate + 1.96 *
    outcome_boys_final_study_height_mat_ht_sem
  girls_estimate <- outcome_girls_final_study_height_mat_ht_estimate
  girls_lower_ci <- outcome_girls_final_study_height_mat_ht_estimate - 1.96 *
    outcome_girls_final_study_height_mat_ht_sem
  girls_upper_ci <- outcome_girls_final_study_height_mat_ht_estimate + 1.96 *
    outcome_girls_final_study_height_mat_ht_sem
  }
  if (independent_variable == "pat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  girls_estimate <- outcome_girls_final_study_height_pat_ht_estimate
  girls_lower_ci <- outcome_girls_final_study_height_pat_ht_estimate - 1.96 *
    outcome_girls_final_study_height_pat_ht_sem
  girls_upper_ci <- outcome_girls_final_study_height_pat_ht_estimate + 1.96 *
    outcome_girls_final_study_height_pat_ht_sem
  boys_estimate <- outcome_boys_final_study_height_pat_ht_estimate
  boys_lower_ci <- outcome_boys_final_study_height_pat_ht_estimate - 1.96 *
    outcome_boys_final_study_height_pat_ht_sem
  boys_upper_ci <- outcome_boys_final_study_height_pat_ht_estimate + 1.96 *
    outcome_boys_final_study_height_pat_ht_sem
  }

  }
  
if (dependent_variable == "final_SITAR_height"){
  girls_coefficient_frame <- (extract_coefficient_frame(girls_optimum_prediction_model_final_SITAR_height))
  boys_coefficient_frame <- (extract_coefficient_frame(boys_optimum_prediction_model_final_SITAR_height))
  
    #set the x axis limits based on which independent variable we have
  if (independent_variable == "STEROIDSyes"){
  x_limits <-   coord_cartesian(xlim = c(-10,10))
  boys_estimate <- outcome_boys_final_sitar_height_steroid_estimate
  boys_lower_ci <- outcome_boys_final_sitar_height_steroid_estimate - 1.96 *
    outcome_boys_final_sitar_height_steroid_sem
  boys_upper_ci <- outcome_boys_final_sitar_height_steroid_estimate + 1.96 *
    outcome_boys_final_sitar_height_steroid_sem
  girls_estimate <- outcome_girls_final_sitar_height_steroid_estimate
  girls_lower_ci <- outcome_girls_final_sitar_height_steroid_estimate - 1.96 *
    outcome_girls_final_sitar_height_steroid_sem
  girls_upper_ci <- outcome_girls_final_sitar_height_steroid_estimate + 1.96 *
    outcome_girls_final_sitar_height_steroid_sem
  }
  if (independent_variable == "ga"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  girls_estimate <- outcome_girls_final_sitar_height_ga_estimate
  girls_lower_ci <- outcome_girls_final_sitar_height_ga_estimate - 1.96 *
    outcome_girls_final_sitar_height_ga_sem
  girls_upper_ci <- outcome_girls_final_sitar_height_ga_estimate + 1.96 *
    outcome_girls_final_sitar_height_ga_sem
  boys_estimate <- outcome_boys_final_sitar_height_ga_estimate
  boys_lower_ci <- outcome_boys_final_sitar_height_ga_estimate - 1.96 *
    outcome_boys_final_sitar_height_ga_sem
  boys_upper_ci <- outcome_boys_final_sitar_height_ga_estimate + 1.96 *
    outcome_boys_final_sitar_height_ga_sem
  }
  if (independent_variable == "mat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  boys_estimate <- outcome_boys_final_sitar_height_mat_ht_estimate
  boys_lower_ci <- outcome_boys_final_sitar_height_mat_ht_estimate - 1.96 *
    outcome_boys_final_sitar_height_mat_ht_sem
  boys_upper_ci <- outcome_boys_final_sitar_height_mat_ht_estimate + 1.96 *
    outcome_boys_final_sitar_height_mat_ht_sem
  girls_estimate <- outcome_girls_final_sitar_height_mat_ht_estimate
  girls_lower_ci <- outcome_girls_final_sitar_height_mat_ht_estimate - 1.96 *
    outcome_girls_final_sitar_height_mat_ht_sem
  girls_upper_ci <- outcome_girls_final_sitar_height_mat_ht_estimate + 1.96 *
    outcome_girls_final_sitar_height_mat_ht_sem
  }
  if (independent_variable == "pat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  girls_estimate <- outcome_girls_final_sitar_height_pat_ht_estimate
  girls_lower_ci <- outcome_girls_final_sitar_height_pat_ht_estimate - 1.96 *
    outcome_girls_final_sitar_height_pat_ht_sem
  girls_upper_ci <- outcome_girls_final_sitar_height_pat_ht_estimate + 1.96 *
    outcome_girls_final_sitar_height_pat_ht_sem
  boys_estimate <- outcome_boys_final_sitar_height_pat_ht_estimate
  boys_lower_ci <- outcome_boys_final_sitar_height_pat_ht_estimate - 1.96 *
    outcome_boys_final_sitar_height_pat_ht_sem
  boys_upper_ci <- outcome_boys_final_sitar_height_pat_ht_estimate + 1.96 *
    outcome_boys_final_sitar_height_pat_ht_sem
  }
}
  
if (dependent_variable == "maximum_SITAR_growth_velocity_after_six_years"){
  girls_coefficient_frame <- (extract_coefficient_frame(girls_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years))
  boys_coefficient_frame <- (extract_coefficient_frame(boys_optimum_prediction_model_maximum_SITAR_growth_velocity_after_six_years))
  
    #set the x axis limits based on which independent variable we have
  if (independent_variable == "STEROIDSyes"){
  x_limits <-   coord_cartesian(xlim = c(-2,2))
  boys_estimate <- outcome_boys_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate
  boys_lower_ci <- outcome_boys_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate - 1.96 *
    outcome_boys_maximum_SITAR_growth_velocity_after_six_years_steroid_sem
  boys_upper_ci <- outcome_boys_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate + 1.96 *
    outcome_boys_maximum_SITAR_growth_velocity_after_six_years_steroid_sem
  girls_estimate <- outcome_girls_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate
  girls_lower_ci <- outcome_girls_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate - 1.96 *
    outcome_girls_maximum_SITAR_growth_velocity_after_six_years_steroid_sem
  girls_upper_ci <- outcome_girls_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate + 1.96 *
    outcome_girls_maximum_SITAR_growth_velocity_after_six_years_steroid_sem
  }
  if (independent_variable == "ga"){
  x_limits <-   coord_cartesian(xlim = c(-0.2,0.2))
  girls_estimate <- outcome_girls_maximum_SITAR_growth_velocity_after_six_years_ga_estimate
  girls_lower_ci <- outcome_girls_maximum_SITAR_growth_velocity_after_six_years_ga_estimate - 1.96 *
    outcome_girls_maximum_SITAR_growth_velocity_after_six_years_ga_sem
  girls_upper_ci <- outcome_girls_maximum_SITAR_growth_velocity_after_six_years_ga_estimate + 1.96 *
    outcome_girls_maximum_SITAR_growth_velocity_after_six_years_ga_sem
  boys_estimate <- outcome_boys_maximum_SITAR_growth_velocity_after_six_years_ga_estimate
  boys_lower_ci <- outcome_boys_maximum_SITAR_growth_velocity_after_six_years_ga_estimate - 1.96 *
    outcome_boys_maximum_SITAR_growth_velocity_after_six_years_ga_sem
  boys_upper_ci <- outcome_boys_maximum_SITAR_growth_velocity_after_six_years_ga_estimate + 1.96 *
    outcome_boys_maximum_SITAR_growth_velocity_after_six_years_ga_sem
  }
  if (independent_variable == "mat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.1,0.1))
  boys_estimate <- outcome_boys_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate
  boys_lower_ci <- outcome_boys_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate - 1.96 *
    outcome_boys_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem
  boys_upper_ci <- outcome_boys_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate + 1.96 *
    outcome_boys_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem
  girls_estimate <- outcome_girls_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate
  girls_lower_ci <- outcome_girls_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate - 1.96 *
    outcome_girls_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem
  girls_upper_ci <- outcome_girls_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate + 1.96 *
    outcome_girls_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem
  }
  if (independent_variable == "pat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.1,0.1))
  girls_estimate <- outcome_girls_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate
  girls_lower_ci <- outcome_girls_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate - 1.96 *
    outcome_girls_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem
  girls_upper_ci <- outcome_girls_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate + 1.96 *
    outcome_girls_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem
  boys_estimate <- outcome_boys_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate
  boys_lower_ci <- outcome_boys_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate - 1.96 *
    outcome_boys_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem
  boys_upper_ci <- outcome_boys_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate + 1.96 *
    outcome_boys_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem
  }
}
  
if (dependent_variable == "age_at_maximum_SITAR_growth_velocity_after_six_years"){

    #set the x axis limits based on which independent variable we have
  if (independent_variable == "STEROIDSyes"){
  x_limits <-   coord_cartesian(xlim = c(-2,2))
  girls_estimate <- outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate
  girls_lower_ci <- outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate - 1.96 *
    outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_sem
  girls_upper_ci <- outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate + 1.96 *
    outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_sem
  boys_estimate <- outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate
  boys_lower_ci <- outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate - 1.96 *
    outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_sem
  boys_upper_ci <- outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_estimate + 1.96 *
    outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_steroid_sem
  }
  if (independent_variable == "ga"){
  x_limits <-   coord_cartesian(xlim = c(-0.2,0.2))
  boys_estimate <- outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_estimate
  boys_lower_ci <- outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_estimate - 1.96 *
    outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_sem
  boys_upper_ci <- outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_estimate + 1.96 *
    outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_sem
  girls_estimate <- outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_estimate
  girls_lower_ci <- outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_estimate - 1.96 *
    outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_sem
  girls_upper_ci <- outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_estimate + 1.96 *
    outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_ga_sem
  }
  if (independent_variable == "mat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.1,0.1))
  girls_estimate <- outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate
  girls_lower_ci <- outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate - 1.96 *
    outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem
  girls_upper_ci <- outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate + 1.96 *
    outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem
  boys_estimate <- outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate
  boys_lower_ci <- outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate - 1.96 *
    outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem
  boys_upper_ci <- outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_estimate + 1.96 *
    outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_mat_ht_sem
  }
  if (independent_variable == "pat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.1,0.1))
  boys_estimate <- outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate
  boys_lower_ci <- outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate - 1.96 *
    outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem
  boys_upper_ci <- outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate + 1.96 *
    outcome_boys_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem
  girls_estimate <- outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate
  girls_lower_ci <- outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate - 1.96 *
    outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem
  girls_upper_ci <- outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_estimate + 1.96 *
    outcome_girls_age_at_maximum_SITAR_growth_velocity_after_six_years_pat_ht_sem
  }
}
  
if (dependent_variable == "a"){
  
    #set the x axis limits based on which independent variable we have
  if (independent_variable == "STEROIDSyes"){
  x_limits <-   coord_cartesian(xlim = c(-10,10))
  girls_estimate <- outcome_girls_a_steroid_estimate
  girls_lower_ci <- outcome_girls_a_steroid_estimate - 1.96 *
    outcome_girls_a_steroid_sem
  girls_upper_ci <- outcome_girls_a_steroid_estimate + 1.96 *
    outcome_girls_a_steroid_sem
  boys_estimate <- outcome_boys_a_steroid_estimate
  boys_lower_ci <- outcome_boys_a_steroid_estimate - 1.96 *
    outcome_boys_a_steroid_sem
  boys_upper_ci <- outcome_boys_a_steroid_estimate + 1.96 *
    outcome_boys_a_steroid_sem
  }
  if (independent_variable == "ga"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  boys_estimate <- outcome_boys_a_ga_estimate
  boys_lower_ci <- outcome_boys_a_ga_estimate - 1.96 *
    outcome_boys_a_ga_sem
  boys_upper_ci <- outcome_boys_a_ga_estimate + 1.96 *
    outcome_boys_a_ga_sem
  girls_estimate <- outcome_girls_a_ga_estimate
  girls_lower_ci <- outcome_girls_a_ga_estimate - 1.96 *
    outcome_girls_a_ga_sem
  girls_upper_ci <- outcome_girls_a_ga_estimate + 1.96 *
    outcome_girls_a_ga_sem
  }
  if (independent_variable == "mat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  girls_estimate <- outcome_girls_a_mat_ht_estimate
  girls_lower_ci <- outcome_girls_a_mat_ht_estimate - 1.96 *
    outcome_girls_a_mat_ht_sem
  girls_upper_ci <- outcome_girls_a_mat_ht_estimate + 1.96 *
    outcome_girls_a_mat_ht_sem
  boys_estimate <- outcome_boys_a_mat_ht_estimate
  boys_lower_ci <- outcome_boys_a_mat_ht_estimate - 1.96 *
    outcome_boys_a_mat_ht_sem
  boys_upper_ci <- outcome_boys_a_mat_ht_estimate + 1.96 *
    outcome_boys_a_mat_ht_sem
  }
  if (independent_variable == "pat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-1,1))
  boys_estimate <- outcome_boys_a_pat_ht_estimate
  boys_lower_ci <- outcome_boys_a_pat_ht_estimate - 1.96 *
    outcome_boys_a_pat_ht_sem
  boys_upper_ci <- outcome_boys_a_pat_ht_estimate + 1.96 *
    outcome_boys_a_pat_ht_sem
  girls_estimate <- outcome_girls_a_pat_ht_estimate
  girls_lower_ci <- outcome_girls_a_pat_ht_estimate - 1.96 *
    outcome_girls_a_pat_ht_sem
  girls_upper_ci <- outcome_girls_a_pat_ht_estimate + 1.96 *
    outcome_girls_a_pat_ht_sem
  }
}
  
if (dependent_variable == "b"){

  
    #set the x axis limits based on which independent variable we have
  if (independent_variable == "STEROIDSyes"){
  x_limits <-   coord_cartesian(xlim = c(-0.1,0.1))
  boys_estimate <- outcome_boys_b_steroid_estimate
  boys_lower_ci <- outcome_boys_b_steroid_estimate - 1.96 *
    outcome_boys_b_steroid_sem
  boys_upper_ci <- outcome_boys_b_steroid_estimate + 1.96 *
    outcome_boys_b_steroid_sem
  girls_estimate <- outcome_girls_b_steroid_estimate
  girls_lower_ci <- outcome_girls_b_steroid_estimate - 1.96 *
    outcome_girls_b_steroid_sem
  girls_upper_ci <- outcome_girls_b_steroid_estimate + 1.96 *
    outcome_girls_b_steroid_sem
  }
  if (independent_variable == "ga"){
  x_limits <-   coord_cartesian(xlim = c(-0.01,0.01))
  girls_estimate <- outcome_girls_b_ga_estimate
  girls_lower_ci <- outcome_boys_b_ga_estimate - 1.96 *
    outcome_girls_b_ga_sem
  girls_upper_ci <- outcome_girls_b_ga_estimate + 1.96 *
    outcome_girls_b_ga_sem
  boys_estimate <- outcome_boys_b_ga_estimate
  boys_lower_ci <- outcome_boys_b_ga_estimate - 1.96 *
    outcome_boys_b_ga_sem
  boys_upper_ci <- outcome_boys_b_ga_estimate + 1.96 *
    outcome_boys_b_ga_sem
  }
  if (independent_variable == "mat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.01,0.01))
  boys_estimate <- outcome_boys_b_mat_ht_estimate
  boys_lower_ci <- outcome_boys_b_mat_ht_estimate - 1.96 *
    outcome_boys_b_mat_ht_sem
  boys_upper_ci <- outcome_boys_b_mat_ht_estimate + 1.96 *
    outcome_boys_b_mat_ht_sem
  girls_estimate <- outcome_girls_b_mat_ht_estimate
  girls_lower_ci <- outcome_girls_b_mat_ht_estimate - 1.96 *
    outcome_girls_b_mat_ht_sem
  girls_upper_ci <- outcome_girls_b_mat_ht_estimate + 1.96 *
    outcome_girls_b_mat_ht_sem
  }
  if (independent_variable == "pat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.01,0.01))
  girls_estimate <- outcome_girls_b_pat_ht_estimate
  girls_lower_ci <- outcome_girls_b_pat_ht_estimate - 1.96 *
    outcome_girls_b_pat_ht_sem
  girls_upper_ci <- outcome_girls_b_pat_ht_estimate + 1.96 *
    outcome_girls_b_pat_ht_sem
  boys_estimate <- outcome_boys_b_pat_ht_estimate
  boys_lower_ci <- outcome_boys_b_pat_ht_estimate - 1.96 *
    outcome_boys_b_pat_ht_sem
  boys_upper_ci <- outcome_boys_b_pat_ht_estimate + 1.96 *
    outcome_boys_b_pat_ht_sem
  }
}
  
if (dependent_variable == "c"){
  girls_coefficient_frame <- (extract_coefficient_frame(girls_optimum_prediction_model_c))
  boys_coefficient_frame <- (extract_coefficient_frame(boys_optimum_prediction_model_c))
  
    #set the x axis limits based on which independent variable we have
  if (independent_variable == "STEROIDSyes"){
  x_limits <-   coord_cartesian(xlim = c(-0.1,0.1))
  boys_estimate <- outcome_boys_c_steroid_estimate
  boys_lower_ci <- outcome_boys_c_steroid_estimate - 1.96 *
    outcome_boys_c_steroid_sem
  boys_upper_ci <- outcome_boys_c_steroid_estimate + 1.96 *
    outcome_boys_c_steroid_sem
  girls_estimate <- outcome_girls_c_steroid_estimate
  girls_lower_ci <- outcome_girls_c_steroid_estimate - 1.96 *
    outcome_girls_c_steroid_sem
  girls_upper_ci <- outcome_girls_c_steroid_estimate + 1.96 *
    outcome_girls_c_steroid_sem
  }
  if (independent_variable == "ga"){
  x_limits <-   coord_cartesian(xlim = c(-0.005,0.005))
  girls_estimate <- outcome_girls_c_ga_estimate
  girls_lower_ci <- outcome_girls_c_ga_estimate - 1.96 *
    outcome_girls_c_ga_sem
  girls_upper_ci <- outcome_girls_c_ga_estimate + 1.96 *
    outcome_girls_c_ga_sem
  boys_estimate <- outcome_boys_c_ga_estimate
  boys_lower_ci <- outcome_boys_c_ga_estimate - 1.96 *
    outcome_boys_c_ga_sem
  boys_upper_ci <- outcome_boys_c_ga_estimate + 1.96 *
    outcome_boys_c_ga_sem
  }
  if (independent_variable == "mat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.01,0.01))
  boys_estimate <- outcome_boys_c_mat_ht_estimate
  boys_lower_ci <- outcome_boys_c_mat_ht_estimate - 1.96 *
    outcome_boys_c_mat_ht_sem
  boys_upper_ci <- outcome_boys_c_mat_ht_estimate + 1.96 *
    outcome_boys_c_mat_ht_sem
  girls_estimate <- outcome_girls_c_mat_ht_estimate
  girls_lower_ci <- outcome_girls_c_mat_ht_estimate - 1.96 *
    outcome_girls_c_mat_ht_sem
  girls_upper_ci <- outcome_girls_c_mat_ht_estimate + 1.96 *
    outcome_girls_c_mat_ht_sem
  }
  if (independent_variable == "pat_ht"){
  x_limits <-   coord_cartesian(xlim = c(-0.01,0.01))
  girls_estimate <- outcome_girls_c_pat_ht_estimate
  girls_lower_ci <- outcome_girls_c_pat_ht_estimate - 1.96 *
    outcome_girls_c_pat_ht_sem
  girls_upper_ci <- outcome_girls_c_pat_ht_estimate + 1.96 *
    outcome_girls_c_pat_ht_sem
  boys_estimate <- outcome_boys_c_pat_ht_estimate
  boys_lower_ci <- outcome_boys_c_pat_ht_estimate - 1.96 *
    outcome_boys_c_pat_ht_sem
  boys_upper_ci <- outcome_boys_c_pat_ht_estimate + 1.96 *
    outcome_boys_c_pat_ht_sem
  }
}
  
#set colours and other parameters
girls_colour <- "darkred"
boys_colour <- "darkblue"
geom_vline_linewidth <- 1
geom_hline_linewidth <- 0.2
geom_error_line_width <- 2
geom_point_size <- 12
x_axis_offset <- 0.2



  # Create a ggplot for the current term
imputed_coefficient_sex_comparison_plot <- 
    ggplot() +
    geom_vline(xintercept=0, 
               linewidth=geom_vline_linewidth, 
               colour="black") +
    geom_hline(yintercept=0, 
               linewidth=geom_hline_linewidth, 
               colour="black") +
  
    geom_point(
        aes(
        x=boys_estimate,
        y=x_axis_offset
      ),
      size = geom_point_size,
      colour=boys_colour) +
    geom_errorbarh(
        aes(
        xmin = boys_lower_ci, 
        xmax = boys_upper_ci,
        y=x_axis_offset),
      linewidth=geom_error_line_width,
      height = 0.2,
      colour=boys_colour
    ) +
  
    geom_point(
      aes(
        x=girls_estimate,
        y=-x_axis_offset
      ),
      size = geom_point_size,
      colour=girls_colour) +
    geom_errorbarh(
      aes(
        xmin = girls_lower_ci, 
        xmax = girls_upper_ci,
        y=-x_axis_offset),
      linewidth=geom_error_line_width,
      height = 0.2,
      colour=girls_colour
    ) +
  
    theme_minimal() +
  theme(
    plot.background=element_rect(fill="white", colour=NA)) 
  
  dir.create("imputed_coefficient_sex_comparison_plots", showWarnings = F)
  dir.create(paste0("imputed_coefficient_sex_comparison_plots/IV_", independent_variable), showWarnings = F)
  
    ggsave(filename = 
           paste0("DV_", dependent_variable,
                  ".tif"),
         path = paste0("imputed_coefficient_sex_comparison_plots/IV_", independent_variable),
         plot = imputed_coefficient_sex_comparison_plot,
         device = "tiff",
         width = 10,
         height = 2,
         compression = "lzw",
         limitsize = FALSE)
  
#limit the x axis separately
limited_imputed_coefficient_sex_comparison_plot <-
  imputed_coefficient_sex_comparison_plot +
  x_limits +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.text.y = element_blank(),
    axis.text.x = element_text(vjust = 0.5),
    axis.title=element_blank())

    ggsave(filename = 
           paste0("limited_DV_", dependent_variable,
                  ".tif"),
         path = paste0("imputed_coefficient_sex_comparison_plots/IV_", independent_variable),
         plot = limited_imputed_coefficient_sex_comparison_plot,
         device = "tiff",
         width = 10,
         height = 2,
         compression = "lzw",
         limitsize = FALSE)
    
list_of_limited_imputed_coefficient_sex_comparison_plot[[length(
  list_of_limited_imputed_coefficient_sex_comparison_plot) + 
    1]] <- limited_imputed_coefficient_sex_comparison_plot    
    #end the loop for independent variables
}
    #end the loop of dependent variables
}
    
```



```{r, part a dynamic loop that plots line plots of coefficients of prediction models for each separate data set note the outcomes that you want to plot separately because of scaling}


# Function to extract coefficients and confidence intervals
extract_coefs <- function(model, model_name = "Model") {
  tidy_model <- broom::tidy(model) %>%
    mutate(
      lower_ci = estimate - 1.96 * std.error,
      upper_ci = estimate + 1.96 * std.error,
      model = model_name
    )
  return(tidy_model)
}

# Create a list of individual plots for each data set and coefficient
list_of_coefficient_plots_part_a <- list()

for (data_and_degrees_to_plot in c(
  "girls_all_degrees_12",
  "girls_all_preterm_degrees_10",
  "boys_all_degrees_15",
  "boys_all_preterm_degrees_15")){

  #final height, a, and final sitar height should be on similar axes
  #other outcomes should be plotted separately
name_of_model_1 <-
  "final_height_on_ga_mat_ht_pat_ht_STEROIDS"
name_of_model_2 <-
  "a_on_ga_mat_ht_pat_ht_STEROIDS"
name_of_model_3 <-
  "final_SITAR_height_on_ga_mat_ht_pat_ht_STEROIDS"

# List of model names stored as variables
model_names <- 
  c(name_of_model_1, 
    name_of_model_2, 
    name_of_model_3)

# Initialize an empty list
models_part_a <- list()

# Loop over the model names and dynamically add them to the list
for (i in seq_along(model_names)) {
  models_part_a[[model_names[i]]] <- list_of_list_of_prediction_model_fits[[data_and_degrees_to_plot]][[model_names[i]]]
}

#extract the number from each model
model_obs_count_part_a <- 
  sapply(models_part_a, function(model) length(model$fitted.values))

# Extract R² values for each model
model_r2_part_a <- 
  sapply(models_part_a, function(model) round(summary(model)$r.squared, digits=2))

# Extract and combine data for all models
coef_data_part_a <- purrr::map_df(names(models_part_a), function(model_name) {
  extract_coefs(models_part_a[[model_name]], model_name)
})

# Explicitly set the order of factor levels based on model_names

#BEWARE THIS - THE CODE BELOW DOESNT MAP YOUR LABELS PROPERLY IF YOU DO THIS ALONE
#coef_data_part_a$model <- 
#  factor(coef_data_part_a$model, levels = rev(model_names))
#BEWARE THIS - THE CODE BELOW DOESNT MAP YOUR LABELS PROPERLY IF YOU DO THIS ALONE


# Get a list of unique coefficients (terms) to plot separately
unique_terms_part_a <- unique(coef_data_part_a$term)


for (term in unique_terms_part_a) {
  # Filter data for the current term
  term_data_part_a <- coef_data_part_a %>% filter(term == !!term)

  max_upper_ci <- max(term_data_part_a$upper_ci, na.rm=T)
  min_lower_ci <- min(term_data_part_a$lower_ci, na.rm=T)
  
  # Create a ggplot for the current term
  coefficient_plot_part_a <- ggplot(term_data_part_a, aes(y = model, x = estimate, color = model)) +
    geom_vline(xintercept=0, linewidth=1, colour="black") +
    geom_point(size = 3) +
    geom_errorbarh(
      aes(xmin = lower_ci, xmax = upper_ci),
      height = 0.2
    ) +
    labs(
      title = paste0(
        "Data and SITAR fit = ",
        data_and_degrees_to_plot,
        "; Coefficient of prediction model = ", term),
      y = "Model",
      x = "Coefficient Estimate"
    ) +
    theme_minimal() +
  theme(
    plot.background=element_rect(fill="white", colour=NA)) +
    # Add a label with the model number on the right side of each line
    geom_text(data=term_data_part_a,
      aes(x = max_upper_ci + 0.1, 
          label = paste0("n= ", model_obs_count_part_a[term_data_part_a$model])), 
              hjust = 0, vjust = 0.5, size = 3, color = "black") +
    # Add a label with the model number on the right side of each line
    geom_text(data=term_data_part_a,
              aes(x = min_lower_ci - 0.1, 
                  label = paste0("R²= ", model_r2_part_a[term_data_part_a$model])), 
              hjust = 0, vjust = 0.5, size = 3, color = "black")
  
  dir.create("coefficient_plots", showWarnings = F)
  dir.create(paste0("coefficient_plots/", data_and_degrees_to_plot), showWarnings = F)
  
    ggsave(filename = 
           paste0(term,
                  ".tif"),
         path = paste0("coefficient_plots/", data_and_degrees_to_plot),
         plot = coefficient_plot_part_a,
         device = "tiff",
         width = 20,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
  
  # Save the plot in the list
  list_of_coefficient_plots_part_a[[paste0(data_and_degrees_to_plot, "_", term)]] <- coefficient_plot_part_a
}

# Display all the plots
list_of_coefficient_plots_part_a

save(list_of_coefficient_plots_part_a,   
   file = paste0("list_of_coefficient_plots_part_b.Rdata"))

}


```


```{r, part b dynamic loop that plots line plots of coefficients of prediction models for each separate data set note the outcomes that you want to plot separately because of scaling}


# Function to extract coefficients and confidence intervals
extract_coefs <- function(model, model_name = "Model") {
  tidy_model <- broom::tidy(model) %>%
    mutate(
      lower_ci = estimate - 1.96 * std.error,
      upper_ci = estimate + 1.96 * std.error,
      model = model_name
    )
  return(tidy_model)
}

# Create a list of individual plots for each data set and coefficient
list_of_coefficient_plots_part_b <- list()

for (data_and_degrees_to_plot in c(
  "girls_all_degrees_12",
  "girls_all_preterm_degrees_10",
  "boys_all_degrees_15",
  "boys_all_preterm_degrees_15")){

name_of_model_1 <-
  "b_on_ga_mat_ht_pat_ht_STEROIDS"
name_of_model_2 <-
  "c_on_ga_mat_ht_pat_ht_STEROIDS"
name_of_model_3 <-
  "maximum_SITAR_growth_velocity_after_six_years_on_ga_mat_ht_pat_ht_STEROIDS"
name_of_model_4 <-
  "age_at_maximum_SITAR_growth_velocity_after_six_years_on_ga_mat_ht_pat_ht_STEROIDS"

# List of model names stored as variables
model_names <- 
  c(name_of_model_1, 
    name_of_model_2, 
    name_of_model_3, 
    name_of_model_4)

# Initialize an empty list
models_part_b <- list()

# Loop over the model names and dynamically add them to the list
for (i in seq_along(model_names)) {
  models_part_b[[model_names[i]]] <- list_of_list_of_prediction_model_fits[[data_and_degrees_to_plot]][[model_names[i]]]
}

#extract the number from each model
model_obs_count_part_b <- 
  sapply(models_part_b, function(model) length(model$fitted.values))

# Extract R² values for each model
model_r2_part_b <- sapply(models_part_b, function(model) round(summary(model)$r.squared, digits=2))

# Extract and combine data for all models
coef_data_part_b <- purrr::map_df(names(models_part_b), function(model_name) {
  extract_coefs(models_part_b[[model_name]], model_name)
})

#BEWARE THIS - THE CODE BELOW DOESNT MAP YOUR LABELS PROPERLY IF YOU DO THIS ALONE
#coef_data_part_b$model <- 
#  factor(coef_data_part_b$model, levels = rev(model_names))
#BEWARE THIS - THE CODE BELOW DOESNT MAP YOUR LABELS PROPERLY IF YOU DO THIS ALONE


# Get a list of unique coefficients (terms) to plot separately
unique_terms_part_b <- unique(coef_data_part_b$term)

for (term in unique_terms_part_b) {
  # Filter data for the current term
  term_data_part_b <- coef_data_part_b %>% filter(term == !!term)
  
  max_upper_ci <- max(term_data_part_b$upper_ci, na.rm=T)
  min_lower_ci <- min(term_data_part_b$lower_ci, na.rm=T)
  
  # Create a ggplot for the current term
  coefficient_plot_part_b <- ggplot(term_data_part_b, aes(y = model, x = estimate, color = model)) +
    geom_vline(xintercept=0, linewidth=1, colour="black") +
    geom_point(size = 3) +
    geom_errorbarh(
      aes(xmin = lower_ci, xmax = upper_ci),
      height = 0.2
    ) +
  #  coord_flip() +
    labs(
      title = paste0(
        "Data and SITAR fit = ",
        data_and_degrees_to_plot,
        "; Coefficient of prediction model = ", term),
      y = "Model",
      x = "Coefficient Estimate"
    ) +
    theme_minimal() +
  theme(
    plot.background=element_rect(fill="white", colour=NA)) +
    # Add a label with the model number on the right side of each line
    geom_text(data=term_data_part_b,
      aes(x = max_upper_ci + 0.1, label = paste0("n= ", model_obs_count_part_b[term_data_part_b$model])), 
              hjust = 0, vjust = 0.5, size = 3, color = "black") +
    # Add a label with the model number on the right side of each line
    geom_text(data=term_data_part_b,
              aes(x = min_lower_ci - 0.1, label = paste0("R²= ", model_r2_part_b[term_data_part_b$model])), 
              hjust = 0, vjust = 0.5, size = 3, color = "black")
  
  dir.create("coefficient_plots", showWarnings = F)
  dir.create(paste0("coefficient_plots/", data_and_degrees_to_plot), showWarnings = F)
  
    ggsave(filename = 
           paste0(term,
                  ".tif"),
         path = paste0("coefficient_plots/", data_and_degrees_to_plot),
         plot = coefficient_plot_part_b,
         device = "tiff",
         width = 20,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
  
  # Save the plot in the list
  list_of_coefficient_plots_part_b[[paste0(data_and_degrees_to_plot, "_", term)]] <- coefficient_plot_part_b
}

# Display all the plots
list_of_coefficient_plots_part_b

save(list_of_coefficient_plots_part_b,   
   file = paste0("list_of_coefficient_plots_part_b.Rdata"))
}
```


```{r, combine coefficient plots a and b within grid arrange to save them}
for (i in 1:length(list_of_coefficient_plots_part_a)){

data_and_degrees_to_plot <- sub("(.*\\d).*", "\\1", names(list_of_coefficient_plots_part_a[i]))
term <- sub(".*\\d_", "", names(list_of_coefficient_plots_part_a)[i])

# Create a list of individual plots for each data set and coefficient

grid_plot_part_a_and_b <-
  grid.arrange(
    list_of_coefficient_plots_part_a[[i]],
    list_of_coefficient_plots_part_b[[i]],
    ncol=1)

dir.create("coefficient_plots", showWarnings = F)
dir.create(paste0("coefficient_plots/", data_and_degrees_to_plot), showWarnings = F)


  ggsave(filename = 
           paste0(term,
                  ".tif"),
         path = paste0("coefficient_plots/", data_and_degrees_to_plot),
         plot = grid_plot_part_a_and_b,
         device = "tiff",
         width = 20,
         height = 10,
         compression = "lzw",
         limitsize = FALSE)

}


```



```{r, dynamic loop that plots calibration plots of prediction models for each separate data set}

for (data_and_degrees_to_plot in c(
  "girls_all_degrees_12",
  "girls_all_preterm_degrees_10",
  "boys_all_degrees_15",
  "boys_all_preterm_degrees_15")){

  #final height, a, and final sitar height should be on similar axes
  #other outcomes should be plotted separately
name_of_model_1 <-
  "final_height_on_ga_mat_ht_pat_ht_STEROIDS"
name_of_model_2 <-
  "a_on_ga_mat_ht_pat_ht_STEROIDS"
name_of_model_3 <-
  "final_SITAR_height_on_ga_mat_ht_pat_ht_STEROIDS"
name_of_model_4 <-
  "b_on_ga_mat_ht_pat_ht_STEROIDS"
name_of_model_5 <-
  "c_on_ga_mat_ht_pat_ht_STEROIDS"
name_of_model_6 <-
  "maximum_SITAR_growth_velocity_after_six_years_on_ga_mat_ht_pat_ht_STEROIDS"
name_of_model_7 <-
  "age_at_maximum_SITAR_growth_velocity_after_six_years_on_ga_mat_ht_pat_ht_STEROIDS"

# List of model names stored as variables
model_names <- 
  c(name_of_model_1, 
    name_of_model_2, 
    name_of_model_3, 
    name_of_model_4, 
    name_of_model_5, 
    name_of_model_6, 
    name_of_model_7)

# Initialize an empty list
models_for_calibration_plots <- list()

# Loop over the model names and dynamically add them to the list
for (i in seq_along(model_names)) {
  models_for_calibration_plots[[model_names[i]]] <- list_of_list_of_prediction_model_fits[[data_and_degrees_to_plot]][[model_names[i]]]
}

#extract the number from each model
model_obs_count <- 
  sapply(models_for_calibration_plots, function(model) length(model$fitted.values))

# Extract R² values for each model
model_r2 <- 
  sapply(models_for_calibration_plots, function(model) round(summary(model)$r.squared, digits=2))

for (number_of_model in 1:length(models_for_calibration_plots)){
  
#take out the model name from its name in the list
    model_name <- names(models_for_calibration_plots[number_of_model])
    
    outcome_variable <- gsub("_on_.*", "", model_name)
    
    each_model <- models_for_calibration_plots[[number_of_model]]
    
    point_colour <-
      "black"
    
    if (grepl(x=data_and_degrees_to_plot, pattern="girls")){
          point_colour <- "red"
    }
    if (grepl(x=data_and_degrees_to_plot, pattern="boys")){
          point_colour <- "blue"
    }
  # Create a data frame with observed and predicted values back extracted from the model
  calibration_data <- data.frame(
    observed = model.frame(each_model)[[1]],
    predicted = predict(each_model, type = "response")
  )
  
  #create a label position for r2
  y_label_position <-
    min(calibration_data$observed) + 
    4/5 *
    (max(calibration_data$observed) - min(calibration_data$observed))
  x_label_position <-
    min(calibration_data$predicted) + 
    1/10 *
    (max(calibration_data$predicted) - min(calibration_data$predicted))
  
  lower_lim <-
    min(calibration_data$predicted, calibration_data$observed)
  upper_lim <-
    max(calibration_data$predicted, calibration_data$observed)
  
   r2_text = model_r2[model_name]
   model_obs_text = model_obs_count[model_name]
  
  calibration_plot <- 
    ggplot(calibration_data, aes(x = predicted, y = observed)) +
    geom_point(alpha = 0.6, 
               size=1.5,
               colour=point_colour) +  # Scatter plot with transparency
    geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +  # Perfect calibration line
    labs(x = "Predicted Values", y = "Observed Values", 
         title = paste("Calibration Plot for Model: ", model_name),
         subtitle = data_and_degrees_to_plot) +
    geom_text(
    aes(
      x = x_label_position,
      y = y_label_position, 
      label = paste0(
        "n : ", model_obs_text, " \n",
        "R² : ", r2_text
    ))) +
    xlim(lower_lim, upper_lim) +
    ylim(lower_lim, upper_lim) +
    theme_minimal() +
    theme(
      plot.background=element_rect(fill="white", colour=NA),
      plot.title = element_text(hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5),
      panel.grid.minor = element_blank()
    )
#print(calibration_plot)
  
  #we also want to plot the model table
model_output <- 
  rownames_to_column(as.data.frame(round(summary(each_model)$coefficients, digits=2)), var="Coefficient")
  model_output$`t value` <- NULL
library(flextable)
library(officer)
  
    
  # Extract the name of the data frame used
  data_frame_name <- as.character(each_model$call$data)
  
  # Extract the number of observations
  number_in_model <- length(predict(each_model))
  
  #extract the R2 of the model
  r2_model <- round(summary(each_model)$r.squared, digits=3)

# Create a flextable from the frequency table
ft <- flextable(model_output)

# Customize the table appearance (optional)
ft <- ft %>%
  set_header_labels(
    P = "Pr(>|t|)"
  ) %>%
  theme_vanilla() %>%
  align(align = "center", part = "header") %>%
  autofit()

# Define paragraph formatting with centered alignment
centered_paragraph <- 
  fp_par(text.align = "center")
# Define font properties (e.g., larger font size)
font_properties <- fp_text(font.size = 14, bold = TRUE, color = "black")
# Save the table to a Word document
doc <- read_docx() %>%
  body_add_fpar(
    fpar(ftext(paste0("Outcome variable = ", outcome_variable), prop = font_properties), 
         fp_p = centered_paragraph)
  ) %>%
  body_add_flextable(ft) %>%
    body_add_fpar(
      fpar(
        ftext(paste0("Number of observations: ", number_in_model), 
              prop = font_properties),
        fp_p = centered_paragraph
      )
    ) %>%
    body_add_fpar(
      fpar(
        ftext(paste0("R² of model: ", r2_model), 
              prop = font_properties),
        fp_p = centered_paragraph
      )
    ) 

  
  dir.create("calibration_plots", showWarnings = F)
  dir.create(paste0("calibration_plots/", data_and_degrees_to_plot), showWarnings = F)
  
print(doc, 
      target = paste0("calibration_plots/", data_and_degrees_to_plot, "/", model_name, ".docx"))

    ggsave(filename = 
           paste0(model_name,
                  ".tif"),
         path = paste0("calibration_plots/", data_and_degrees_to_plot),
         plot = calibration_plot,
         device = "tiff",
         width = 8,
         height = 8,
         compression = "lzw",
         limitsize = FALSE)
  
}


}
```


```{r, reminder what those lists contain}
#list_of_data_frames_with_sitar_predictions[1]
cat("list_of_data_frames_with_sitar_predictions")
cat("contains the long frame with all original data and sitar model fit for each degree of freedom")
#list_of_sitar_model_fits[1]
cat("list_of_sitar_model_fits")
cat("contains the actual model fits showing model parameters")
#list_of_sitar_and_prediction_results[1]
cat("list_of_sitar_and_prediction_results")
cat("contains a list of single rows that have a summary of the fit of sitar and the summary of all of the permutations of the multivariable prediction models. These rows have been combined into the larger data frame sitar_and_prediction_results.csv")
#list_of_overall_fixed_effects_fit_data_frames[1]
cat("list_of_overall_fixed_effects_fit_data_frames")
cat("contains a list of the fixed effects fit of each model for each group and degree of freedom")
#list_of_all_patient_random_effects_fit_data_frames[1]
cat("list_of_all_patient_random_effects_fit_data_frames")
cat("contains a list of the random effects fit to new data for each patient to facilitate plotting smooth curves that go through to final height")
```

```{r}
sink("bic_results.txt")
cat("When you look through the BIC of each degrees of freedom having restricted the data to only those that have 3 or more height measurements, we see optimum fit for each group is: /n")
cat("All girls: 12 degrees of freedom /n")
cat("Preterm girls: 10 degrees of freedom /n")
cat("All boys: 15 degrees of freedom /n")
cat("Preterm boys: 15 degrees of freedom /n")
sink()
```


```{r, loop for violin plots of sitar random effect outcomes by groups including whether steroids}
for (each_frame in 1:length(list_of_data_frames_with_sitar_predictions)){
  
  name_of_frame <-
    names(list_of_data_frames_with_sitar_predictions[each_frame])
  #take out the complete frame from the list
  complete_frame <- 
    list_of_data_frames_with_sitar_predictions[[each_frame]]
  #make it one row per patient
  single_row_per_patient <-
    complete_frame %>%
    group_by(nw_id) %>%
    slice(1)
  
for (outcome_to_plot in c(
  "a",
  "b",
  "c",
  "final_SITAR_height",
  "maximum_SITAR_growth_velocity_after_six_years",
  "age_at_maximum_SITAR_growth_velocity_after_six_years")){
  
  group_to_plot <- "STEROIDS"
  
  #dynamically take the y_max so we can manipulate some labels and ensure they don't get cut off
  y_max <- 
    max(single_row_per_patient[[outcome_to_plot]], na.rm = T)
  
  #calculate stats by group
  
  stats_to_accompany_plot <- 
    single_row_per_patient %>%
    group_by(!!sym(group_to_plot)) %>%
    summarise(
      n_value = n(),
      mean_value = mean(!!sym(outcome_to_plot), na.rm = T),
      sd_value = sd(!!sym(outcome_to_plot), na.rm = T),
      median_value = mean(!!sym(outcome_to_plot), na.rm = T)
  )
  
  outcome_comparison_plot <- 
  ggplot(
    data=single_row_per_patient, 
    aes_string(
      x = group_to_plot, 
      y = outcome_to_plot, 
      fill = group_to_plot)) +
  geom_violin(
    linewidth = 0.5,
    alpha=0.3) +
  geom_jitter(
    size=1, 
    width=0.3,
    alpha=0.4) +
  stat_summary(
    fun = median,  # Specify the median function
    geom = "crossbar",  # Use crossbar to draw a horizontal line
    width = 0.5,  # Control the width of the line
    color = "black",  # Customize the line color
    linewidth = 0.25  # Customize the line thickness
  ) +
  stat_summary(
    fun.data = function(y) {
      data.frame(
        ymin = quantile(y, 0.25),  # 25th percentile
        ymax = quantile(y, 0.75),  # 75th percentile
        y = median(y)  # Needed for the geom used
      )
    },
    geom = "errorbar",  # Use error bars for vertical IQR lines
    width = 0.2,  # Width of the "error bar cap"
    color = "black",  # Customize the color of the IQR lines
    linewidth = 0.75  # Customize the line thickness
  ) +
  geom_text(
    data = stats_to_accompany_plot,
    aes(
      x = !!sym(group_to_plot),
      y = max(single_row_per_patient[[outcome_to_plot]], na.rm = T) + 
        0.1 * max(single_row_per_patient[[outcome_to_plot]], na.rm = T),  # Adjust to position above the plot
      label = paste0(
        "Mean: ", round(mean_value, 2), 
        "\nSD: ", round(sd_value, 2), 
        "\nn: ", n_value)
    ),
    inherit.aes = FALSE,  # Prevent ggplot from reapplying other mappings
    size = 3,
    hjust = 0.5,
    vjust = 0) +
  scale_y_continuous(
    limits = c(NA, y_max + 0.15 * max(single_row_per_patient[[outcome_to_plot]], na.rm = T)),  # Dynamically set the upper limit
    expand = expansion(mult = c(0, 0.1))  # Add extra space at the top
  ) +
  labs(title = name_of_frame,
       subtitle = "Lines are median with interquartile range") +
  theme_minimal() +
#  coord_cartesian(ylim=c(6,16)) +
  theme(
    plot.background=element_rect(fill="white", colour=NA)) 



dir.create("violin_comparison_plots")
dir.create(paste0("violin_comparison_plots/", name_of_frame))
# Save the plot as a TIFF file
  ggsave(filename = 
           paste0(group_to_plot, 
                  "_",
                  outcome_to_plot,
                  ".tif"),
         path = paste0("violin_comparison_plots/", name_of_frame),
         plot = outcome_comparison_plot,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)

#also save the stats to plot in a similar place
  write.csv(stats_to_accompany_plot, 
            paste0("violin_comparison_plots/", 
                   name_of_frame,
                   "/stats_to_accompany_",
                   group_to_plot, 
                   "_",
                   outcome_to_plot,
                   ".csv"))
  
}
}
```

```{r, loop for regression plots of sitar random effect outcomes against continuous variable covariates of interest including gestational age}
for (each_frame in 1:length(list_of_data_frames_with_sitar_predictions)){

  name_of_frame <-
    names(list_of_data_frames_with_sitar_predictions[each_frame])
  print(paste0("Rendering ", name_of_frame))
  #take out the complete frame from the list
  complete_frame <- 
    list_of_data_frames_with_sitar_predictions[[each_frame]]
  #make it one row per patient
  single_row_per_patient <-
    complete_frame %>%
    group_by(nw_id) %>%
    slice(1)
  
for (outcome_to_plot in c(
  "a",
  "b",
  "c",
  "final_SITAR_height",
  "maximum_SITAR_growth_velocity_after_six_years",
  "age_at_maximum_SITAR_growth_velocity_after_six_years")){
  
  y_label <- outcome_to_plot
  #can change the y_label here with if statements
  if (outcome_to_plot=="a"){
    y_label <- "SITAR random effect 'a' (Size)"
  }
  if (outcome_to_plot=="b"){
    y_label <- "SITAR random effect 'b' (Tempo)"
  }
  if (outcome_to_plot=="c"){
    y_label <- "SITAR random effect 'c' (Velocity)"
  }
  if (outcome_to_plot=="final_SITAR_height"){
    y_label <- "SITAR predicted height at 18.5 years"
  }
  if (outcome_to_plot=="maximum_SITAR_growth_velocity_after_six_years"){
    y_label <- "SITAR peak pubertal growth velocity"
  }
  if (outcome_to_plot=="age_at_maximum_SITAR_growth_velocity_after_six_years"){
    y_label <- "SITAR age at peak pubertal growth velocity"
  }

  
for (covariate_to_plot in c( 
    "ga",
    "mat_ht",
    "pat_ht")){

  x_label <-
    covariate_to_plot
  
  #can change the x label here with if statements
  if (covariate_to_plot=="ga"){
    x_label <- "Gestational age at delivery (weeks)"
  }
  if (covariate_to_plot=="mat_ht"){
    x_label <- "Maternal height (cm)"
  }
  if (covariate_to_plot=="pat_ht"){
    x_label <- "Paternal height (cm)"
  }
  
  group_to_colour <- 
    "STEROIDS"

library(broom)
library(purrr)

# Fit linear models and extract statistics
regression_stats <- single_row_per_patient %>%
  group_by(!!sym(group_to_colour)) %>%
  summarise(
    lm_model = list(lm(!!sym(outcome_to_plot) ~ !!sym(covariate_to_plot), data = cur_data())),
    n = n(),
    .groups = "drop"
  ) %>%
  mutate(
    tidied_model = map(lm_model, broom::tidy),
    r_squared = map_dbl(lm_model, ~summary(.x)$r.squared),
    intercept = map_dbl(lm_model, ~coef(.x)[1]) # Extract intercept here
  ) %>%
  unnest(tidied_model) %>%
  filter(term == covariate_to_plot) %>%
  select(
    !!sym(group_to_colour),
    n,
    slope = estimate,
    intercept,
    p_value = p.value,
    r_squared
  )
  
  #dynamically take the y_max so we can manipulate some labels and ensure they don't get cut off
  y_max <- 
    max(single_row_per_patient[[outcome_to_plot]], na.rm = T)
  
  #calculate stats of linear model by group
  
  stats_to_accompany_plot <- 
    single_row_per_patient %>%
    group_by(!!sym(group_to_plot)) %>%
    summarise(
      n_value = n(),
      mean_value = mean(!!sym(outcome_to_plot), na.rm = T),
      sd_value = sd(!!sym(outcome_to_plot), na.rm = T),
      median_value = mean(!!sym(outcome_to_plot), na.rm = T)
  )
  
  outcome_regression_plot <- 
  ggplot(
    data=single_row_per_patient, 
    aes_string(
      x = covariate_to_plot, 
      y = outcome_to_plot, 
      colour = group_to_colour)) +
  labs(title = name_of_frame,
       subtitle = "Linear model statistics reported within each group",
       y=y_label,
       x=x_label) +
#  scale_fill_manual(
#    values = c(
#      "yes" = "green4", 
#      "no" = "orange3")) +# Use distinct colors for all groups
      # Adding the regression statistics labels 1/3 of the way along the x-axis
geom_text(
  aes(
    x = 0 * 
        (max(single_row_per_patient[[covariate_to_plot]], na.rm=T) - 
           min(single_row_per_patient[[covariate_to_plot]], na.rm=T)) + 
        min(single_row_per_patient[[covariate_to_plot]], na.rm=T),
    y = y_max,  # Position the text at the top of the plot
    label = paste0(
      "Group: ", regression_stats[1,1], "\n", 
      "n: ", regression_stats[1,2], "\n",
      "Slope: ", round(regression_stats[1,3], 2), "\n", 
      "Intercept: ", round(regression_stats[1,4], 2), "\n", 
      "p: ", round(regression_stats[1,5], 2), "\n", 
      "R²: ", round(regression_stats[1,6], 2)),
  ),
  inherit.aes = FALSE,  # Prevent interference with the main plot aesthetics
  hjust = 0,  # Align the text to the left
  vjust = 1  # Adjust the vertical placement of the text
) +
geom_text(
  aes(
    x = 1/3 * 
        (max(single_row_per_patient[[covariate_to_plot]], na.rm=T) - 
           min(single_row_per_patient[[covariate_to_plot]], na.rm=T)) + 
        min(single_row_per_patient[[covariate_to_plot]], na.rm=T),
    y = y_max,  # Position the text at the top of the plot
    label = paste0(
      "Group: ", regression_stats[2,1], "\n", 
      "n: ", regression_stats[2,2], "\n",
      "Slope: ", round(regression_stats[2,3], 2), "\n", 
      "Intercept: ", round(regression_stats[2,4], 2), "\n", 
      "p: ", round(regression_stats[2,5], 2), "\n", 
      "R²: ", round(regression_stats[2,6], 2)),
  ),
  inherit.aes = FALSE,  # Prevent interference with the main plot aesthetics
  hjust = 0,  # Align the text to the left
  vjust = 1  # Adjust the vertical placement of the text
) +
geom_text(
  aes(
    x = 2/3 * 
        (max(single_row_per_patient[[covariate_to_plot]], na.rm=T) - 
           min(single_row_per_patient[[covariate_to_plot]], na.rm=T)) + 
        min(single_row_per_patient[[covariate_to_plot]], na.rm=T),
    y = y_max,  # Position the text at the top of the plot
    label = paste0(
      "Group: ", regression_stats[3,1], "\n", 
      "n: ", regression_stats[3,2], "\n",
      "Slope: ", round(regression_stats[3,3], 2), "\n", 
      "Intercept: ", round(regression_stats[3,4], 2), "\n", 
      "p: ", round(regression_stats[3,5], 2), "\n", 
      "R²: ", round(regression_stats[3,6], 2)),
  ),
  inherit.aes = FALSE,  # Prevent interference with the main plot aesthetics
  hjust = 0,  # Align the text to the left
  vjust = 1  # Adjust the vertical placement of the text
) +
  geom_point(
    size=1, 
    alpha=0.4) +
  geom_smooth(
    se=F,
    method="lm") +
  theme_minimal() +
  theme(
    plot.background=element_rect(fill="white", colour=NA)) 

outcome_regression_plot


dir.create("regression_comparison_plots")
dir.create(paste0("regression_comparison_plots/", name_of_frame))
# Save the plot as a TIFF file
  ggsave(filename = 
           paste0(covariate_to_plot, 
                  "_",
                  outcome_to_plot,
                  ".tif"),
         path = paste0("regression_comparison_plots/", name_of_frame),
         plot = outcome_regression_plot,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
  
    write.csv(regression_stats, 
            paste0("regression_comparison_plots/", 
                   name_of_frame,
                   "/regression_stats_",
                   covariate_to_plot, 
                   "_",
                   outcome_to_plot,
                   ".csv",
                   row.names=F))
    
#    install.packages("gt")
#     install.packages("webshot2")
#     webshot2::install_phantomjs()  # Required for saving tables as images
#    library(gt)
#FOR THIS CODE TO WORK YOU WILL NEED TO UPDATE RLANG
# Format the regression_stats table
#regression_table <- regression_stats %>%
#  mutate(across(where(is.numeric), ~ round(.x, 2))) %>% # Round numeric values to 2 decimals
#  gt() %>%
#  tab_header(
#    title = "Regression Statistics",
#    subtitle = "Slope, Intercept, P-Value, and R-Squared by Group"
#  ) %>%
#  cols_label(
#    !!sym(group_to_colour) := "Group",
#    slope = "Slope",
#    intercept = "Intercept",
#    p_value = "P-Value",
#    r_squared = "R-Squared"
#  ) %>%
#  fmt_number(
#    columns = where(is.numeric),
#    decimals = 2
#  ) %>%
#  tab_style(
#    style = list(cell_text(align = "center")),
#    locations = cells_body(columns = everything())
#  )

# Save the table as an image
#gtsave(regression_table, "regression_stats_table.png")

}
}
}
```

```{r, plot the height of fixed and random effects fits}
for (number_in_list in 1:length(list_of_overall_fixed_effects_fit_data_frames)){

#extract what we want to plot from the data
name_of_data <- names(list_of_data_frames_with_sitar_predictions)[number_in_list]
data_to_plot <- (list_of_data_frames_with_sitar_predictions[[number_in_list]])
fixed_effects_to_plot <- (list_of_overall_fixed_effects_fit_data_frames[[number_in_list]])
random_effects_to_plot <- (list_of_all_patient_random_effects_fit_data_frames[[number_in_list]])
data_frame_of_fit <- list_of_sitar_and_prediction_results[[number_in_list]]

sex <- "unknown"
colour_of_fixed_effects <- 
  "black"
colour_of_random_effects <- 
  "black"

if(grepl(x=name_of_data, pattern="boys")){
  sex <- "Male"
  colour_of_fixed_effects <- 
    "blue"
  colour_of_random_effects_no_steroids <- 
    "black"
  colour_of_random_effects_steroids <- 
    "green4"
}

if(grepl(x=name_of_data, pattern="girls")){
  sex <- "Female"
  colour_of_fixed_effects <- 
    "red"
  colour_of_random_effects_no_steroids <- 
    "black"
  colour_of_random_effects_steroids <- 
    "green4"
}

number_of_patients <-
  length(unique(random_effects_to_plot$nw_id))

plot_fixed_and_random_sitar_effect_fits <-
  ggplot() +
#plot random effects
  geom_line(
    data=random_effects_to_plot,
    aes(x=corrected_x_variable_years, 
        y=y_variable, 
        colour=STEROIDS,
        group=nw_id), 
    linewidth=0.2, 
    alpha=0.5) +
#plot fixed effects
  geom_line(
    data=fixed_effects_to_plot,
    aes(x=corrected_x_variable_years, 
        y=y_variable), 
    linewidth=2, 
    linetype="longdash",
    colour=colour_of_fixed_effects,
    alpha=0.5) +
  labs(
    title = name_of_data,
    subtitle= 
      paste0("Number of patients = ", number_of_patients),
    y="Height (cm)",
    x="Age (years)") +
  scale_color_manual(
    values = c(
      "yes" = colour_of_random_effects_steroids , 
      "no" = colour_of_random_effects_no_steroids)) +# Use distinct colors for all groups
  theme_minimal() + 
  coord_cartesian(ylim=c(0,200)) +
  theme(
    plot.background=element_rect(fill="white", colour=NA)
  )

plot_fixed_and_random_sitar_effect_fits

dir.create("plot_fixed_and_random_sitar_effect_fits", showWarnings = F)
# Save the plot as a TIFF file
  ggsave(filename = 
           paste0("SITAR_fit_", 
                  name_of_data,
                  ".tif"),
         path = "plot_fixed_and_random_sitar_effect_fits",
         plot = plot_fixed_and_random_sitar_effect_fits,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
#end the loop
  }
```

```{r, plot the height velocity of fixed and random effects fits}
for (number_in_list in 1:length(list_of_overall_fixed_effects_fit_data_frames)){

#extract what we want to plot from the data
name_of_data <- 
  names(list_of_data_frames_with_sitar_predictions)[number_in_list]
data_to_plot <- 
  (list_of_data_frames_with_sitar_predictions[[number_in_list]])
fixed_effects_to_plot <- 
  (list_of_overall_fixed_effects_fit_data_frames[[number_in_list]])
random_effects_to_plot <- 
  (list_of_all_patient_random_effects_fit_data_frames[[number_in_list]])
data_frame_of_fit <- 
  list_of_sitar_and_prediction_results[[number_in_list]]

number_of_patients <-
  length(unique(random_effects_to_plot$nw_id))

sex <- "unknown"
colour_of_fixed_effects <- 
  "black"
colour_of_random_effects <- 
  "black"

if(grepl(x=name_of_data, pattern="boys")){
  sex <- "Male"
  colour_of_fixed_effects <- 
    "blue"
  colour_of_random_effects_no_steroids <- 
    "black"
  colour_of_random_effects_steroids <- 
    "green4"
}

if(grepl(x=name_of_data, pattern="girls")){
  sex <- "Female"
  colour_of_fixed_effects <- 
    "red"
  colour_of_random_effects_no_steroids <- 
    "black"
  colour_of_random_effects_steroids <- 
    "green4"
}

plot_fixed_and_random_sitar_effect_velocities <-
  ggplot() +
#plot random effects
  geom_line(
    data=random_effects_to_plot,
    aes(
      x=corrected_x_variable_years, 
      y=growth_velocity_to_next_reading, 
      group=nw_id,
      colour=STEROIDS), 
    linewidth=0.1, 
    alpha=0.1) +
#plot fixed effects
  geom_line(
    data=fixed_effects_to_plot,
    aes(
      x=corrected_x_variable_years, 
      y=growth_velocity_to_next_reading), 
    linewidth=1, 
    linetype="longdash",
    colour=colour_of_fixed_effects,
    alpha=0.5) +
  scale_color_manual(
    values = c(
      "yes" = colour_of_random_effects_steroids , 
      "no" = colour_of_random_effects_no_steroids)) +# Use distinct colors for all groups
  labs(
    title = name_of_data,
    subtitle= 
      paste0("Number of patients = ", number_of_patients),
    y="Height velocity (cm/year)",
    x="Age (years)") +
  theme_minimal() + 
  coord_cartesian(ylim=c(-10,80)) +
  theme(
    plot.background=element_rect(fill="white", colour=NA)
  )

plot_fixed_and_random_sitar_effect_velocities

dir.create("plot_fixed_and_random_sitar_effect_velocities" , showWarnings = F)
# Save the plot as a TIFF file
  ggsave(filename = 
           paste0("SITAR_velocities_", 
                  name_of_data,
                  ".tif"),
         path = "plot_fixed_and_random_sitar_effect_velocities",
         plot = plot_fixed_and_random_sitar_effect_velocities,
         device = "tiff",
         width = 10,
         height = 5,
         compression = "lzw",
         limitsize = FALSE)
#end the loop
}

```
